<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlanfAi - Revenue Analysis</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link href="/common/common.css" rel="stylesheet">
    
    <!-- CDN Dependencies -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="/common/common.js"></script>
</head>
<body>

<div id="app" class="container">
    <div class="glass-container">
        <header class="d-flex justify-content-between align-items-center mb-5">
            <div>
                <h1 class="display-5 mb-0" style="background: linear-gradient(to right, #6366f1, #ec4899); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent;">PlanfAi</h1>
                <p class="text-muted lead">Smart Revenue Analysis for Small Business</p>
            </div>
            <div class="text-end">
                <span class="badge bg-light text-dark shadow-sm p-2 rounded-pill">
                    <i class="me-1">ðŸ“…</i> {{ currentDate }}
                </span>
            </div>
        </header>

        <ul class="nav nav-pills mb-4" id="pills-tab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active rounded-pill px-4 me-2" :class="{ 'bg-primary text-white': currentTab === 'analysis' }" @click="currentTab = 'analysis'">
                    Analysis
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link rounded-pill px-4" :class="{ 'bg-primary text-white': currentTab === 'reports' }" @click="loadReports(); currentTab = 'reports'">
                    Saved Reports
                </button>
            </li>
        </ul>

        <div v-if="currentTab === 'analysis'" class="fade-in">

            <div class="text-center">
                <div class="mode-switch">
                    <button :class="{ active: analysisMode === 'simple' }" @click="analysisMode = 'simple'">Simple Mode</button>
                    <button :class="{ active: analysisMode === 'expert' }" @click="analysisMode = 'expert'">Expert Mode</button>
                </div>
            </div>

            <div class="row g-4">
                <!-- Data Input Section -->
                <div class="col-lg-4">
                    <div class="card border-0 shadow-sm h-100" style="border-radius: 16px;">
                        <div class="card-body p-4">
                            <h4 class="card-title mb-4 text-primary">Input Data</h4>
                            
                            <div class="mb-3">
                                <label class="form-label text-muted small fw-bold">User Email (ID)</label>
                                <input type="text" class="form-control" v-model="form.userId" placeholder="Enter your Email">
                            </div>

                            <hr class="my-4" style="opacity: 0.1">

                            <div class="mb-3">
                                <label class="form-label text-muted small fw-bold">Total Revenue</label>
                                <div class="input-group">
                                    <span class="input-group-text border-0 bg-light">â‚©</span>
                                    <input type="number" class="form-control" v-model.number="form.revenue" placeholder="0">
                                </div>
                            </div>

                            <!-- Inputs common for both, but maybe highlighted differently in expert -->
                            <div class="mb-3">
                                <label class="form-label text-muted small fw-bold">Fixed Costs</label>
                                <div class="input-group">
                                    <span class="input-group-text border-0 bg-light">â‚©</span>
                                    <input type="number" class="form-control" v-model.number="form.fixedCost" placeholder="0">
                                </div>
                                <div class="form-text">Rent, Salaries, etc.</div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label text-muted small fw-bold">Variable Costs</label>
                                <div class="input-group">
                                    <span class="input-group-text border-0 bg-light">â‚©</span>
                                    <input type="number" class="form-control" v-model.number="form.variableCost" placeholder="0">
                                </div>
                                <div class="form-text">Materials, etc.</div>
                            </div>

                             <button class="btn btn-premium w-100 mt-4" @click="saveReport" :disabled="!isFormValid || isSaving">
                                <span v-if="isSaving" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                {{ isSaving ? 'Saving...' : 'Save Report' }}
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Live Preview Section -->
                <div class="col-lg-8">
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <div class="stat-card text-center">
                                <h6 class="text-muted text-uppercase small mb-2">Revenue</h6>
                                <h3 class="text-primary mb-0">{{ formatCurrency(form.revenue) }}</h3>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stat-card text-center">
                                <h6 class="text-muted text-uppercase small mb-2">Total Costs</h6>
                                <h3 class="text-danger mb-0">{{ formatCurrency(totalCosts) }}</h3>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stat-card text-center" :style="{ background: netProfit >= 0 ? 'linear-gradient(135deg, #d1fae5 0%, #10b981 100%)' : 'linear-gradient(135deg, #fee2e2 0%, #ef4444 100%)', color: netProfit >= 0 ? '#064e3b' : '#7f1d1d' }">
                                <h6 class="text-uppercase small mb-2" style="opacity: 0.8">Net Profit</h6>
                                <h3 class="fw-bold mb-0">{{ formatCurrency(netProfit) }}</h3>
                            </div>
                        </div>
                    </div>

                    <!-- Expert Mode BEP Card -->
                    <div v-if="analysisMode === 'expert'" class="card border-0 shadow-sm mb-4" style="border-radius: 16px; background: linear-gradient(135deg, #fefadd 0%, #fff9c4 100%);">
                        <div class="card-body p-4 d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-1 text-warning-emphasis fw-bold">Break-Even Point (BEP)</h5>
                                <p class="mb-0 small text-muted">Revenue needed to cover all costs</p>
                            </div>
                            <div class="text-end">
                                <h3 class="mb-0 text-warning-emphasis">{{ formatCurrency(bep) }}</h3>
                                <small class="text-muted" v-if="form.revenue > 0">
                                    Current achievement: <strong>{{ Math.min(100, Math.round(form.revenue / bep * 100)) || 0 }}%</strong>
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="card border-0 shadow-sm" style="border-radius: 16px; overflow: hidden;">
                        <div class="card-header bg-white border-bottom p-4">
                            <h5 class="mb-0">Profit Breakdown</h5>
                        </div>
                        <div class="card-body p-4 text-center" v-if="form.revenue > 0">
                            <!-- Simple Visual Bar -->
                            <div class="progress" style="height: 40px; border-radius: 20px;">
                                <div class="progress-bar bg-danger" role="progressbar" :style="{ width: fixedCostPercentage + '%' }" title="Fixed Cost">
                                    <span v-if="fixedCostPercentage > 10">{{ fixedCostPercentage }}%</span>
                                </div>
                                <div class="progress-bar bg-warning" role="progressbar" :style="{ width: variableCostPercentage + '%' }" title="Variable Cost">
                                    <span v-if="variableCostPercentage > 10">{{ variableCostPercentage }}%</span>
                                </div>
                                <div class="progress-bar bg-success" role="progressbar" :style="{ width: profitPercentage + '%' }" title="Profit">
                                    <span v-if="profitPercentage > 10">{{ profitPercentage }}%</span>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between mt-2 small text-muted">
                                <span><span class="badge bg-danger rounded-pill me-1"> </span> Fixed</span>
                                <span><span class="badge bg-warning rounded-pill me-1"> </span> Variable</span>
                                <span><span class="badge bg-success rounded-pill me-1"> </span> Profit</span>
                            </div>
                        </div>
                         <div class="card-body p-5 text-center text-muted" v-else>
                            Enter revenue to see breakdown
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'reports'" class="fade-in">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="mb-0">Saved Reports</h3>
                 <div class="input-group w-auto">
                    <input type="text" class="form-control" v-model="searchUserId" placeholder="Search User ID">
                    <button class="btn btn-outline-primary" @click="loadReports">Refresh</button>
                </div>
            </div>

            <div class="card border-0 shadow-sm overflow-hidden" style="border-radius: 16px;">
                <div class="table-responsive">
                    <table class="table-premium mb-0">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Revenue</th>
                                <th>Net Profit</th>
                                <th>Mode</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="report in reports" :key="report.id">
                                <td class="fw-bold">#{{ report.id }}</td>
                                <td>{{ formatCurrency(parseJson(report.reportData).revenue) }}</td>
                                <td :class="parseJson(report.reportData).netProfit >= 0 ? 'text-success fw-bold' : 'text-danger fw-bold'">
                                    {{ formatCurrency(parseJson(report.reportData).netProfit) }}
                                </td>
                                <td>
                                    <span class="badge" :class="parseJson(report.reportData).mode === 'expert' ? 'bg-warning text-dark' : 'bg-primary'">
                                        {{ parseJson(report.reportData).mode || 'simple' }}
                                    </span>
                                </td>
                                <td class="text-muted small">{{ formatDate(report.createdAt) }}</td>
                            </tr>
                            <tr v-if="reports.length === 0">
                                <td colspan="5" class="text-center py-5 text-muted">No reports found for this user.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    const { createApp, ref, computed } = Vue;

    createApp({
        setup() {
            const currentTab = ref('analysis');
            const analysisMode = ref('simple'); // 'simple' or 'expert'
            const searchUserId = ref('user1@example.com');
            
            const form = ref({
                userId: 'user1@example.com',
                revenue: 0,
                fixedCost: 0,
                variableCost: 0
            });

            const isSaving = ref(false);
            const reports = ref([]);

            // Computed Properties
            const totalCosts = computed(() => (form.value.fixedCost || 0) + (form.value.variableCost || 0));
            const netProfit = computed(() => (form.value.revenue || 0) - totalCosts.value);
            
            const currentDate = computed(() => new Date().toLocaleDateString());
            const isFormValid = computed(() => form.value.userId && form.value.revenue >= 0);

            // BEP Calculation for Expert Mode
            // BEP = Fixed Cost / (1 - (Variable Cost / Revenue))
            const bep = computed(() => {
                const r = form.value.revenue;
                const f = form.value.fixedCost;
                const v = form.value.variableCost;

                if (r === 0) return 0;
                if (v >= r) return 0; // Infinity or bad biz

                const contributionMarginRatio = 1 - (v / r);
                if (contributionMarginRatio <= 0) return 0;

                return Math.round(f / contributionMarginRatio);
            });

            // Percentages for Progress Bar
            const fixedCostPercentage = computed(() => {
                if (!form.value.revenue) return 0;
                return Math.min(100, Math.round((form.value.fixedCost / form.value.revenue) * 100));
            });
            const variableCostPercentage = computed(() => {
                if (!form.value.revenue) return 0;
                let remaining = 100 - fixedCostPercentage.value;
                let calculated = Math.round((form.value.variableCost / form.value.revenue) * 100);
                return Math.min(remaining, calculated);
            });
            const profitPercentage = computed(() => {
                 if (!form.value.revenue) return 0;
                 return Math.max(0, 100 - fixedCostPercentage.value - variableCostPercentage.value);
            });


            // Methods
            const formatCurrency = (val) => window.CommonUtils.formatCurrency(val);
            
            const parseJson = (jsonStr) => {
                try {
                    return JSON.parse(jsonStr);
                } catch (e) {
                    return {};
                }
            };

            const formatDate = (dateStr) => {
                if (!dateStr) return '';
                return new Date(dateStr).toLocaleString();
            };

            const saveReport = async () => {
                if (!isFormValid.value) return;
                isSaving.value = true;
                
                const reportContent = {
                    mode: analysisMode.value,
                    revenue: form.value.revenue,
                    fixedCost: form.value.fixedCost,
                    variableCost: form.value.variableCost,
                    netProfit: netProfit.value,
                    bep: bep.value,
                    timestamp: new Date().toISOString()
                };

                try {
                    await axios.post('/api/report', {
                        userId: form.value.userId,
                        content: reportContent
                    });
                    alert('Report saved successfully!');
                    loadReports();
                } catch (error) {
                    console.error(error);
                    alert('Failed to save report: ' + error.message);
                } finally {
                    isSaving.value = false;
                }
            };

            const loadReports = async () => {
                const targetId = searchUserId.value || form.value.userId;
                try {
                    const response = await axios.get(`/api/report/${targetId}`);
                    reports.value = response.data;
                } catch (error) {
                    console.error(error);
                }
            };

            return {
                currentTab,
                analysisMode,
                form,
                totalCosts,
                netProfit,
                bep,
                currentDate,
                isFormValid,
                isSaving,
                saveReport,
                reports,
                loadReports,
                searchUserId,
                formatCurrency,
                parseJson,
                formatDate,
                fixedCostPercentage,
                variableCostPercentage,
                profitPercentage
            };
        }
    }).mount('#app');
</script>
</body>
</html>
