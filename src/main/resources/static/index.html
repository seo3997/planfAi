<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlanfAi - ÏÜåÏÉÅÍ≥µÏù∏ ÏàòÏùµ Î∂ÑÏÑù</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link href="/common/common.css" rel="stylesheet">
    
    <!-- CDN Dependencies -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/common/common.js"></script>
</head>
<body>

<div id="app" class="container-fluid px-4">
    <div class="glass-container">
        <!-- Header -->
        <header class="d-flex justify-content-between align-items-center mb-5">
            <div>
                <h1 class="display-5 mb-0" style="background: linear-gradient(to right, #6366f1, #ec4899); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent;">PlanfAi</h1>
                <p class="text-muted lead">ÏÜåÏÉÅÍ≥µÏù∏ Ïä§ÎßàÌä∏ ÏàòÏùµ Î∂ÑÏÑù ÏãúÏä§ÌÖú</p>
            </div>
            <div class="d-flex gap-2">
                 <div class="input-group">
                    <span class="input-group-text bg-white">ID</span>
                     <input type="text" class="form-control" v-model="userEmail" placeholder="Ïù¥Î©îÏùº ÏûÖÎ†•">
                 </div>
                 <button class="btn btn-outline-primary" @click="loadReports">Î∂àÎü¨Ïò§Í∏∞</button>
            </div>
        </header>

        <!-- Mode Switcher -->
        <div class="mode-switch-container">
            <div class="mode-switch">
                <button :class="{ active: mode === 'lite' }" @click="switchMode('lite')">üå± Í∞ÑÌé∏ Î™®Îìú</button>
                <button :class="{ active: mode === 'expert' }" @click="switchMode('expert')">üöÄ Ï†ÑÎ¨∏Í∞Ä Î™®Îìú</button>
            </div>
        </div>

            <!-- LITE MODE -->
            <div v-if="mode === 'lite'" key="lite">
                <div class="row g-4">
                    <div class="col-lg-5">
                        <div class="card-expert">
                            <div class="expert-header">
                                <h5>üìù Í∏∞Î≥∏ Ï†ïÎ≥¥ ÏûÖÎ†•</h5>
                            </div>
                            <div class="expert-body">
                                <div class="mb-3">
                                    <label class="form-label small fw-bold">ÏóÖÏ¢Ö ÏÑ†ÌÉù</label>
                                    <select class="form-select" v-model="liteData.basic.industryCd">
                                        <option value="1">Ï†úÏ°∞ÏóÖ</option>
                                        <option value="2">ÏÜåÎß§ÏóÖ</option>
                                        <option value="3">Ïô∏ÏãùÏóÖ</option>
                                        <option value="4">ÏãúÏÑ§ÏÑúÎπÑÏä§ÏóÖ</option>
                                        <option value="5">Ïö©Ïó≠ÏÑúÎπÑÏä§ÏóÖ</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label small fw-bold">Ïõî Î™©Ìëú ÏàúÏù¥Ïùµ</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" v-model.number="liteData.basic.monTargetPrice">
                                        <span class="input-group-text">Ïõê</span>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label small fw-bold d-flex justify-content-between">
                                        <span>Ïõî ÏòÅÏóÖÏùºÏàò</span>
                                        <span class="text-primary">{{ liteData.basic.workDay }}Ïùº</span>
                                    </label>
                                    <input type="range" class="form-range" min="1" max="31" v-model.number="liteData.basic.workDay">
                                </div>

                                <hr class="my-4" style="opacity: 0.1">

                                <h6 class="mb-3 text-primary">ÌåêÎß§ Î©îÎâ¥ ÏûÖÎ†•</h6>
                                <div v-for="(menu, idx) in liteData.sale.menu" :key="idx" class="mb-3 p-3 bg-light rounded-3 text-end position-relative">
                                    <button class="btn-close position-absolute top-0 end-0 m-2" @click="removeMenu(liteData.sale.menu, idx)" style="font-size: 0.7rem;"></button>
                                    <div class="row g-2 mb-2">
                                        <div class="col-12">
                                            <input type="text" class="form-control form-control-sm" v-model="menu.menuTitle" placeholder="Î©îÎâ¥Î™Ö (Ïòà: ÏïÑÎ©îÎ¶¨Ïπ¥ÎÖ∏)">
                                        </div>
                                        <div class="col-6">
                                            <div class="input-group input-group-sm">
                                                <input type="number" class="form-control" v-model.number="menu.menuPrice" placeholder="Îã®Í∞Ä">
                                                <span class="input-group-text">Ïõê</span>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="input-group input-group-sm">
                                                <input type="number" class="form-control" v-model.number="menu.menuQty" placeholder="ÌïòÎ£® ÌåêÎß§Îüâ">
                                                <span class="input-group-text">Í∞ú</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <button class="btn btn-outline-primary w-100 btn-sm mb-4" @click="addMenu(liteData.sale.menu)">+ Î©îÎâ¥ Ï∂îÍ∞Ä</button>

                                <div class="mb-3">
                                    <label class="form-label small fw-bold">Ïõî ÎåÄÎûµÏ†Å ÎπÑÏö© (Í≥†Ï†ïÎπÑ+Î≥ÄÎèôÎπÑ)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" v-model.number="liteData.liteCost.totalMonthlyCost" placeholder="Ï¥ù ÎπÑÏö© ÏûÖÎ†•">
                                        <span class="input-group-text">Ïõê</span>
                                    </div>
                                    <div class="form-text">Ïû¨Î£åÎπÑ, ÏõîÏÑ∏, Ïù∏Í±¥ÎπÑ Îì±ÏùÑ Ìï©Ïπú ÎåÄÎûµÏ†ÅÏù∏ Í∏àÏï°</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-7">
                        <div class="card-expert h-100 bg-white">
                            <div class="expert-header bg-white border-bottom-0">
                                <h5>üìä Î∂ÑÏÑù Í≤∞Í≥º</h5>
                            </div>
                            <div class="expert-body text-center pt-0">
                                <div class="py-5">
                                    <h6 class="text-uppercase text-muted small mb-2">ÌòÑÏû¨ ÏòàÏÉÅ ÏàúÏù¥Ïùµ</h6>
                                    <h2 class="display-4 fw-bold mb-3" :class="liteResult.netProfit >= 0 ? 'text-primary' : 'text-danger'">
                                        {{ formatCurrency(liteResult.netProfit) }}
                                    </h2>
                                    
                                    <!-- Target Gap Analysis -->
                                    <div class="alert mt-4" :class="liteResult.gap >= 0 ? 'alert-success' : 'alert-warning'">
                                        <span v-if="liteResult.gap >= 0">
                                            üéâ <strong>Ï∂ïÌïòÌï©ÎãàÎã§!</strong> Î™©Ìëú ÏàòÏùµÎ≥¥Îã§ {{ formatCurrency(liteResult.gap) }} Ï¥àÍ≥º Îã¨ÏÑ± Ï§ëÏûÖÎãàÎã§.
                                        </span>
                                        <span v-else>
                                            üí™ <strong>Ï°∞Í∏àÎßå Îçî!</strong> Î™©Ìëú({{ formatCurrency(liteData.basic.monTargetPrice) }})ÍπåÏßÄ <strong class="text-danger">{{ formatCurrency(Math.abs(liteResult.gap)) }}</strong>Ïù¥ Îçî ÌïÑÏöîÌï©ÎãàÎã§.
                                        </span>
                                    </div>

                                    <!-- Action Item -->
                                    <div class="card bg-light border-0 p-3 mt-4 text-start shadow-sm" v-if="(liteData.sale?.menu || []).length > 0 && liteResult.gap < 0">
                                        <div class="d-flex align-items-center mb-2 justify-content-between">
                                            <div>
                                                <span class="badge bg-primary me-2">Action Item</span>
                                                <span class="fw-bold">ÌòÑÏã§Ï†Å ÎåÄÏïà</span>
                                            </div>
                                            <span class="badge bg-danger-subtle text-danger">ÏÑ±Í≥µ ÌôïÎ•† 85% üî•</span>
                                        </div>
                                        <p class="mb-0 text-muted small">
                                            "{{ liteData.sale.menu[0].menuTitle }}" Î©îÎâ¥Î•º ÌïòÎ£®Ïóê 
                                            <strong class="text-dark fs-5">{{ Math.ceil(Math.abs(liteResult.gap) / (liteData.sale.menu[0].menuPrice * (liteData.basic.workDay || 25))) }}Í∞ú</strong> 
                                            Îßå Îçî ÌåîÎ©¥ Î™©Ìëú Îã¨ÏÑ±!
                                        </p>
                                    </div>



                                    <!-- Time-based Table -->
                                    <div class="mt-4">
                                        <h6 class="text-start small fw-bold mb-2">‚è±Ô∏è ÏãúÍ∞ÑÎ≥Ñ ÌôòÏÇ∞ ÌÖåÏù¥Î∏î</h6>
                                        <table class="table table-sm table-bordered text-center small mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Íµ¨Î∂Ñ</th>
                                                    <th>Ïùº (1Ïùº)</th>
                                                    <th>Ïõî ({{ liteData.basic.workDay }}Ïùº)</th>
                                                    <th>ÎÖÑ (12Í∞úÏõî)</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td class="bg-light fw-bold">Îß§Ï∂ú</td>
                                                    <td>{{ formatCurrency(liteResult.revenue / (liteData.basic.workDay || 1)) }}</td>
                                                    <td>{{ formatCurrency(liteResult.revenue) }}</td>
                                                    <td>{{ formatCurrency(liteResult.revenue * 12) }}</td>
                                                </tr>
                                                 <tr>
                                                    <td class="bg-light fw-bold">ÎπÑÏö©(ÏòàÏÉÅ)</td>
                                                    <td>{{ formatCurrency((liteData.liteCost.totalMonthlyCost || 0) / (liteData.basic.workDay || 1)) }}</td>
                                                    <td>{{ formatCurrency(liteData.liteCost.totalMonthlyCost) }}</td>
                                                    <td>{{ formatCurrency((liteData.liteCost.totalMonthlyCost || 0) * 12) }}</td>
                                                </tr>
                                                <tr :class="liteResult.netProfit >= 0 ? 'table-primary' : 'table-danger'">
                                                    <td class="fw-bold">ÏàòÏùµ</td>
                                                    <td class="fw-bold">{{ formatCurrency(liteResult.netProfit / (liteData.basic.workDay || 1)) }}</td>
                                                    <td class="fw-bold">{{ formatCurrency(liteResult.netProfit) }}</td>
                                                    <td class="fw-bold">{{ formatCurrency(liteResult.netProfit * 12) }}</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>

                                    <!-- BEP Visualization (Simplified) -->
                                    <div class="mt-4 text-start">
                                        <h6 class="small fw-bold mb-2">‚öñÔ∏è ÏÜêÏùµÎ∂ÑÍ∏∞Ï†ê (BEP) ÏãúÍ∞ÅÌôî</h6>
                                        <div class="position-relative pt-2 pb-4">
                                            <div class="progress" style="height: 10px;">
                                                <div class="progress-bar bg-success" role="progressbar" :style="{ width: Math.min(100, (liteResult.revenue / (liteData.liteCost.totalMonthlyCost || 1)) * 50) + '%' }"></div>
                                                <div class="progress-bar bg-warning" role="progressbar" style="width: 2px; position: absolute; left: 50%; height: 100%; top: 0; z-index: 5;"></div>
                                            </div>
                                            <div class="d-flex justify-content-between mt-1 small text-muted">
                                                <span>ÏÜêÏã§ Íµ¨Í∞Ñ</span>
                                                <span class="text-primary fw-bold">ÏàòÏùµ Íµ¨Í∞Ñ</span>
                                            </div>
                                            <p class="small text-center mt-2 text-dark bg-warning-subtle p-2 rounded">
                                                "ÏÇ¨Ïû•ÎãòÏùÄ Îß§Îã¨ <strong>{{ Math.min((liteData.basic.workDay || 25), Math.ceil((liteData.liteCost.totalMonthlyCost / (liteResult.revenue / (liteData.basic.workDay || 1))) || 0)) }}ÏùºÏß∏</strong> ÎêòÎäî ÎÇ†Î∂ÄÌÑ∞ ÏßÑÏßú ÏàòÏùµÏù¥ Î∞úÏÉùÌï©ÎãàÎã§."
                                            </p>
                                        </div>
                                    </div>

                                    <hr class="my-4">

                                    <!-- Hooks (Visual Compensation & Natural Hooks) -->
                                    <div class="hooks-container text-start">
                                        <!-- Hook 1 -->
                                        <div class="card border-primary border-opacity-25 mb-3">
                                         <div class="card-body p-3 bg-primary bg-opacity-10">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <div>
                                                        <h6 class="fw-bold text-primary mb-1">üßê ÎπÑÏö© Ìö®Ïú®ÏÑ± ÏßÑÎã®</h6>
                                                        <p class="small mb-2" style="font-size: 0.85rem;">
                                                            Î∞©Í∏à ÏûÖÎ†•ÌïòÏã† ÎπÑÏö© {{ formatCurrency(liteData.liteCost.totalMonthlyCost) }}, ÎèôÏ¢Ö ÏóÖÍ≥Ñ ÌèâÍ∑†Î≥¥Îã§ <span class="text-danger fw-bold">12% ÎÜíÍ≤å</span> Ï∏°Ï†ïÎêòÏóàÏäµÎãàÎã§.
                                                        </p>
                                                    </div>
                                                    <span class="fs-4">üí∏</span>
                                                </div>
                                                <button class="btn btn-sm btn-outline-primary w-100 bg-white" @click="switchMode('expert')">ÎÇ¥ Ïù∏Í±¥ÎπÑ¬∑ÏûÑÏ∞®Î£å ÏÉÅÏÑ∏ ÏßÑÎã®ÌïòÍ≥† ÎÇ≠ÎπÑ Ï§ÑÏù¥Í∏∞</button>
                                             </div>
                                        </div>

                                        <!-- Hook 2 -->
                                        <div class="card border-warning border-opacity-25 mb-3">
                                             <div class="card-body p-3 bg-warning bg-opacity-10">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <div>
                                                        <h6 class="fw-bold text-dark mb-1">‚ö†Ô∏è Î¶¨Ïä§ÌÅ¨ ÏãúÎÆ¨Î†àÏù¥ÏÖò</h6>
                                                        <p class="small mb-2" style="font-size: 0.85rem;">
                                                            Îß§Ï∂úÏù¥ 10%Îßå Îñ®Ïñ¥Ï†∏ÎèÑ ÏàúÏù¥ÏùµÏù¥ Ï†àÎ∞òÏúºÎ°ú Ï§ÑÏñ¥Îì§ Ïàò ÏûàÏäµÎãàÎã§.
                                                        </p>
                                                    </div>
                                                    <span class="fs-4">üìâ</span>
                                                </div>
                                                <button class="btn btn-sm btn-outline-dark w-100 bg-white" @click="switchMode('expert')">Î¶¨Ïä§ÌÅ¨ ÌôïÏù∏ÌïòÍ∏∞</button>
                                             </div>
                                        </div>
                                        
                                        <!-- Hook 3 -->
                                        <div class="card border-info border-opacity-25">
                                             <div class="card-body p-3 bg-info bg-opacity-10">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <div>
                                                        <h6 class="fw-bold text-dark mb-1">üè≠ Ï†úÏ°∞/ÏãùÎãπÏù¥Ïã†Í∞ÄÏöî?</h6>
                                                        <p class="small mb-2" style="font-size: 0.85rem;">
                                                            Í≥µÏû•(Ï£ºÎ∞©) Í≤ΩÎπÑÏôÄ Îß§Ïû• Í≤ΩÎπÑÎ•º Î∂ÑÎ¶¨ÌïòÎ©¥ ÏÑ∏Í∏àÏùÑ ÏïÑÎÇÑ Ïàò ÏûàÏäµÎãàÎã§.
                                                        </p>
                                                    </div>
                                                    <span class="fs-4">üèóÔ∏è</span>
                                                </div>
                                                <button class="btn btn-sm btn-outline-info w-100 bg-white text-dark" @click="switchMode('expert')">Ï†àÏÑ∏ Ï†ÑÎûµ Î≥¥Í∏∞</button>
                                             </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- EXPERT MODE -->
            <div v-else key="expert">
                <div class="row g-4">
                    <!-- Left: Input Sections -->
                    <div class="col-lg-7">
                        <div class="accordion" id="expertAccordion">
                            
                            <!-- 1. Basic Info -->
                            <div class="accordion-item border-0 mb-3 shadow-sm rounded-3 overflow-hidden">
                                <h2 class="accordion-header">
                                    <button class="accordion-button fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBasic">
                                        <span class="section-badge">1Îã®Í≥Ñ</span> Í∏∞Î≥∏ Ï†ïÎ≥¥ ÏÑ§Ï†ï
                                    </button>
                                </h2>
                                <div id="collapseBasic" class="accordion-collapse collapse show" data-bs-parent="#expertAccordion">
                                    <div class="accordion-body bg-light">
                                        <div class="mb-3">
                                            <label class="form-label small fw-bold text-muted">ÏóÖÏ¢Ö ÏÑ†ÌÉù</label>
                                            <select class="form-select form-select-sm" v-model="expertData.basic.industryCd">
                                                <option value="1">Ï†úÏ°∞ÏóÖ</option>
                                                <option value="2">ÏÜåÎß§ÏóÖ</option>
                                                <option value="3">ÏùåÏãùÏóÖ</option>
                                                <option value="4">ÏÑúÎπÑÏä§ÏóÖ</option>
                                                <option value="5">Í∏∞Ïà†ÏßÅÍµ∞</option>
                                            </select>
                                        </div>
                                        <div class="row g-2">
                                            <div class="col-6">
                                                <label class="form-label small fw-bold text-muted">Ïõî Î™©Ìëú Ïù¥Ïùµ</label>
                                                <div class="input-group input-group-sm">
                                                    <input type="number" class="form-control" v-model.number="expertData.basic.monTargetPrice">
                                                    <span class="input-group-text">Ïõê</span>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <label class="form-label small fw-bold text-muted">Ïõî ÏòÅÏóÖÏùºÏàò</label>
                                                <div class="input-group input-group-sm">
                                                    <input type="number" class="form-control" v-model.number="expertData.basic.workDay">
                                                    <span class="input-group-text">Ïùº</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 2. Revenue & Cost Plan -->
                            <div class="accordion-item border-0 mb-3 shadow-sm rounded-3 overflow-hidden">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSale">
                                        <span class="section-badge">2Îã®Í≥Ñ</span> Îß§Ï∂ú Î∞è ÏõêÍ∞Ä Í≥ÑÌöç
                                    </button>
                                </h2>
                                <div id="collapseSale" class="accordion-collapse collapse" data-bs-parent="#expertAccordion">
                                    <div class="accordion-body bg-light text-dark p-2">
                                        <div class="mb-3">
                                            <label class="form-label small fw-bold text-muted">ÌåêÎß§Îüâ ÏûÖÎ†• Î∞©Ïãù</label>
                                            <select class="form-select form-select-sm" v-model="expertData.basic.saleMode">
                                                <option value="1">ÏùºÏùº ÌèâÍ∑† ÌåêÎß§Îüâ ÏûÖÎ†•</option>
                                                <option value="2">ÏõîÍ∞Ñ Ï¥ù ÌåêÎß§Îüâ ÏßÅÏ†ë ÏûÖÎ†•</option>
                                            </select>
                                        </div>
                                        
                                        <div v-for="(menu, idx) in expertData.sale.menu" :key="'em'+idx" class="card-menu mb-3 border-0 shadow-sm bg-white rounded">
                                            <div class="card-body p-3">
                                                <div class="d-flex justify-content-between mb-2">
                                                    <input type="text" class="form-control form-control-sm border-0 fw-bold fs-6 p-0" v-model="menu.menuTitle" placeholder="Î©îÎâ¥/Ï†úÌíàÎ™Ö" style="width: 80%">
                                                    <button class="btn-close small" @click="removeMenu(expertData.sale.menu, idx, expertData.cost.costRate)"></button>
                                                </div>
                                                <div class="row g-2">
                                                    <div class="col-4">
                                                        <label class="small text-muted">ÌåêÎß§Îã®Í∞Ä</label>
                                                        <input type="number" class="form-control form-control-sm" v-model.number="menu.menuPrice">
                                                    </div>
                                                    <div class="col-4">
                                                        <label class="small text-muted">{{ expertData.basic.saleMode == '1' ? 'Ïùº ÌåêÎß§Îüâ' : 'Ïõî ÌåêÎß§Îüâ' }}</label>
                                                        <input type="number" class="form-control form-control-sm" v-model.number="menu.menuQty">
                                                    </div>
                                                    <div class="col-4">
                                                        <label class="small text-muted">Ïû¨Î£åÎπÑÏú®(%)</label>
                                                        <input type="number" class="form-control form-control-sm" v-model.number="expertData.cost.costRate[idx]">
                                                    </div>
                                                </div>
                                                <div class="mt-2 d-flex justify-content-between align-items-center">
                                                    <div class="small text-muted">
                                                        <div>ÏòàÏÉÅ Ïõî Îß§Ï∂ú: <strong class="text-primary">{{ formatCurrency(calcMenuMonthlyRevenue(menu)) }}</strong></div>
                                                        <div>ÏòàÏÉÅ Ïõî Ïû¨Î£åÎπÑ: <strong class="text-danger">{{ formatCurrency(Math.round(calcMenuMonthlyRevenue(menu) * (expertData.cost.costRate[idx] || 0) / 100)) }}</strong></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <button class="btn btn-outline-secondary w-100 btn-sm" @click="addMenuExpert">+ Î©îÎâ¥ Ï∂îÍ∞Ä</button>
                                    </div>
                                </div>
                            </div>

                            <!-- 3. Labor Plan -->
                            <div class="accordion-item border-0 mb-3 shadow-sm rounded-3 overflow-hidden">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapseLabor">
                                        <span class="section-badge">3Îã®Í≥Ñ</span> Ïù∏Í±¥ÎπÑ Í≥ÑÌöç
                                    </button>
                                </h2>
                                <div id="collapseLabor" class="accordion-collapse collapse" data-bs-parent="#expertAccordion">
                                    <div class="accordion-body bg-light">
                                        
                                        <!-- Job Production -->
                                        <h6 class="small text-muted fw-bold mb-2">ÏÉùÏÇ∞/Ï†úÏ°∞ÏßÅ (Ï†úÏ°∞ÏõêÍ∞Ä)</h6>
                                        <div v-for="(job, idx) in expertData.job.production" :key="'j1'+idx" class="mb-3 p-2 bg-white rounded border border-light shadow-sm">
                                            <div class="d-flex gap-2 mb-2 align-items-center">
                                                <input type="text" class="form-control form-control-sm" v-model="job.jobTitle" placeholder="ÏßÅÏ±Ö" style="width: 30%">
                                                <input type="number" class="form-control form-control-sm" v-model.number="job.jobCnt" placeholder="Ïù∏Ïõê" style="width: 20%">
                                                <input type="number" class="form-control form-control-sm" v-model.number="job.jobQty" placeholder="Ïõî Í∏âÏó¨" style="width: 40%">
                                                <button class="btn-close" @click="expertData.job.production.splice(idx, 1)"></button>
                                            </div>
                                            <div class="text-end small text-muted px-1">
                                                Ïõî Ïù∏Í±¥ÎπÑ: <strong class="text-primary">{{ formatCurrency((job.jobCnt || 0) * (job.jobQty || 0)) }}</strong>
                                            </div>
                                        </div>
                                        <button class="btn btn-sm btn-light w-100 border mb-4" @click="addJob(expertData.job.production)">+ Ïù∏Ïõê Ï∂îÍ∞Ä</button>

                                        <!-- Job Sales -->
                                        <h6 class="small text-muted fw-bold mb-2">ÌåêÎß§/Í¥ÄÎ¶¨ÏßÅ (ÌåêÍ¥ÄÎπÑ)</h6>
                                        <div v-for="(job, idx) in expertData.job.sales" :key="'j2'+idx" class="mb-3 p-2 bg-white rounded border border-light shadow-sm">
                                            <div class="d-flex gap-2 mb-2 align-items-center">
                                                <input type="text" class="form-control form-control-sm" v-model="job.jobTitle" placeholder="ÏßÅÏ±Ö/ÏÑ±Î™Ö" style="width: 30%">
                                                <input type="number" class="form-control form-control-sm" v-model.number="job.jobCnt" placeholder="Ïù∏Ïõê" style="width: 20%">
                                                <input type="number" class="form-control form-control-sm" v-model.number="job.jobQty" placeholder="Ïõî Í∏âÏó¨" style="width: 40%">
                                                <button class="btn-close" @click="expertData.job.sales.splice(idx, 1)"></button>
                                            </div>
                                            <div class="text-end small text-muted px-1">
                                                Ïõî Ïù∏Í±¥ÎπÑ: <strong class="text-primary">{{ formatCurrency((job.jobCnt || 0) * (job.jobQty || 0)) }}</strong>
                                            </div>
                                        </div>
                                        <button class="btn btn-sm btn-light w-100 border" @click="addJob(expertData.job.sales)">+ Ïù∏Ïõê Ï∂îÍ∞Ä</button>
                                    </div>
                                </div>
                            </div>

                            <!-- 4. Investment Plan -->
                             <div class="accordion-item border-0 mb-3 shadow-sm rounded-3 overflow-hidden">
                                 <h2 class="accordion-header">
                                     <button class="accordion-button collapsed fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInvest">
                                         <span class="section-badge">4Îã®Í≥Ñ</span> Ìà¨Ïûê Í≥ÑÌöç (Investment Plan)
                                     </button>
                                 </h2>
                                 <div id="collapseInvest" class="accordion-collapse collapse" data-bs-parent="#expertAccordion">
                                     <div class="accordion-body bg-light">
                                         <div v-for="(catName, catIdx) in ['Ïú†ÌòïÏûêÏÇ∞','Î¨¥ÌòïÏûêÏÇ∞','Í∏∞ÌÉÄÎπÑÏú†ÎèôÏûêÏÇ∞','Í∏∞ÌÉÄÌà¨ÏûêÎπÑÏö©']" :key="catIdx" class="mb-4">
                                            <div class="d-flex justify-content-between align-items-center mb-2 bg-white p-2 rounded shadow-sm">
                                                <h6 class="fw-bold mb-0 text-primary">{{ catIdx + 1 }}. {{ catName }}</h6>
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-outline-primary" @click="addInvestInCategory(catIdx+1, 'production')">+ Ï†úÏ°∞ Ï∂îÍ∞Ä</button>
                                                    <button class="btn btn-outline-info" @click="addInvestInCategory(catIdx+1, 'sales')">+ ÌåêÎß§ Ï∂îÍ∞Ä</button>
                                                </div>
                                            </div>
                                            
                                            <div class="table-responsive">
                                                <table class="table table-sm small align-middle bg-white rounded shadow-sm mb-0">
                                                    <thead class="bg-light-subtle">
                                                        <tr class="text-center small">
                                                            <th width="10%">Î∂ÄÎ¨∏</th>
                                                            <th :width="catIdx < 2 ? '25%' : '55%'">Ìï≠Î™©Î™Ö</th>
                                                            <th width="20%">Í∏àÏï°(Ïõê)</th>
                                                            <th v-if="catIdx < 2" width="10%">ÎÖÑÏàò</th>
                                                            <th v-if="catIdx < 2" width="10%">ÏÉÅÍ∞Å</th>
                                                            <th v-if="catIdx < 2" width="20%">Ïõî ÏÉÅÍ∞ÅÎπÑ</th>
                                                            <th width="5%"></th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <!-- Production Items -->
                                                        <tr v-for="(inv, idx) in expertData.invest.production['production0'+(catIdx+1)]" :key="'p'+idx">
                                                            <td class="text-center"><span class="badge bg-primary-subtle text-primary">Ï†úÏ°∞</span></td>
                                                            <td>
                                                                <select class="form-select form-select-sm" v-model="inv.investTitleCd" @change="onInvestItemChange(inv, catIdx+1)">
                                                                    <option v-for="item in investCategoryItems[catIdx+1]" :value="item.cd">{{ item.name }}</option>
                                                                </select>
                                                            </td>
                                                            <td><input type="number" class="form-control form-control-sm text-end" v-model.number="inv.investPrice"></td>
                                                            <td v-if="catIdx < 2">
                                                                <input v-if="(catIdx === 0 && inv.investTitleCd === '10') || (catIdx === 1 && inv.investTitleCd === '10')" type="text" class="form-control form-control-sm text-center bg-light" value="-" disabled>
                                                                <input v-else type="number" class="form-control form-control-sm text-center" v-model.number="inv.investYear" :disabled="inv.investYn === 'N'">
                                                            </td>
                                                            <td v-if="catIdx < 2">
                                                                <span v-if="(catIdx === 0 && inv.investTitleCd === '10') || (catIdx === 1 && inv.investTitleCd === '10')" class="text-muted small">N/A</span>
                                                                <select v-else class="form-select form-select-sm" v-model="inv.investYn">
                                                                    <option value="Y">Y</option>
                                                                    <option value="N">N</option>
                                                                </select>
                                                            </td>
                                                            <td v-if="catIdx < 2" class="text-end pe-2 fw-bold text-muted">
                                                                {{ (catIdx === 0 && inv.investTitleCd === '10') || (catIdx === 1 && inv.investTitleCd === '10') ? '-' : formatCurrency(inv.investYearAmt || 0) }}
                                                            </td>
                                                            <td class="text-center"><button class="btn-close small" @click="expertData.invest.production['production0'+(catIdx+1)].splice(idx,1)"></button></td>
                                                        </tr>
                                                        <!-- Sales Items -->
                                                        <tr v-for="(inv, idx) in expertData.invest.sales['sales0'+(catIdx+1)]" :key="'s'+idx">
                                                            <td class="text-center"><span class="badge bg-info-subtle text-info">ÌåêÎß§</span></td>
                                                            <td>
                                                                <select class="form-select form-select-sm" v-model="inv.investTitleCd" @change="onInvestItemChange(inv, catIdx+1)">
                                                                    <option v-for="item in investCategoryItems[catIdx+1]" :value="item.cd">{{ item.name }}</option>
                                                                </select>
                                                            </td>
                                                            <td><input type="number" class="form-control form-control-sm text-end" v-model.number="inv.investPrice"></td>
                                                            <td v-if="catIdx < 2">
                                                                <input v-if="(catIdx === 0 && inv.investTitleCd === '10') || (catIdx === 1 && inv.investTitleCd === '10')" type="text" class="form-control form-control-sm text-center bg-light" value="-" disabled>
                                                                <input v-else type="number" class="form-control form-control-sm text-center" v-model.number="inv.investYear" :disabled="inv.investYn === 'N'">
                                                            </td>
                                                            <td v-if="catIdx < 2">
                                                                <span v-if="(catIdx === 0 && inv.investTitleCd === '10') || (catIdx === 1 && inv.investTitleCd === '10')" class="text-muted small">N/A</span>
                                                                <select v-else class="form-select form-select-sm" v-model="inv.investYn">
                                                                    <option value="Y">Y</option>
                                                                    <option value="N">N</option>
                                                                </select>
                                                            </td>
                                                            <td v-if="catIdx < 2" class="text-end pe-2 fw-bold text-muted">
                                                                {{ (catIdx === 0 && inv.investTitleCd === '10') || (catIdx === 1 && inv.investTitleCd === '10') ? '-' : formatCurrency(inv.investYearAmt || 0) }}
                                                            </td>
                                                            <td class="text-center"><button class="btn-close small" @click="expertData.invest.sales['sales0'+(catIdx+1)].splice(idx,1)"></button></td>
                                                        </tr>
                                                        <tr v-if="expertData.invest.production['production0'+(catIdx+1)].length === 0 && expertData.invest.sales['sales0'+(catIdx+1)].length === 0">
                                                            <td :colspan="catIdx < 2 ? 7 : 4" class="text-center py-3 text-muted small">Îì±Î°ùÎêú Ìï≠Î™©Ïù¥ ÏóÜÏäµÎãàÎã§.</td>
                                                        </tr>
                                                    </tbody>
                                                    <tfoot v-if="expertData.invest.production['production0'+(catIdx+1)].length > 0 || expertData.invest.sales['sales0'+(catIdx+1)].length > 0" class="bg-light-subtle">
                                                        <!-- Production Subtotal -->
                                                        <tr v-if="expertData.invest.production['production0'+(catIdx+1)].length > 0" class="text-primary-emphasis" style="font-size: 0.8rem;">
                                                            <td colspan="2" class="text-center fw-bold">Ï†úÏ°∞ ÏÜåÍ≥Ñ</td>
                                                            <td class="text-end pe-2 fw-bold">{{ formatCurrency(calcInvestTotals(catIdx).production.price) }}</td>
                                                            <td v-if="catIdx < 2" colspan="2"></td>
                                                            <td v-if="catIdx < 2" class="text-end pe-2 fw-bold">{{ formatCurrency(calcInvestTotals(catIdx).production.depr) }}</td>
                                                            <td></td>
                                                        </tr>
                                                        <!-- Sales Subtotal -->
                                                        <tr v-if="expertData.invest.sales['sales0'+(catIdx+1)].length > 0" class="text-info-emphasis" style="font-size: 0.8rem;">
                                                            <td colspan="2" class="text-center fw-bold">ÌåêÎß§ ÏÜåÍ≥Ñ</td>
                                                            <td class="text-end pe-2 fw-bold">{{ formatCurrency(calcInvestTotals(catIdx).sales.price) }}</td>
                                                            <td v-if="catIdx < 2" colspan="2"></td>
                                                            <td v-if="catIdx < 2" class="text-end pe-2 fw-bold">{{ formatCurrency(calcInvestTotals(catIdx).sales.depr) }}</td>
                                                            <td></td>
                                                        </tr>
                                                        <!-- Grand Total -->
                                                        <tr class="bg-secondary-subtle border-top border-secondary">
                                                            <td colspan="2" class="text-center fw-bold">Ìï©Í≥Ñ</td>
                                                            <td class="text-end pe-2 fw-bold">{{ formatCurrency(calcInvestTotals(catIdx).total.price) }}</td>
                                                            <td v-if="catIdx < 2" colspan="2"></td>
                                                            <td v-if="catIdx < 2" class="text-end pe-2 fw-bold text-primary">{{ formatCurrency(calcInvestTotals(catIdx).total.depr) }}</td>
                                                            <td></td>
                                                        </tr>
                                                    </tfoot>
                                                </table>
                                             </div>
                                          </div>
                                          <!-- Investment Grand Summary -->
                                          <div class="mt-2 p-3 bg-white rounded-3 shadow-sm border border-primary border-opacity-25">
                                              <h6 class="fw-bold text-primary mb-3"><i class="bi bi-graph-up-arrow me-2"></i>Ìà¨Ïûê Í≥ÑÌöç Ï¥ùÍ¥Ñ ÏöîÏïΩ</h6>
                                              <div class="table-responsive">
                                                  <table class="table table-sm align-middle mb-0" style="font-size: 0.85rem;">
                                                      <thead class="table-light">
                                                          <tr class="text-center">
                                                              <th>Íµ¨Î∂Ñ</th>
                                                              <th>Ï¥ù Ìà¨Ïûê Í∏àÏï°</th>
                                                              <th>Ïõî Ï¥ù ÏÉÅÍ∞ÅÎπÑ</th>
                                                          </tr>
                                                      </thead>
                                                      <tbody>
                                                          <tr class="text-primary-emphasis">
                                                              <td class="text-center fw-bold">Ï†úÏ°∞ Î∂ÄÎ¨∏ Ï¥ù Ìï©Í≥Ñ</td>
                                                              <td class="text-end pe-3 fw-bold">{{ formatCurrency(calcAllInvestTotals().production.price) }}</td>
                                                              <td class="text-end pe-3 fw-bold">{{ formatCurrency(calcAllInvestTotals().production.depr) }}</td>
                                                          </tr>
                                                          <tr class="text-info-emphasis">
                                                              <td class="text-center fw-bold">ÌåêÎß§ Î∂ÄÎ¨∏ Ï¥ù Ìï©Í≥Ñ</td>
                                                              <td class="text-end pe-3 fw-bold">{{ formatCurrency(calcAllInvestTotals().sales.price) }}</td>
                                                              <td class="text-end pe-3 fw-bold">{{ formatCurrency(calcAllInvestTotals().sales.depr) }}</td>
                                                          </tr>
                                                          <tr class="table-primary border-top border-primary border-2">
                                                              <td class="text-center fw-bold fs-6">Ï†ÑÏ≤¥ Ìà¨Ïûê Ï¥ù Ìï©Í≥Ñ</td>
                                                              <td class="text-end pe-3 fw-bold fs-6">{{ formatCurrency(calcAllInvestTotals().total.price) }}</td>
                                                              <td class="text-end pe-3 fw-bold fs-6 text-primary">{{ formatCurrency(calcAllInvestTotals().total.depr) }}</td>
                                                          </tr>
                                                      </tbody>
                                                  </table>
                                              </div>
                                          </div>
                                     </div>
                                 </div>
                             </div>

                             <!-- 5. Financing Plan -->
                             <div class="accordion-item border-0 mb-3 shadow-sm rounded-3 overflow-hidden">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapseLoan">
                                        <span class="section-badge">5Îã®Í≥Ñ</span> ÏûêÍ∏àÏ°∞Îã¨ Í≥ÑÌöç (Financing Plan)
                                    </button>
                                </h2>
                                <div id="collapseLoan" class="accordion-collapse collapse" data-bs-parent="#expertAccordion">
                                    <div class="accordion-body bg-light">
                                         <!-- 1. Own Funds (Equity) -->
                                         <div class="mb-4">
                                             <div class="d-flex justify-content-between align-items-center mb-2 px-1">
                                                 <h6 class="small fw-bold text-success mb-0">‚óè ÏûêÍ∏∞ÏûêÍ∏à (Equity)</h6>
                                                 <button class="btn btn-sm btn-outline-success py-1 px-3" @click="addLoan(expertData.loan.equity, false)" style="font-size: 0.75rem;">+ ÏûêÍ∏∞ÏûêÍ∏à Ï∂îÍ∞Ä</button>
                                             </div>
                                             <div class="table-responsive">
                                                 <table class="table table-sm small align-middle bg-white rounded shadow-sm mb-0">
                                                      <thead class="bg-light-subtle">
                                                          <tr class="text-center">
                                                              <th width="30%">Ìï≠Î™©Î™Ö</th>
                                                              <th width="20%">1Ï∞®ÎÖÑÎèÑ(Ïõê)</th>
                                                              <th width="20%">2Ï∞®ÎÖÑÎèÑ(Ïõê)</th>
                                                              <th width="20%">3Ï∞®ÎÖÑÎèÑ(Ïõê)</th>
                                                              <th width="10%"></th>
                                                          </tr>
                                                      </thead>
                                                      <tbody>
                                                          <tr v-for="(ln, idx) in expertData.loan.equity" :key="'eq'+idx">
                                                              <td>
                                                                  <select class="form-select form-select-sm" v-model="ln.loanTitleCd" @change="onEquityCdChange(ln)">
                                                                      <option v-for="item in equityCategoryItems" :value="item.cd">{{ item.name }}</option>
                                                                  </select>
                                                              </td>
                                                              <td><input type="number" class="form-control form-control-sm text-end" v-model.number="ln.loanYear[0]"></td>
                                                              <td><input type="number" class="form-control form-control-sm text-end" v-model.number="ln.loanYear[1]"></td>
                                                              <td><input type="number" class="form-control form-control-sm text-end" v-model.number="ln.loanYear[2]"></td>
                                                              <td class="text-center"><button class="btn-close small" @click="expertData.loan.equity.splice(idx,1)"></button></td>
                                                          </tr>
                                                          <tr v-if="expertData.loan.equity.length === 0">
                                                              <td colspan="5" class="text-center py-3 text-muted small">Îì±Î°ùÎêú ÏûêÍ∏∞ÏûêÍ∏àÏù¥ ÏóÜÏäµÎãàÎã§.</td>
                                                          </tr>
                                                      </tbody>
                                                      <tfoot v-if="expertData.loan.equity.length > 0" class="bg-light-subtle fw-bold">
                                                          <tr>
                                                              <td class="text-center small">ÏûêÍ∏∞ÏûêÍ∏à ÏÜåÍ≥Ñ</td>
                                                              <td class="text-end pe-2">{{ formatCurrency(calcLoanTotals().eq[0]) }}</td>
                                                              <td class="text-end pe-2">{{ formatCurrency(calcLoanTotals().eq[1]) }}</td>
                                                              <td class="text-end pe-2">{{ formatCurrency(calcLoanTotals().eq[2]) }}</td>
                                                              <td></td>
                                                          </tr>
                                                      </tfoot>
                                                  </table>
                                             </div>
                                         </div>

                                         <!-- 2. Borrowed Funds (Debt) -->
                                         <div>
                                             <div class="d-flex justify-content-between align-items-center mb-2 px-1">
                                                 <h6 class="small fw-bold text-warning mb-0">‚óè ÌÉÄÏù∏ÏûêÍ∏à (Debt)</h6>
                                                 <button class="btn btn-sm btn-outline-warning py-1 px-3" @click="addLoan(expertData.loan.debt, true)" style="font-size: 0.75rem;">+ ÌÉÄÏù∏ÏûêÍ∏à Ï∂îÍ∞Ä</button>
                                             </div>
                                             <div class="table-responsive">
                                                 <table class="table table-sm small align-middle bg-white rounded shadow-sm mb-0">
                                                      <thead class="bg-light-subtle">
                                                          <tr class="text-center">
                                                               <th width="20%">Ìï≠Î™©Î™Ö</th>
                                                              <th width="24%">1Ï∞®ÎÖÑÎèÑ (Í∏àÏï°/Ïú®/Ïù¥Ïûê)</th>
                                                              <th width="24%">2Ï∞®ÎÖÑÎèÑ (Í∏àÏï°/Ïú®/Ïù¥Ïûê)</th>
                                                              <th width="24%">3Ï∞®ÎÖÑÎèÑ (Í∏àÏï°/Ïú®/Ïù¥Ïûê)</th>
                                                              <th width="8%"></th>
                                                          </tr>
                                                      </thead>
                                                      <tbody>
                                                          <tr v-for="(ln, idx) in expertData.loan.debt" :key="'db'+idx">
                                                              <td>
                                                                  <input type="text" class="form-control form-control-sm fw-bold" v-model="ln.loanTitle" placeholder="Í∏àÏúµÍ∏∞Í¥ÄÎ™Ö Îì±">
                                                              </td>
                                                              <!-- Y1 -->
                                                              <td>
                                                                  <input type="number" class="form-control form-control-sm text-end mb-1" v-model.number="ln.loanYear[0]" placeholder="ÏõêÍ∏à">
                                                                  <div class="input-group input-group-sm mb-1">
                                                                      <span class="input-group-text p-1" style="font-size: 0.6rem;">%</span>
                                                                      <input type="number" step="0.1" class="form-control form-control-sm text-end" v-model.number="ln.loanRate[0]" @input="onDebtValueChange(ln, 'rate', 0)">
                                                                  </div>
                                                                  <div class="text-end small text-primary fw-bold" style="font-size: 0.7rem;">Ïù¥Ïûê: {{ formatCurrency(ln.loanRateAmt[0] || 0) }}</div>
                                                              </td>
                                                              <!-- Y2 -->
                                                              <td>
                                                                  <input type="number" class="form-control form-control-sm text-end mb-1" v-model.number="ln.loanYear[1]" placeholder="ÏõêÍ∏àÏ¶ùÍ∞ê">
                                                                  <div class="input-group input-group-sm mb-1">
                                                                      <span class="input-group-text p-1" style="font-size: 0.6rem;">%</span>
                                                                      <input type="number" step="0.1" class="form-control form-control-sm text-end" v-model.number="ln.loanRate[1]" @input="onDebtValueChange(ln, 'rate', 1)">
                                                                  </div>
                                                                  <div class="text-end small text-primary fw-bold" style="font-size: 0.7rem;">Ïù¥Ïûê: {{ formatCurrency(ln.loanRateAmt[1] || 0) }}</div>
                                                              </td>
                                                              <!-- Y3 -->
                                                              <td>
                                                                  <input type="number" class="form-control form-control-sm text-end mb-1" v-model.number="ln.loanYear[2]" placeholder="ÏõêÍ∏àÏ¶ùÍ∞ê">
                                                                  <div class="input-group input-group-sm mb-1">
                                                                      <span class="input-group-text p-1" style="font-size: 0.6rem;">%</span>
                                                                      <input type="number" step="0.1" class="form-control form-control-sm text-end" v-model.number="ln.loanRate[2]" @input="onDebtValueChange(ln, 'rate', 2)">
                                                                  </div>
                                                                  <div class="text-end small text-primary fw-bold" style="font-size: 0.7rem;">Ïù¥Ïûê: {{ formatCurrency(ln.loanRateAmt[2] || 0) }}</div>
                                                              </td>
                                                              <td class="text-center"><button class="btn-close small" @click="expertData.loan.debt.splice(idx,1)"></button></td>
                                                          </tr>
                                                          <tr v-if="expertData.loan.debt.length === 0">
                                                              <td colspan="5" class="text-center py-3 text-muted small">Îì±Î°ùÎêú ÌÉÄÏù∏ÏûêÍ∏àÏù¥ ÏóÜÏäµÎãàÎã§.</td>
                                                          </tr>
                                                      </tbody>
                                                      <tfoot v-if="expertData.loan.debt.length > 0" class="bg-light-subtle fw-bold">
                                                          <tr class="text-info-emphasis">
                                                              <td class="text-center small">ÌÉÄÏù∏ÏûêÍ∏à ÏÜåÍ≥Ñ</td>
                                                              <td class="text-end pe-2">{{ formatCurrency(calcLoanTotals().db[0]) }}</td>
                                                              <td class="text-end pe-2">{{ formatCurrency(calcLoanTotals().db[1]) }}</td>
                                                              <td class="text-end pe-2">{{ formatCurrency(calcLoanTotals().db[2]) }}</td>
                                                              <td></td>
                                                          </tr>
                                                          <tr class="table-warning border-top">
                                                              <td class="text-center small">Ïó∞ Ïù¥ÏûêÎπÑÏö© Ìï©Í≥Ñ</td>
                                                              <td class="text-end pe-2 text-danger" style="font-size: 0.75rem;">{{ formatCurrency(calcLoanTotals().intr[0]) }}</td>
                                                              <td class="text-end pe-2 text-danger" style="font-size: 0.75rem;">{{ formatCurrency(calcLoanTotals().intr[1]) }}</td>
                                                              <td class="text-end pe-2 text-danger" style="font-size: 0.75rem;">{{ formatCurrency(calcLoanTotals().intr[2]) }}</td>
                                                              <td></td>
                                                          </tr>
                                                      </tfoot>
                                                  </table>
                                             </div>
                                         </div>

                                         <!-- Financing Grand Summary -->
                                         <div class="mt-4 p-3 bg-white rounded-3 shadow-sm border border-success border-opacity-25">
                                             <h6 class="fw-bold text-success mb-3"><i class="bi bi-wallet2 me-2"></i>ÏûêÍ∏àÏ°∞Îã¨ Í≥ÑÌöç Ï¥ùÍ¥Ñ ÏöîÏïΩ</h6>
                                             <div class="table-responsive">
                                                 <table class="table table-sm align-middle mb-0" style="font-size: 0.85rem;">
                                                     <thead class="table-light">
                                                         <tr class="text-center">
                                                             <th>Íµ¨Î∂Ñ</th>
                                                             <th>1Ï∞®ÎÖÑÎèÑ(Ïõê)</th>
                                                             <th>2Ï∞®ÎÖÑÎèÑ(Ïõê)</th>
                                                             <th>3Ï∞®ÎÖÑÎèÑ(Ïõê)</th>
                                                         </tr>
                                                     </thead>
                                                     <tbody>
                                                         <tr>
                                                             <td class="text-center fw-bold text-success">ÏûêÍ∏∞ÏûêÍ∏à(Equity) Ìï©Í≥Ñ</td>
                                                             <td class="text-end pe-3">{{ formatCurrency(calcLoanTotals().eq[0]) }}</td>
                                                             <td class="text-end pe-3">{{ formatCurrency(calcLoanTotals().eq[1]) }}</td>
                                                             <td class="text-end pe-3">{{ formatCurrency(calcLoanTotals().eq[2]) }}</td>
                                                         </tr>
                                                         <tr>
                                                             <td class="text-center fw-bold text-warning">ÌÉÄÏù∏ÏûêÍ∏à(Debt) Ìï©Í≥Ñ</td>
                                                             <td class="text-end pe-3">{{ formatCurrency(calcLoanTotals().db[0]) }}</td>
                                                             <td class="text-end pe-3">{{ formatCurrency(calcLoanTotals().db[1]) }}</td>
                                                             <td class="text-end pe-3">{{ formatCurrency(calcLoanTotals().db[2]) }}</td>
                                                         </tr>
                                                         <tr class="table-success border-top border-success border-2">
                                                             <td class="text-center fw-bold fs-6">Ï¥ù Ï°∞Îã¨ ÏûêÍ∏à Ìï©Í≥Ñ</td>
                                                             <td class="text-end pe-3 fw-bold fs-6">{{ formatCurrency(calcLoanTotals().total[0]) }}</td>
                                                             <td class="text-end pe-3 fw-bold fs-6">{{ formatCurrency(calcLoanTotals().total[1]) }}</td>
                                                             <td class="text-end pe-3 fw-bold fs-6">{{ formatCurrency(calcLoanTotals().total[2]) }}</td>
                                                         </tr>
                                                         <tr class="table-light border-top">
                                                             <td class="text-center fw-bold text-danger" style="font-size: 0.75rem;">Ï¥ù Ïù¥ÏûêÎπÑÏö© Ìï©Í≥Ñ</td>
                                                             <td class="text-end pe-3 text-danger fw-bold" style="font-size: 0.75rem;">{{ formatCurrency(calcLoanTotals().intr[0]) }}</td>
                                                             <td class="text-end pe-3 text-danger fw-bold" style="font-size: 0.75rem;">{{ formatCurrency(calcLoanTotals().intr[1]) }}</td>
                                                             <td class="text-end pe-3 text-danger fw-bold" style="font-size: 0.75rem;">{{ formatCurrency(calcLoanTotals().intr[2]) }}</td>
                                                         </tr>
                                                     </tbody>
                                                 </table>
                                             </div>
                                         </div>
                                    </div>
                                </div>
                             </div>
                            
                            <!-- 6. General Expenses -->
                            <div class="accordion-item border-0 mb-3 shadow-sm rounded-3 overflow-hidden">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExpense">
                                        <span class="section-badge">6Îã®Í≥Ñ</span> Í≤ΩÎπÑ Í≥ÑÌöç (ÌåêÍ¥ÄÎπÑ/Ï†úÏ°∞Í≤ΩÎπÑ)
                                    </button>
                                </h2>
                                <div id="collapseExpense" class="accordion-collapse collapse" data-bs-parent="#expertAccordion">
                                    <div class="accordion-body bg-light">
                                         <h6 class="small text-muted fw-bold mb-3">Ï†úÏ°∞Í≤ΩÎπÑ (ÏÉùÏÇ∞ Í¥ÄÎ†®)</h6>
                                         <div class="table-responsive mb-4">
                                             <table class="table table-sm small align-middle bg-white rounded shadow-sm border">
                                                 <thead class="table-light">
                                                     <tr class="text-center">
                                                         <th width="20%">Ìï≠Î™©Î™Ö</th>
                                                         <th width="15%">Í∏∞Ï§ÄÌï≠Î™©</th>
                                                         <th width="25%">Ï†ÅÏö©Í∞í (Ïõê/%)</th>
                                                         <th width="18%">Ïõî ÏòàÏÉÅÏï°</th>
                                                         <th width="18%">Ïó∞Í∞Ñ Ï¥ùÍ≥Ñ</th>
                                                         <th width="4%"></th>
                                                     </tr>
                                                 </thead>
                                                 <tbody>
                                                     <tr v-for="(exp, idx) in expertData.expense.production" :key="'expP'+idx">
                                                         <td class="fw-bold ps-2">{{ exp.expenseTitle }}</td>
                                                         <td class="text-center small text-muted">
                                                             {{ mfgExpMapping.find(m => m.title === exp.expenseTitle)?.baseName || 'Í∏∞ÌÉÄ' }}
                                                         </td>
                                                         <td>
                                                             <div class="input-group input-group-sm">
                                                                 <template v-if="!mfgExpMapping.find(m => m.title === exp.expenseTitle) || mfgExpMapping.find(m => m.title === exp.expenseTitle).baseType === 'fixed'">
                                                                     <input type="number" class="form-control text-end" v-model.number="exp.expenseTVaAmt" placeholder="Í∏àÏï°">
                                                                     <span class="input-group-text px-1" style="font-size: 0.65rem;">Ïõê</span>
                                                                 </template>
                                                                 <template v-else>
                                                                     <input type="number" step="0.1" class="form-control text-end" v-model.number="exp.expenseTVa" placeholder="ÎπÑÏú®">
                                                                     <span class="input-group-text px-1" style="font-size: 0.65rem;">%</span>
                                                                 </template>
                                                             </div>
                                                             <div v-if="mfgExpMapping.find(m => m.title === exp.expenseTitle) && mfgExpMapping.find(m => m.title === exp.expenseTitle).baseType !== 'fixed'" class="text-end text-muted" style="font-size: 0.6rem; margin-top: 1px;">
                                                                 Í∏∞Ï§Ä: {{ formatCurrency(Math.round(exp.expenseTVaAmt/12)) }} /Ïõî
                                                             </div>
                                                         </td>
                                                         <td class="text-end pe-2 fw-bold text-primary">{{ formatCurrency(exp.expenseAmt[0] || 0) }}</td>
                                                         <td class="text-end pe-2 small">{{ formatCurrency(exp.expenseAmtYear[0] || 0) }}</td>
                                             </table>
                                         </div>
                                         <p class="small text-muted mb-4"><i class="bi bi-info-circle me-1"></i>Ï†úÏ°∞Í≤ΩÎπÑ Ìï≠Î™©ÏùÄ ÌëúÏ§ÄÌôîÎêòÏñ¥ ÏûàÏúºÎ©∞, Í∞íÏù¥ 0Ïù∏ Ìï≠Î™©ÏùÄ Ï†ÄÏû• Ïãú Ï†úÏô∏Îê©ÎãàÎã§.</p>

                                         <h6 class="small text-muted fw-bold mb-2">ÌåêÎß§Í¥ÄÎ¶¨ÎπÑ (ÏòÅÏóÖ/ÏùºÎ∞ò Í¥ÄÎ†®)</h6>
                                         <div v-for="(exp, idx) in expertData.expense.sales" :key="'expS'+idx" class="card mb-2 border-0 bg-white p-2">
                                             <div class="d-flex justify-content-between mb-1">
                                                  <input type="text" class="form-control form-control-sm border-0 fw-bold p-0" v-model="exp.expenseTitle" placeholder="Ìï≠Î™©Î™Ö" style="width: 80%">
                                                  <button class="btn-close small" @click="expertData.expense.sales.splice(idx,1)"></button>
                                             </div>
                                             <div class="row g-2 align-items-center">
                                                 <div class="col-8">
                                                     <div class="input-group input-group-sm">
                                                         <input type="number" class="form-control" v-model.number="exp.expenseTVaAmt" placeholder="ÏõîÍ∞Ñ ÎπÑÏö©">
                                                         <span class="input-group-text">Ïõê</span>
                                                     </div>
                                                 </div>
                                             </div>
                                         </div>
                                         <button class="btn btn-sm btn-light w-100 border" @click="addExpense(expertData.expense.sales)">+ ÌåêÎß§Í¥ÄÎ¶¨ÎπÑ Ï∂îÍ∞Ä</button>
                                    </div>
                                </div>
                            </div>
                        </div> <!-- End Accordion -->
                    </div>

                    <!-- Right: Dashboard -->
                    <div class="col-lg-5">
                        <div class="sticky-top" style="top: 20px; z-index: 900;">
                             <div class="card-expert bg-white shadow-lg border-0" style="border: 2px solid var(--primary-color);">
                                <div class="expert-header bg-white">
                                    <h5 class="text-primary fw-bold">üìà ÏàòÏùµÏÑ± Î∂ÑÏÑù Î¶¨Ìè¨Ìä∏</h5>
                                    <button class="btn btn-premium btn-sm py-1 px-3" @click="saveExpertReport" :disabled="isSaving">
                                        {{ isSaving ? 'Ï†ÄÏû• Ï§ë...' : 'Î¶¨Ìè¨Ìä∏ Ï†ÄÏû•' }}
                                    </button>
                                </div>
                                <div class="expert-body">
                                    <!-- Key Metrics -->
                                    <div class="row text-center mb-4">
                                        <div class="col-6 mb-3">
                                            <small class="text-muted d-block text-uppercase" style="font-size: 0.7rem;">Ïõî ÏòàÏÉÅ Îß§Ï∂ú</small>
                                            <span class="fs-4 fw-bold text-dark">{{ formatCurrency(expertResult.totalRevenue) }}</span>
                                            <div class="small text-muted clickable-link" @click="showProjectionModal = true" style="font-size: 0.65rem; cursor: pointer; text-decoration: underline;">
                                                Ïó∞Í∞Ñ: {{ formatCurrency(expertResult.yearlySales) }} (ÏÉÅÏÑ∏Î≥¥Í∏∞)
                                            </div>
                                        </div>
                                        <div class="col-6 mb-3">
                                            <small class="text-muted d-block text-uppercase" style="font-size: 0.7rem;">ÏòÅÏóÖÏù¥Ïùµ</small>
                                            <span class="fs-4 fw-bold" :class="expertResult.opIncome >= 0 ? 'text-primary' : 'text-danger'">{{ formatCurrency(expertResult.opIncome) }}</span>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted d-block text-uppercase" style="font-size: 0.7rem;">ÏòÅÏóÖ Ïù¥ÏùµÎ•†</small>
                                            <span class="fs-5 fw-bold text-dark">{{ expertResult.opMargin }}%</span>
                                        </div>
                                        <div class="col-6">
                                             <small class="text-muted d-block text-uppercase" style="font-size: 0.7rem;">Î™©Ìëú Îã¨ÏÑ±</small>
                                              <span class="badge rounded-pill" :class="expertResult.targetGap >= 0 ? 'bg-success' : 'bg-warning text-dark'">
                                                {{ expertResult.targetGap >= 0 ? 'Îã¨ÏÑ±' : 'ÎØ∏Îã¨' }}
                                              </span>
                                        </div>
                                    </div>
                                    
                                    <hr class="my-4" style="opacity: 0.1">

                                    <!-- Cost Breakdown Table -->
                                    <table class="table table-sm table-borderless small mb-4">
                                        <tbody>
                                            <tr>
                                                <td class="text-muted" @click="showMaterialModal = true" style="cursor: pointer;">
                                                    (-) Ïû¨Î£åÎπÑ (COGS) <span class="small text-primary" style="text-decoration: underline;">(ÏÉÅÏÑ∏)</span>
                                                </td>
                                                <td class="text-end fw-bold">{{ formatCurrency(expertResult.totalMaterialCost) }}</td>
                                                <td class="text-end text-muted" style="width: 40px">{{ expertResult.materialRatio }}%</td>
                                            </tr>
                                             <tr>
                                                <td class="text-muted clickable-link" @click="showLaborModal = true" style="cursor: pointer;">
                                                    (-) Ïù∏Í±¥ÎπÑ <span class="small text-primary" style="text-decoration: underline;">(ÏÉÅÏÑ∏)</span>
                                                </td>
                                                <td class="text-end fw-bold">{{ formatCurrency(expertResult.totalLaborCost) }}</td>
                                                <td class="text-end text-muted">{{ expertResult.laborRatio }}%</td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">(-) ÌåêÍ¥ÄÎπÑ/Í≤ΩÎπÑ</td>
                                                <td class="text-end fw-bold">{{ formatCurrency(expertResult.totalExpense) }}</td>
                                                <td class="text-end text-muted">{{ expertResult.expenseRatio }}%</td>
                                            </tr>
                                             <tr>
                                                <td class="text-muted ps-3 fst-italic">„Ñ¥ Ïù¥Ïûê/Í∞êÍ∞ÄÏÉÅÍ∞Å Ìè¨Ìï®</td>
                                                <td></td>
                                                <td></td>
                                            </tr>
                                        </tbody>
                                        <tfoot class="border-top">
                                            <tr>
                                                <td class="pt-2 fw-bold">(=) ÏòÅÏóÖÏù¥Ïùµ</td>
                                                <td class="pt-2 text-end fw-bold fs-6" :class="expertResult.opIncome >= 0 ? 'text-primary' : 'text-danger'">
                                                    {{ formatCurrency(expertResult.opIncome) }}
                                                </td>
                                                <td></td>
                                            </tr>
                                        </tfoot>
                                    </table>

                                    <!-- BEP Analysis -->
                                    <div class="card bg-warning-subtle border-0 p-3 mb-3">
                                        <h6 class="fw-bold mb-2 text-warning-emphasis">‚öñÔ∏è ÏÜêÏùµÎ∂ÑÍ∏∞Ï†ê (BEP) Î∂ÑÏÑù</h6>
                                        <div class="d-flex justify-content-between mb-1 small">
                                            <span>BEP Îß§Ï∂úÏï°</span>
                                            <span class="fw-bold">{{ formatCurrency(expertResult.bepRevenue) }}</span>
                                        </div>
                                        <div class="d-flex justify-content-between small">
                                            <span>Í≥†Ï†ïÎπÑ Ìï©Í≥Ñ</span>
                                            <span>{{ formatCurrency(expertResult.totalFixedCost) }}</span>
                                        </div>
                                        <div class="progress mt-2" style="height: 6px;">
                                            <div class="progress-bar bg-warning" role="progressbar" :style="{ width: Math.min(100, (expertResult.totalRevenue / expertResult.bepRevenue) * 100) + '%' }"></div>
                                        </div>
                                        <div class="text-center mt-1" style="font-size: 0.7rem;">
                                            ÌòÑÏû¨ BEPÏùò <strong>{{ Math.round((expertResult.totalRevenue / expertResult.bepRevenue) * 100) || 0 }}%</strong> Îã¨ÏÑ±
                                        </div>
                                    </div>
                                    
                                    <!-- Diagnosis Report (New) -->
                                    <div class="card border-0 bg-light p-3 mb-3">
                                        <h6 class="fw-bold mb-3 small text-primary">üìä Í≤ΩÏòÅ ÏßÑÎã® Î¶¨Ìè¨Ìä∏</h6>
                                        <div v-for="(diag, dIdx) in expertResult.diagnosis" :key="dIdx" class="d-flex justify-content-between align-items-center mb-2 border-bottom pb-2">
                                            <div>
                                                <span class="d-block small fw-bold">{{ diag.label }}</span>
                                                <small class="text-muted" style="font-size: 0.7rem">{{ diag.msg }}</small>
                                            </div>
                                            <div class="text-end">
                                                <span class="d-block fw-bold" :class="diag.pass ? 'text-success' : 'text-danger'">{{ diag.value }}</span>
                                                <span class="badge" :class="diag.pass ? 'bg-success-subtle text-success' : 'bg-danger-subtle text-danger'" style="font-size: 0.6rem">{{ diag.pass ? 'Ï†ÅÏ†ï' : 'Ï£ºÏùò' }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Action Guide -->
                                    <div class="alert alert-light border small text-muted mb-0">
                                        <strong class="d-block mb-1 text-dark">üí° AI Î∂ÑÏÑù ÏΩîÎ©òÌä∏</strong>
                                        <span v-if="expertResult.targetGap < 0">
                                            Î™©Ìëú Ïù¥ÏùµÍπåÏßÄ <strong>{{ formatCurrency(Math.abs(expertResult.targetGap)) }}</strong> ÎÇ®ÏïòÏäµÎãàÎã§. 
                                            Í≥†Ï†ïÎπÑ ÎπÑÏ§ëÏù¥ {{ expertResult.totalRevenue ? ((expertResult.totalFixedCost / expertResult.totalRevenue)*100).toFixed(1) : 0 }}% ÏûÖÎãàÎã§.
                                        </span>
                                        <span v-else>
                                            Î™©ÌëúÎ•º Îã¨ÏÑ±ÌñàÏäµÎãàÎã§! (Ï¥àÍ≥ºÎã¨ÏÑ±: {{ formatCurrency(expertResult.targetGap) }})
                                        </span>
                                    </div>

                                </div>
                             </div>
                        </div>
                    </div>
                </div>
            </div> <!-- End Expert -->

        <!-- Reports List (Common) -->
        <hr class="my-5" style="opacity: 0.1">
        <div class="card-expert">
            <div class="expert-header">
                <h5>üóÇÔ∏è Ï†ÄÏû•Îêú Î¶¨Ìè¨Ìä∏ Ïù¥Î†•</h5>
            </div>
            <div class="card-body p-0 table-responsive">
                <table class="table table-hover table-premium mb-0">
                    <thead>
                        <tr>
                            <th class="ps-4">No.</th>
                            <th>Íµ¨Î∂Ñ</th>
                            <th>Îß§Ï∂úÏï°</th>
                            <th>ÏòÅÏóÖÏù¥Ïùµ</th>
                            <th>BEP</th>
                            <th>ÏûëÏÑ±ÏùºÏãú</th>
                            <th>Ïï°ÏÖò</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="rpt in reports" :key="rpt.id">
                            <td class="ps-4 text-muted small">#{{ rpt.id }}</td>
                            <td><span class="badge" :class="getReportValues(rpt).mode === 'expert' ? 'bg-secondary' : 'bg-success'">{{ getReportValues(rpt).mode === 'expert' ? 'Ï†ÑÎ¨∏Í∞Ä' : 'Í∞ÑÌé∏' }}</span></td>
                            <td>{{ formatCurrency(getReportValues(rpt).revenue) }}</td>
                            <td :class="getReportValues(rpt).netProfit >= 0 ? 'text-primary fw-bold' : 'text-danger fw-bold'">{{ formatCurrency(getReportValues(rpt).netProfit) }}</td>
                            <td class="text-muted small">{{ getReportValues(rpt).bep ? formatCurrency(getReportValues(rpt).bep) : '-' }}</td>
                            <td class="text-muted small">{{ formatDate(rpt.createdAt) }}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-secondary me-1" @click="loadReportToCanvas(rpt)">Î∂àÎü¨Ïò§Í∏∞</button>
                                <button class="btn btn-sm btn-outline-danger" @click="deleteReport(rpt.id)">ÏÇ≠Ï†ú</button>
                            </td>
                        </tr>
                        <tr v-if="reports.length === 0">
                            <td colspan="7" class="text-center py-5 text-muted">Ï†ÄÏû•Îêú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- Projection Detail Modal (Advanced Layout) -->
    <div v-if="showProjectionModal" class="modal-backdrop fade show"></div>
    <div v-if="showProjectionModal" class="modal fade show d-block" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable"> <!-- Changed to XL -->
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">üìä ÏòàÏÉÅ Îß§Ï∂ú ÏÉÅÏÑ∏ (Revenue Projection)</h5>
                    <button type="button" class="btn-close" @click="showProjectionModal = false"></button>
                </div>
                <div class="modal-body bg-light">
                    
                    <!-- Top Summary Card (Inside Modal) -->
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-body bg-white py-3">
                            <h5 class="fw-bold mb-3 border-bottom pb-2">ÏòàÏÉÅ Îß§Ï∂úÏï° ÏöîÏïΩ</h5>
                            <div class="row text-center">
                                <div class="col-4 border-end">
                                    <small class="text-muted d-block">Ïùº ÏòàÏÉÅ Îß§Ï∂úÏï°</small>
                                    <strong class="fs-5">{{ formatCurrency((expertResult.totalRevenue || 0) / (expertData?.basic?.workDay || 25)) }}</strong>
                                </div>
                                <div class="col-4 border-end">
                                    <small class="text-muted d-block">Ïõî ÏòàÏÉÅ Îß§Ï∂úÏï°</small>
                                    <strong class="fs-5">{{ formatCurrency(expertResult.totalRevenue || 0) }}</strong>
                                </div>
                                <div class="col-4">
                                    <small class="text-muted d-block">1Ï∞®ÎÖÑÎèÑ Ïó∞ ÏòàÏÉÅ Îß§Ï∂úÏï°</small>
                                    <strong class="fs-5 text-primary">{{ formatCurrency((expertResult.totalRevenue || 0) * 12) }}</strong> 
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabs for Monthly vs Yearly -->
                    <ul class="nav nav-tabs mb-3" id="projTabs">
                        <li class="nav-item">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabMonthly" type="button">1Ï∞®ÎÖÑÎèÑ ÏõîÎ≥Ñ ÏÉÅÏÑ∏ (Monthly)</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabYearly" type="button">3Í∞úÎÖÑ ÏòàÏÉÅ Îß§Ï∂ú (Yearly)</button>
                        </li>
                    </ul>

                    <div class="tab-content" id="projTabContent">
                        
                        <!-- TAB 1: Monthly Table -->
                        <div class="tab-pane fade show active" id="tabMonthly">
                             <div class="card border-0 shadow-sm">
                                <div class="card-body p-0 table-responsive">
                                    <table class="table table-bordered mb-0 text-center align-middle small table-striped">
                                        <thead class="bg-light sticky-top">
                                            <tr>
                                                <th rowspan="1" style="min-width: 40px;">No</th>
                                                <th rowspan="1" style="min-width: 120px;">Î©îÎâ¥Î™Ö</th>
                                                <th rowspan="1" style="min-width: 80px;">Íµ¨Î∂Ñ</th>
                                                <th v-for="n in 12" :key="n" style="min-width: 70px;">{{n}}Ïõî</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <template v-for="(m, idx) in (expertData.sale?.menuM || [])" :key="'mm'+idx">
                                                <!-- Qty -->
                                                <tr>
                                                    <td rowspan="2" class="bg-white">{{ idx + 1 }}</td>
                                                    <td rowspan="2" class="text-start bg-white fw-bold">
                                                        {{ expertData.sale?.menu?.[idx]?.menuTitle }}
                                                        <div class="small fw-normal text-muted">{{ formatCurrency(expertData.sale?.menu?.[idx]?.menuPrice) }}</div>
                                                    </td>
                                                    <td class="bg-light">ÌåêÎß§ÏàòÎüâ</td>
                                                    <td v-for="q in (m.menuQty || [])" class="text-end pe-2">{{ formatNumber(q) }}</td>
                                                </tr>
                                                <!-- Amt -->
                                                <tr>
                                                    <td class="bg-light text-primary">ÌåêÎß§Í∏àÏï°</td>
                                                    <td v-for="a in (m.menuAmt || [])" class="text-end pe-2">{{ formatNumber(a/1000) }}</td>
                                                </tr>
                                            </template>
                                             <!-- Footer -->
                                            <tr class="table-secondary fw-bold border-top-2">
                                                <td colspan="2" rowspan="2">Ìï©Í≥Ñ</td>
                                                <td>ÌåêÎß§ÏàòÎüâ</td>
                                                <td v-for="n in 12" class="text-end pe-2">{{ formatNumber(sumArrayIdx(expertData.sale.menuM, 'menuQty', n-1)) }}</td>
                                            </tr>
                                            <tr class="table-secondary fw-bold">
                                                 <td>ÌåêÎß§Í∏àÏï°</td>
                                                 <td v-for="n in 12" class="text-end pe-2">{{ formatNumber(sumArrayIdx(expertData.sale.menuM, 'menuAmt', n-1)/1000) }}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- TAB 2: Yearly Table -->
                        <div class="tab-pane fade" id="tabYearly">
                            <div class="card border-0 shadow-sm">
                                <div class="card-body p-0 table-responsive">
                                    <table class="table table-bordered mb-0 text-center align-middle small table-hover">
                                        <thead class="bg-light">
                                            <tr>
                                                <th width="3%">No</th>
                                                <th width="15%">Î©îÎâ¥Î™Ö/Î©îÎâ¥Í∞ÄÍ≤©</th>
                                                <th width="8%">ÎÇ¥Ïö©</th>
                                                <th>1Ï∞®ÎÖÑÎèÑ</th>
                                                <th>2Ï∞®ÎÖÑÎèÑ</th>
                                                <th>3Ï∞®ÎÖÑÎèÑ</th>
                                                <th width="5%">ÏàòÏ†ï</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <template v-for="(m, idx) in (expertData.sale?.menuY || [])" :key="'y'+idx">
                                                <!-- Row 1: Qty -->
                                                <tr>
                                                    <td rowspan="3" class="bg-white">{{ idx + 1 }}</td>
                                                    <td class="text-start fw-bold bg-white bottom-border-0">
                                                        {{ expertData.sale?.menu?.[idx]?.menuTitle }}
                                                    </td>
                                                    <td class="bg-light">ÌåêÎß§ÏàòÎüâ</td>
                                                    <td class="text-end pe-2">{{ formatNumber(m.menuQty?.[0] || 0) }}</td>
                                                    <td class="text-end pe-2">{{ formatNumber(m.menuQty?.[1] || 0) }}</td>
                                                    <td class="text-end pe-2">{{ formatNumber(m.menuQty?.[2] || 0) }}</td>
                                                    <td rowspan="3">
                                                        <!-- Updated to open new Yearly Modal -->
                                                        <button class="btn btn-xs btn-outline-secondary" @click="openYearlyModal(idx)">ÏàòÏ†ï</button>
                                                    </td>
                                                </tr>
                                                <!-- Row 2: Price -->
                                                <tr>
                                                    <td class="text-start text-muted bg-white border-top-0 border-bottom-0 pb-0 pt-0">
                                                        {{ formatCurrency(expertData.sale?.menu?.[idx]?.menuPrice) }}
                                                    </td>
                                                    <td class="bg-light">ÌåêÎß§Îã®Í∞Ä</td>
                                                    <td class="text-end pe-2">{{ formatNumber(m.menuPrice?.[0] || 0) }}</td>
                                                    <td class="text-end pe-2">{{ formatNumber(m.menuPrice?.[1] || 0) }}</td>
                                                    <td class="text-end pe-2">{{ formatNumber(m.menuPrice?.[2] || 0) }}</td>
                                                </tr>
                                                <!-- Row 3: Amount -->
                                                <tr>
                                                    <td class="bg-white border-top-0"></td>
                                                    <td class="bg-light">ÌåêÎß§Í∏àÏï°</td>
                                                    <td class="fw-bold bg-info-subtle text-end pe-2">{{ formatNumber(Math.round((m.menuAmt?.[0] || 0)/1000)) }}</td>
                                                    <td class="fw-bold bg-info-subtle text-end pe-2">{{ formatNumber(Math.round((m.menuAmt?.[1] || 0)/1000)) }}</td>
                                                    <td class="fw-bold bg-info-subtle text-end pe-2">{{ formatNumber(Math.round((m.menuAmt?.[2] || 0)/1000)) }}</td>
                                                </tr>
                                            </template>
                                            
                                            <!-- Total Footer -->
                                            <tr class="table-secondary fw-bold">
                                                <td colspan="2" rowspan="2">Ìï©Í≥Ñ</td>
                                                <td>ÌåêÎß§ÏàòÎüâ</td>
                                                <!-- Sum Y1 Qty -->
                                                <td class="text-end pe-2">{{ formatNumber(sumArrayIdx(expertData.sale?.menuY, 'menuQty', 0)) }}</td>
                                                <td class="text-end pe-2">{{ formatNumber(sumArrayIdx(expertData.sale?.menuY, 'menuQty', 1)) }}</td>
                                                <td class="text-end pe-2">{{ formatNumber(sumArrayIdx(expertData.sale?.menuY, 'menuQty', 2)) }}</td>
                                                <td rowspan="2"></td>
                                            </tr>
                                            <tr class="table-secondary fw-bold">
                                                <td>ÌåêÎß§Í∏àÏï°</td>
                                                <td class="text-end pe-2">{{ formatNumber(sumArrayIdx(expertData.sale?.menuY, 'menuAmt', 0)/1000) }}</td>
                                                <td class="text-end pe-2">{{ formatNumber(sumArrayIdx(expertData.sale?.menuY, 'menuAmt', 1)/1000) }}</td>
                                                <td class="text-end pe-2">{{ formatNumber(sumArrayIdx(expertData.sale?.menuY, 'menuAmt', 2)/1000) }}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                    </div> <!-- End Tab Content -->
                </div>
                <div class="modal-footer bg-light">
                    <div class="small text-muted me-auto">* Îã®ÏúÑ(Ï≤úÏõê) ÌëúÍ∏∞ Ï∞∏Í≥†</div>
                    <button type="button" class="btn btn-secondary" @click="showProjectionModal = false">Îã´Í∏∞</button>
                </div>
            </div>
        </div>
    </div> <!-- End showProjectionModal -->

    <!-- Material Cost Detail Modal -->
    <div v-if="showMaterialModal" class="modal-backdrop fade show"></div>
    <div v-if="showMaterialModal" class="modal fade show d-block" tabindex="-1" style="z-index: 1055;">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">üìâ Ïû¨Î£åÎπÑ ÏÉÅÏÑ∏ (Material Cost Projection)</h5>
                    <button type="button" class="btn-close" @click="showMaterialModal = false"></button>
                </div>
                <div class="modal-body bg-light">
                    
                    <!-- Top Summary Card -->
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-body bg-white py-3">
                            <h5 class="fw-bold mb-3 border-bottom pb-2">Ïû¨Î£åÎπÑ ÏöîÏïΩ</h5>
                            <div class="row text-center">
                                <div class="col-4 border-end">
                                    <small class="text-muted d-block">Ïõî ÏòàÏÉÅ Ïû¨Î£åÎπÑ</small>
                                    <strong class="fs-5">{{ formatCurrency(expertResult.totalMaterialCost) }}</strong>
                                </div>
                                <div class="col-4 border-end">
                                    <small class="text-muted d-block">Ïû¨Î£åÎπÑÏú®</small>
                                    <strong class="fs-5">{{ expertResult.materialRatio }}%</strong>
                                </div>
                                <div class="col-4">
                                    <small class="text-muted d-block">1Ï∞®ÎÖÑÎèÑ Ïó∞ ÏòàÏÉÅ Ïû¨Î£åÎπÑ</small>
                                    <strong class="fs-5 text-danger">{{ formatCurrency(expertResult.totalMaterialCost * 12) }}</strong> 
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <ul class="nav nav-tabs mb-3" id="matTabs">
                        <li class="nav-item">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabMatMonthly" type="button">1Ï∞®ÎÖÑÎèÑ ÏõîÎ≥Ñ ÏÉÅÏÑ∏ (Monthly)</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabMatYearly" type="button">3Í∞úÎÖÑ ÏòàÏÉÅ Ïû¨Î£åÎπÑ (Yearly)</button>
                        </li>
                    </ul>

                    <div class="tab-content" id="matTabContent">
                        
                        <!-- TAB 1: Monthly -->
                        <div class="tab-pane fade show active" id="tabMatMonthly">
                             <div class="card border-0 shadow-sm">
                                <div class="card-body p-0 table-responsive">
                                    <table class="table table-bordered mb-0 text-center align-middle small table-striped">
                                        <thead class="bg-light sticky-top">
                                            <tr>
                                                <th rowspan="1" style="min-width: 40px;">No</th>
                                                <th rowspan="1" style="min-width: 120px;">Î©îÎâ¥Î™Ö</th>
                                                <th rowspan="1" style="min-width: 60px;">ÎπÑÏú®</th>
                                                <th v-for="n in 12" :key="n" style="min-width: 70px;">{{n}}Ïõî</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <template v-for="(m, idx) in (expertData.cost?.costM || [])" :key="'cm'+idx">
                                                <tr>
                                                    <td class="bg-white">{{ idx + 1 }}</td>
                                                    <td class="text-start bg-white fw-bold">
                                                        {{ expertData.sale?.menu?.[idx]?.menuTitle }}
                                                    </td>
                                                    <td class="text-muted small">{{ expertData.cost?.costRate?.[idx] || 0 }}%</td>
                                                    <td v-for="c in (m.costAmt || [])" class="text-end pe-2">{{ formatNumber(Math.round(c/1000)) }}</td>
                                                </tr>
                                            </template>
                                             <!-- Footer -->
                                            <tr class="table-secondary fw-bold border-top-2">
                                                <td colspan="3">Ìï©Í≥Ñ</td>
                                                <td v-for="n in 12" class="text-end pe-2">{{ formatNumber(Math.round(sumArrayIdx(expertData.cost.costM, 'costAmt', n-1)/1000)) }}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- TAB 2: Yearly -->
                        <div class="tab-pane fade" id="tabMatYearly">
                            <div class="card border-0 shadow-sm">
                                <div class="card-body p-0 table-responsive">
                                    <table class="table table-bordered mb-0 text-center align-middle small table-hover">
                                        <thead class="bg-light">
                                            <tr>
                                                <th width="5%">No</th>
                                                <th width="15%">Î©îÎâ¥Î™Ö</th>
                                                <th width="10%">ÎÇ¥Ïö©</th>
                                                <th>1Ï∞®ÎÖÑÎèÑ</th>
                                                <th>2Ï∞®ÎÖÑÎèÑ</th>
                                                <th>3Ï∞®ÎÖÑÎèÑ</th>
                                                <th width="5%">ÏàòÏ†ï</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <template v-for="(m, idx) in (expertData.cost?.costY || [])" :key="'my'+idx">
                                                <tr>
                                                    <td rowspan="2" class="bg-white">{{ idx + 1 }}</td>
                                                    <td rowspan="2" class="text-start fw-bold bg-white">
                                                        {{ expertData.sale?.menu?.[idx]?.menuTitle }}
                                                    </td>
                                                    <td class="bg-light">Ïû¨Î£åÎπÑÏú®</td>
                                                    <td class="text-center text-muted">
                                                        {{ m.costRate?.[0] ?? expertData.cost?.costRate?.[idx] ?? 0 }}%
                                                    </td>
                                                    <td class="text-center text-muted">
                                                        {{ m.costRate?.[1] ?? expertData.cost?.costRate?.[idx] ?? 0 }}%
                                                    </td>
                                                    <td class="text-center text-muted">
                                                        {{ m.costRate?.[2] ?? expertData.cost?.costRate?.[idx] ?? 0 }}%
                                                    </td>
                                                    
                                                    <td rowspan="2">
                                                        <button class="btn btn-xs btn-outline-secondary" @click="openMaterialYearlyModal(idx)">ÏàòÏ†ï</button>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="bg-light">Ïû¨Î£åÎπÑ</td>
                                                    <td class="fw-bold text-end pe-2">{{ formatNumber(Math.round((m.costAmt?.[0] || 0)/1000)) }}</td>
                                                    <td class="fw-bold text-end pe-2">{{ formatNumber(Math.round((m.costAmt?.[1] || 0)/1000)) }}</td>
                                                    <td class="fw-bold text-end pe-2">{{ formatNumber(Math.round((m.costAmt?.[2] || 0)/1000)) }}</td>
                                                </tr>
                                            </template>
                                            
                                            <!-- Total Footer -->
                                            <tr class="table-secondary fw-bold">
                                                <td colspan="3">Ìï©Í≥Ñ (Ïû¨Î£åÎπÑ)</td>
                                                <td class="text-end pe-2">{{ formatNumber(Math.round(sumArrayIdx(expertData.cost?.costY, 'costAmt', 0)/1000)) }}</td>
                                                <td class="text-end pe-2">{{ formatNumber(Math.round(sumArrayIdx(expertData.cost?.costY, 'costAmt', 1)/1000)) }}</td>
                                                <td class="text-end pe-2">{{ formatNumber(Math.round(sumArrayIdx(expertData.cost?.costY, 'costAmt', 2)/1000)) }}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                    </div> <!-- End Tab Content -->
                </div>
                <div class="modal-footer bg-light">
                    <div class="small text-muted me-auto">* Îã®ÏúÑ(Ï≤úÏõê) ÌëúÍ∏∞ Ï∞∏Í≥†</div>
                    <button type="button" class="btn btn-secondary" @click="showMaterialModal = false">Îã´Í∏∞</button>
                </div>
            </div>
        </div>
    </div> <!-- End showMaterialModal -->

    <!-- Labor Cost Detail Modal -->
    <div v-if="showLaborModal" class="modal-backdrop fade show"></div>
    <div v-if="showLaborModal" class="modal fade show d-block" tabindex="-1" style="z-index: 1055;">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">üë• ÏòàÏÉÅ Ïù∏Í±¥ÎπÑ ÏÉÅÏÑ∏ (Labor Cost Projection)</h5>
                    <button type="button" class="btn-close" @click="showLaborModal = false"></button>
                </div>
                <div class="modal-body bg-light">
                    
                    <!-- Top Summary Card -->
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-body bg-white py-3">
                            <h5 class="fw-bold mb-3 border-bottom pb-2">Ïù∏Í±¥ÎπÑ ÏöîÏïΩ</h5>
                            <div class="row text-center">
                                <div class="col-6 border-end">
                                    <small class="text-muted d-block">Ïõî ÏòàÏÉÅ Ïù∏Í±¥ÎπÑ</small>
                                    <strong class="fs-5">{{ formatCurrency(expertResult.totalLaborCost) }}</strong>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted d-block">1Ï∞®ÎÖÑÎèÑ Ïó∞ ÏòàÏÉÅ Ïù∏Í±¥ÎπÑ</small>
                                    <strong class="fs-5 text-danger">{{ formatCurrency(expertResult.totalLaborCost * 12) }}</strong> 
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <ul class="nav nav-tabs mb-3" id="laborTabs">
                        <li class="nav-item">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabLaborMonthly" type="button">1Ï∞®ÎÖÑÎèÑ ÏõîÎ≥Ñ ÏÉÅÏÑ∏ (Monthly)</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabLaborYearly" type="button">3Í∞úÎÖÑ ÏòàÏÉÅ Ïù∏Í±¥ÎπÑ (Yearly)</button>
                        </li>
                    </ul>

                    <div class="tab-content">
                        
                        <!-- TAB 1: Monthly -->
                        <div class="tab-pane fade show active" id="tabLaborMonthly">
                             <div class="card border-0 shadow-sm">
                                <div class="card-body p-0 table-responsive">
                                    <table class="table table-bordered mb-0 text-center align-middle small table-striped">
                                        <thead class="bg-light sticky-top">
                                            <tr>
                                                <th>Íµ¨Î∂Ñ</th>
                                                <th>ÏßÅÏúÑ(Î∂ÄÎ∂Ñ)</th>
                                                <th>Ïù∏Ïõê</th>
                                                <th v-for="n in 12" :key="n" style="min-width: 70px;">{{n}}Ïõî</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Mfg -->
                                            <template v-for="(j, idx) in (expertData.job?.production || [])" :key="'mfgM'+idx">
                                                <tr>
                                                    <td class="bg-white">Ï†úÏ°∞</td>
                                                    <td class="text-start bg-white fw-bold">{{ j.jobTitle }}</td>
                                                    <td>{{ j.jobCnt }}</td>
                                                    <td v-for="amt in (j.jobAmt || [])" class="text-end pe-2">{{ formatNumber(Math.round(amt/1000)) }}</td>
                                                </tr>
                                            </template>
                                            <tr class="table-light italic small" v-if="(expertData.job?.production || []).length > 0">
                                                <td colspan="2">Ï†úÏ°∞ ÏÜåÍ≥Ñ</td>
                                                <td>{{ expertData.job.production.reduce((s,c)=>s+(c.jobCnt||0), 0) }}</td>
                                                <td v-for="n in 12" class="text-end pe-2">{{ formatNumber(Math.round(sumArrayIdx(expertData.job.production, 'jobAmt', n-1)/1000)) }}</td>
                                            </tr>

                                            <!-- Sales -->
                                            <template v-for="(j, idx) in (expertData.job?.sales || [])" :key="'salesM'+idx">
                                                <tr>
                                                    <td class="bg-white">ÌåêÎß§</td>
                                                    <td class="text-start bg-white fw-bold">{{ j.jobTitle }}</td>
                                                    <td>{{ j.jobCnt }}</td>
                                                    <td v-for="amt in (j.jobAmt || [])" class="text-end pe-2">{{ formatNumber(Math.round(amt/1000)) }}</td>
                                                </tr>
                                            </template>
                                            <tr class="table-light italic small" v-if="(expertData.job?.sales || []).length > 0">
                                                <td colspan="2">ÌåêÎß§ ÏÜåÍ≥Ñ</td>
                                                <td>{{ expertData.job.sales.reduce((s,c)=>s+(c.jobCnt||0), 0) }}</td>
                                                <td v-for="n in 12" class="text-end pe-2">{{ formatNumber(Math.round(sumArrayIdx(expertData.job.sales, 'jobAmt', n-1)/1000)) }}</td>
                                            </tr>

                                             <!-- Total Footer -->
                                            <tr class="table-secondary fw-bold">
                                                <td colspan="2">Ìï©Í≥Ñ</td>
                                                <td>{{ (expertData.job?.production || []).reduce((s,c)=>s+(c.jobCnt||0), 0) + (expertData.job?.sales || []).reduce((s,c)=>s+(c.jobCnt||0), 0) }}</td>
                                                <td v-for="n in 12" class="text-end pe-2">{{ formatNumber(Math.round((sumArrayIdx(expertData.job.production, 'jobAmt', n-1) + sumArrayIdx(expertData.job.sales, 'jobAmt', n-1))/1000)) }}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- TAB 2: Yearly -->
                        <div class="tab-pane fade" id="tabLaborYearly">
                            <div class="card border-0 shadow-sm">
                                <div class="card-body p-0 table-responsive">
                                    <table class="table table-bordered mb-0 text-center align-middle small table-hover">
                                        <thead class="bg-light">
                                            <tr>
                                                <th width="10%">Íµ¨Î∂Ñ</th>
                                                <th width="30%">ÏßÅÏúÑ(Î∂ÄÎ∂Ñ)</th>
                                                <th width="10%">Ïù∏Ïõê</th>
                                                <th>1Ï∞®ÎÖÑÎèÑ</th>
                                                <th>2Ï∞®ÎÖÑÎèÑ</th>
                                                <th>3Ï∞®ÎÖÑÎèÑ</th>
                                                <th width="10%">ÏàòÏ†ï</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                             <!-- Mfg -->
                                             <template v-for="(j, idx) in expertData.job.production" :key="'mfgY'+idx">
                                                <tr>
                                                    <td>Ï†úÏ°∞</td>
                                                    <td class="text-start fw-bold bg-white">{{ j.jobTitle }}</td>
                                                    <td>{{ j.jobCnt }}</td>
                                                    <td class="text-end pe-2">{{ formatNumber(Math.round((j.jobAmtYear?.[0]||0)/1000)) }}</td>
                                                    <td class="text-end pe-2">{{ formatNumber(Math.round((j.jobAmtYear?.[1]||0)/1000)) }}</td>
                                                    <td class="text-end pe-2">{{ formatNumber(Math.round((j.jobAmtYear?.[2]||0)/1000)) }}</td>
                                                    <td>
                                                        <button class="btn btn-xs btn-outline-secondary" @click="openLaborYearlyModal(idx, 'mfg')">ÏàòÏ†ï</button>
                                                    </td>
                                                </tr>
                                             </template>
                                             <tr class="table-light italic small" v-if="expertData.job.production.length > 0">
                                                 <td colspan="2">Ï†úÏ°∞ ÏÜåÍ≥Ñ</td>
                                                 <td>{{ expertData.job.production.reduce((s,c)=>s+(c.jobCnt||0), 0) }}</td>
                                                 <td class="text-end pe-2">{{ formatNumber(Math.round(sumArrayIdx(expertData.job.production, 'jobAmtYear', 0)/1000)) }}</td>
                                                 <td class="text-end pe-2">{{ formatNumber(Math.round(sumArrayIdx(expertData.job.production, 'jobAmtYear', 1)/1000)) }}</td>
                                                 <td class="text-end pe-2">{{ formatNumber(Math.round(sumArrayIdx(expertData.job.production, 'jobAmtYear', 2)/1000)) }}</td>
                                                 <td></td>
                                             </tr>

                                             <!-- Sales -->
                                             <template v-for="(j, idx) in expertData.job.sales" :key="'salesY'+idx">
                                                <tr>
                                                    <td>ÌåêÎß§</td>
                                                    <td class="text-start fw-bold bg-white">{{ j.jobTitle }}</td>
                                                    <td>{{ j.jobCnt }}</td>
                                                    <td class="text-end pe-2">{{ formatNumber(Math.round((j.jobAmtYear?.[0]||0)/1000)) }}</td>
                                                    <td class="text-end pe-2">{{ formatNumber(Math.round((j.jobAmtYear?.[1]||0)/1000)) }}</td>
                                                    <td class="text-end pe-2">{{ formatNumber(Math.round((j.jobAmtYear?.[2]||0)/1000)) }}</td>
                                                    <td>
                                                        <button class="btn btn-xs btn-outline-secondary" @click="openLaborYearlyModal(idx, 'sales')">ÏàòÏ†ï</button>
                                                    </td>
                                                </tr>
                                             </template>
                                             <tr class="table-light italic small" v-if="expertData.job.sales.length > 0">
                                                 <td colspan="2">ÌåêÎß§ ÏÜåÍ≥Ñ</td>
                                                 <td>{{ expertData.job.sales.reduce((s,c)=>s+(c.jobCnt||0), 0) }}</td>
                                                 <td class="text-end pe-2">{{ formatNumber(Math.round(sumArrayIdx(expertData.job.sales, 'jobAmtYear', 0)/1000)) }}</td>
                                                 <td class="text-end pe-2">{{ formatNumber(Math.round(sumArrayIdx(expertData.job.sales, 'jobAmtYear', 1)/1000)) }}</td>
                                                 <td class="text-end pe-2">{{ formatNumber(Math.round(sumArrayIdx(expertData.job.sales, 'jobAmtYear', 2)/1000)) }}</td>
                                                 <td></td>
                                             </tr>
                                             
                                             <!-- Total Footer -->
                                             <tr class="table-secondary fw-bold">
                                                 <td colspan="2">Ìï©Í≥Ñ</td>
                                                 <td>{{ expertData.job.production.reduce((s,c)=>s+(c.jobCnt||0), 0) + expertData.job.sales.reduce((s,c)=>s+(c.jobCnt||0), 0) }}</td>
                                                 <td class="text-end pe-2">{{ formatNumber(Math.round((sumArrayIdx(expertData.job.production, 'jobAmtYear', 0) + sumArrayIdx(expertData.job.sales, 'jobAmtYear', 0))/1000)) }}</td>
                                                 <td class="text-end pe-2">{{ formatNumber(Math.round((sumArrayIdx(expertData.job.production, 'jobAmtYear', 1) + sumArrayIdx(expertData.job.sales, 'jobAmtYear', 1))/1000)) }}</td>
                                                 <td class="text-end pe-2">{{ formatNumber(Math.round((sumArrayIdx(expertData.job.production, 'jobAmtYear', 2) + sumArrayIdx(expertData.job.sales, 'jobAmtYear', 2))/1000)) }}</td>
                                                 <td></td>
                                             </tr>

                                             <!-- KPI Rows -->
                                             <tr class="fw-bold">
                                                 <td colspan="3" class="bg-light">Ïù∏Í±¥ÎπÑ ÎπÑÏú®</td>
                                                 <td v-for="k in [0,1,2]" class="text-end pe-2 text-danger">
                                                     {{ ((sumArrayIdx(expertData.job.production, 'jobAmtYear', k) + sumArrayIdx(expertData.job.sales, 'jobAmtYear', k)) / (sumArrayIdx(expertData.sale.menuY, 'menuAmt', k) || 1) * 100).toFixed(1) }}%
                                                 </td>
                                                 <td></td>
                                             </tr>
                                             <tr class="fw-bold">
                                                 <td colspan="3" class="bg-light">1Ïù∏Îãπ Îß§Ï∂úÏï°(Ï≤úÏõê)</td>
                                                 <td v-for="k in [0,1,2]" class="text-end pe-2 text-danger">
                                                     {{ formatNumber(Math.round(sumArrayIdx(expertData.sale.menuY, 'menuAmt', k) / (expertData.job.production.reduce((s,c)=>s+(c.jobCnt||0), 0) + expertData.job.sales.reduce((s,c)=>s+(c.jobCnt||0), 0) || 1) / 1000)) }}
                                                 </td>
                                                 <td></td>
                                             </tr>
                                             <tr class="fw-bold">
                                                 <td colspan="3" class="bg-light">1Ïù∏Îãπ Ïù∏Í±¥ÎπÑ(Ï≤úÏõê)</td>
                                                 <td v-for="k in [0,1,2]" class="text-end pe-2 text-danger">
                                                     {{ formatNumber(Math.round((sumArrayIdx(expertData.job.production, 'jobAmtYear', k) + sumArrayIdx(expertData.job.sales, 'jobAmtYear', k)) / (expertData.job.production.reduce((s,c)=>s+(c.jobCnt||0), 0) + expertData.job.sales.reduce((s,c)=>s+(c.jobCnt||0), 0) || 1) / 1000)) }}
                                                 </td>
                                                 <td></td>
                                             </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                    </div> <!-- End Tab Content -->
                </div>
                <div class="modal-footer bg-light">
                    <div class="small text-muted me-auto">* Îã®ÏúÑ(Ï≤úÏõê) ÌëúÍ∏∞ Ï∞∏Í≥†</div>
                    <button type="button" class="btn btn-secondary" @click="showLaborModal = false">Îã´Í∏∞</button>
                </div>
            </div>
        </div>
    </div> <!-- End showLaborModal -->

    <!-- Yearly Labor Registration Modal -->
    <div v-if="showLaborYearlyModal" class="modal-backdrop fade show" style="z-index: 1065;"></div>
    <div v-if="showLaborYearlyModal" class="modal fade show d-block" tabindex="-1" style="z-index: 1070;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">Ïó∞ÎèÑÎ≥Ñ Ïù∏Í±¥ÎπÑ Îì±Î°ù</h5>
                    <button type="button" class="btn-close" @click="closeLaborYearlyModal"></button>
                </div>
                <div class="modal-body">
                      <div class="row mb-3">
                          <label class="col-sm-3 col-form-label text-end small fw-bold">ÏßÅÏúÑ/ÏÑ±Î™Ö</label>
                          <div class="col-sm-9 d-flex align-items-center">
                              <span class="fw-bold">{{ currentLaborYearly.jobTitle }}</span>
                          </div>
                      </div>
                      <div class="row mb-4">
                          <label class="col-sm-3 col-form-label text-end small fw-bold">Ïù∏Í±¥ÎπÑ<br>Ï¶ùÍ∞êÏú®</label>
                          <div class="col-sm-9 d-flex align-items-center">
                              <div class="input-group input-group-sm" style="width: 150px;">
                                 <input type="number" class="form-control text-end" v-model.number="currentLaborYearly.jobAmtRate" @input="calcLaborYearly">
                                 <span class="input-group-text">%</span>
                              </div>
                              <span class="small text-muted ms-2">(2,3Ï∞®ÎÖÑÎèÑ ÏûêÎèôÍ≥ÑÏÇ∞)</span>
                          </div>
                      </div>
                      <table class="table table-bordered small align-middle text-center">
                          <thead class="table-light">
                              <tr>
                                  <th>ÎÖÑÎèÑ</th>
                                  <th>Ïù∏Í±¥ÎπÑ(Ï≤úÏõê)</th>
                              </tr>
                          </thead>
                          <tbody>
                              <tr v-for="(amt, i) in currentLaborYearly.jobAmtYear" :key="i">
                                  <td class="bg-light">{{ i+1 }}Ï∞®ÎÖÑÎèÑ</td>
                                  <td class="text-end pe-2">{{ formatNumber(Math.round(amt/1000)) }}</td>
                              </tr>
                          </tbody>
                      </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger btn-sm text-white" @click="saveLaborYearly" style="background-color: #ff8a80; border-color: #ff8a80;">ÏàòÏ†ï</button>
                    <button type="button" class="btn btn-secondary btn-sm" @click="closeLaborYearlyModal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Yearly Sales Modal (Per Menu) -->
    <div v-if="showYearlyModal" class="modal-backdrop fade show" style="z-index: 1075;"></div>
    <div v-if="showYearlyModal" class="modal fade show d-block" tabindex="-1" style="z-index: 1080;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">Ïó∞ÎèÑÎ≥Ñ Îß§Ï∂úÎì±Î°ù</h5>
                    <button type="button" class="btn-close" @click="closeYearlyModal"></button>
                </div>
                <div class="modal-body">
                     <!-- Menu Name -->
                     <div class="row mb-3">
                         <label class="col-sm-3 col-form-label text-end small fw-bold">Î©îÎâ¥Î™Ö</label>
                         <div class="col-sm-9 d-flex align-items-center">
                             <span class="fw-bold">{{ currentMenu?.menuTitle }}</span>
                         </div>
                     </div>
                     
                     <!-- Input Method -->
                     <div class="row mb-3">
                         <label class="col-sm-3 col-form-label text-end small fw-bold">ÏûÖÎ†•Î∞©Î≤ïÏÑ†ÌÉù</label>
                         <div class="col-sm-9">
                             <select class="form-select form-select-sm" v-model="currentYearly.menuCd" @change="onYMenuCdChange">
                                 <option value="1">Ï¶ùÍ∞êÏú®</option>
                                 <option value="2">ÏßÅÏ†ëÏûÖÎ†•</option>
                             </select>
                         </div>
                     </div>

                     <!-- Rates (Visible if Cd=1) -->
                     <div v-if="currentYearly.menuCd === '1'">
                         <div class="row mb-2">
                             <label class="col-sm-3 col-form-label text-end small">ÌåêÎß§ÏàòÎüâ<br>Ï¶ùÍ∞êÏú®</label>
                             <div class="col-sm-9 d-flex align-items-center">
                                 <div class="input-group input-group-sm">
                                    <input type="number" class="form-control text-end" v-model.number="currentYearly.menuQtyRate" @input="calcYearly">
                                    <span class="input-group-text">%</span>
                                 </div>
                             </div>
                         </div>
                         <div class="row mb-3">
                             <label class="col-sm-3 col-form-label text-end small">ÌåêÎß§Îã®Í∞Ä<br>Ï¶ùÍ∞êÏú®</label>
                             <div class="col-sm-9 d-flex align-items-center">
                                 <div class="input-group input-group-sm">
                                    <input type="number" class="form-control text-end" v-model.number="currentYearly.menuPriceRate" @input="calcYearly">
                                    <span class="input-group-text">%</span>
                                 </div>
                             </div>
                         </div>
                     </div>

                     <!-- Table -->
                     <table class="table table-bordered small align-middle">
                         <thead class="table-light text-center">
                             <tr>
                                 <th>ÎÖÑÎèÑ</th>
                                 <th>ÌåêÎß§ÏàòÎüâ</th>
                                 <th>ÌåêÎß§Îã®Í∞Ä</th>
                                 <th>ÌåêÎß§Í∏àÏï°(Ï≤úÏõê)</th>
                             </tr>
                         </thead>
                         <tbody>
                             <!-- Year 1 (Fixed) -->
                             <tr>
                                 <td class="bg-light text-center">1Ï∞®ÎÖÑÎèÑ</td>
                                 <td class="bg-light text-end pe-2">{{ formatNumber(currentYearly.menuQty[0]) }}</td>
                                 <td class="bg-light text-end pe-2">{{ formatNumber(currentYearly.menuPrice[0]) }}</td>
                                 <td class="bg-light text-end pe-2">{{ formatNumber(Math.round(currentYearly.menuAmt[0]/1000)) }}</td>
                             </tr>
                             <!-- Year 2 -->
                             <tr>
                                 <td class="bg-light text-center">2Ï∞®ÎÖÑÎèÑ</td>
                                 <td class="text-end pe-2">
                                     <input v-if="currentYearly.menuCd === '2'" type="number" class="form-control form-control-sm text-end" v-model.number="currentYearly.menuQty[1]" @input="calcYearlyDirect">
                                     <span v-else>{{ formatNumber(currentYearly.menuQty[1]) }}</span>
                                 </td>
                                 <td class="text-end pe-2">
                                     <input v-if="currentYearly.menuCd === '2'" type="number" class="form-control form-control-sm text-end" v-model.number="currentYearly.menuPrice[1]" @input="calcYearlyDirect">
                                     <span v-else>{{ formatNumber(currentYearly.menuPrice[1]) }}</span>
                                 </td>
                                 <td class="bg-light text-end pe-2">{{ formatNumber(Math.round(currentYearly.menuAmt[1]/1000)) }}</td>
                             </tr>
                             <!-- Year 3 -->
                             <tr>
                                 <td class="bg-light text-center">3Ï∞®ÎÖÑÎèÑ</td>
                                  <td class="text-end pe-2">
                                     <input v-if="currentYearly.menuCd === '2'" type="number" class="form-control form-control-sm text-end" v-model.number="currentYearly.menuQty[2]" @input="calcYearlyDirect">
                                     <span v-else>{{ formatNumber(currentYearly.menuQty[2]) }}</span>
                                 </td>
                                 <td class="text-end pe-2">
                                     <input v-if="currentYearly.menuCd === '2'" type="number" class="form-control form-control-sm text-end" v-model.number="currentYearly.menuPrice[2]" @input="calcYearlyDirect">
                                     <span v-else>{{ formatNumber(currentYearly.menuPrice[2]) }}</span>
                                 </td>
                                 <td class="bg-light text-end pe-2">{{ formatNumber(Math.round(currentYearly.menuAmt[2]/1000)) }}</td>
                             </tr>
                         </tbody>
                     </table>
                </div>
                 <div class="modal-footer">
                    <button type="button" class="btn btn-danger btn-sm" @click="saveYearlyModal">ÏàòÏ†ï</button>
                    <button type="button" class="btn btn-secondary btn-sm" @click="closeYearlyModal">Close</button>
                </div>
            </div>
        </div>
    </div> <!-- End showYearlyModal -->
    <!-- Yearly Material Cost Registration Modal -->
    <div v-if="showMaterialYearlyModal" class="modal-backdrop fade show" style="z-index: 1065;"></div>
    <div v-if="showMaterialYearlyModal" class="modal fade show d-block" tabindex="-1" style="z-index: 1070;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">Ïó∞ÎèÑÎ≥Ñ Ïû¨Î£åÎπÑ Îì±Î°ù</h5>
                    <button type="button" class="btn-close" @click="closeMaterialYearlyModal"></button>
                </div>
                <div class="modal-body">
                     <!-- Menu Info -->
                     <div class="row mb-3">
                         <label class="col-sm-3 col-form-label text-end small fw-bold">Î©îÎâ¥Î™Ö</label>
                         <div class="col-sm-9 d-flex align-items-center">
                             <span class="fw-bold">{{ currentMenu?.menuTitle }}</span>
                         </div>
                     </div>
                     
                     <!-- Increase Rate Input -->
                     <div class="row mb-4">
                         <label class="col-sm-3 col-form-label text-end small fw-bold">Ïû¨Î£åÎπÑÎπÑÏú®<br>Ï¶ùÍ∞êÏú®</label>
                         <div class="col-sm-9 d-flex align-items-center">
                             <div class="input-group input-group-sm" style="width: 150px;">
                                <input type="number" class="form-control text-end" v-model.number="currentMaterialYearly.costAmtRate" @input="calcMaterialYearly">
                                <span class="input-group-text">%</span>
                             </div>
                             <span class="small text-muted ms-2">(2,3Ï∞®ÎÖÑÎèÑ ÏûêÎèôÍ≥ÑÏÇ∞)</span>
                         </div>
                     </div>

                     <!-- Table -->
                     <table class="table table-bordered small align-middle text-center">
                         <thead class="table-light">
                             <tr>
                                 <th>ÎÖÑÎèÑ</th>
                                 <th>ÌåêÎß§Í∏àÏï°(Ï≤úÏõê)</th>
                                 <th>Ïû¨Î£åÎπÑ ÎπÑÏú®</th>
                                 <th>Ïû¨Î£åÎπÑ(Ï≤úÏõê)</th>
                             </tr>
                         </thead>
                         <tbody>
                             <!-- Year 1 -->
                             <tr>
                                 <td class="bg-light">1Ï∞®ÎÖÑÎèÑ</td>
                                 <td class="bg-light text-end pe-2">{{ formatNumber(Math.round((currentMaterialYearly.DisplayYMenuAmt?.[0] || 0)/1000)) }}</td>
                                 <td class="bg-light">
                                     <div class="input-group input-group-sm justify-content-end border-0 bg-transparent">
                                        <span class="pe-1">{{ currentMaterialYearly.costRate?.[0] || 0 }}</span>%
                                     </div>
                                 </td>
                                 <td class="bg-light text-end pe-2">{{ formatNumber(Math.round((currentMaterialYearly.costAmt?.[0] || 0)/1000)) }}</td>
                             </tr>
                             <!-- Year 2 -->
                             <tr>
                                 <td class="bg-light">2Ï∞®ÎÖÑÎèÑ</td>
                                 <td class="bg-light text-end pe-2">{{ formatNumber(Math.round((currentMaterialYearly.DisplayYMenuAmt?.[1] || 0)/1000)) }}</td>
                                 <td class="bg-white">
                                     <div class="d-flex justify-content-center align-items-center">
                                        <span class="fw-bold">{{ currentMaterialYearly.costRate?.[1] || 0 }}</span>
                                        <span class="small ms-1">%</span>
                                     </div>
                                 </td>
                                 <td class="bg-light text-end pe-2">{{ formatNumber(Math.round((currentMaterialYearly.costAmt?.[1] || 0)/1000)) }}</td>
                             </tr>
                             <!-- Year 3 -->
                             <tr>
                                 <td class="bg-light">3Ï∞®ÎÖÑÎèÑ</td>
                                 <td class="bg-light text-end pe-2">{{ formatNumber(Math.round((currentMaterialYearly.DisplayYMenuAmt?.[2] || 0)/1000)) }}</td>
                                  <td class="bg-white">
                                     <div class="d-flex justify-content-center align-items-center">
                                        <span class="fw-bold">{{ currentMaterialYearly.costRate?.[2] || 0 }}</span>
                                        <span class="small ms-1">%</span>
                                     </div>
                                 </td>
                                 <td class="bg-light text-end pe-2">{{ formatNumber(Math.round((currentMaterialYearly.costAmt?.[2] || 0)/1000)) }}</td>
                             </tr>
                         </tbody>
                     </table>
                </div>
                 <div class="modal-footer">
                     <!-- Button color red-ish as per user image 'ÏàòÏ†ï'-->
                    <button type="button" class="btn btn-danger btn-sm text-white" @click="saveMaterialYearly" style="background-color: #ff8a80; border-color: #ff8a80;">ÏàòÏ†ï</button>
                    <button type="button" class="btn btn-secondary btn-sm" @click="closeMaterialYearlyModal">Close</button>
                </div>
            </div>
        </div>
    </div> <!-- End showMaterialYearlyModal -->
</div> <!-- End #app -->

<script>
  
    const { createApp, ref, reactive, computed, watch, onMounted } = Vue;

    createApp({
        setup() {
            const mode = ref('lite'); // 'lite' or 'expert'
            const userEmail = ref('test@example.com');
            const isSaving = ref(false);
            const reports = ref([]);
            const currentReportId = ref(null);
            const showProjectionModal = ref(false);
            const showMaterialModal = ref(false);
            const showLaborModal = ref(false);

            // Yearly Sales Logic
            const showYearlyModal = ref(false);
            const currentMenuIdx = ref(-1);
            const currentMenu = computed(() => (currentMenuIdx.value >= 0 && expertData.sale) ? expertData.sale.menu[currentMenuIdx.value] : null);
            const currentYearly = reactive({
                menuCd: '1', menuQtyRate: 0, menuPriceRate: 0,
                menuQty: [0,0,0], menuPrice: [0,0,0], menuAmt: [0,0,0]
            });

            const openYearlyModal = (idx) => {
                currentMenuIdx.value = idx;
                const existing = expertData.sale.menuY[idx];
                if (existing) {
                    currentYearly.menuCd = existing.menuCd || '1';
                    currentYearly.menuQtyRate = existing.menuQtyRate || 0;
                    currentYearly.menuPriceRate = existing.menuPriceRate || 0;
                    currentYearly.menuQty = [...(existing.menuQty || [0,0,0])];
                    currentYearly.menuPrice = [...(existing.menuPrice || [0,0,0])];
                    currentYearly.menuAmt = [...(existing.menuAmt || [0,0,0])];
                }
                showYearlyModal.value = true;
            };

            const closeYearlyModal = () => { showYearlyModal.value = false; currentMenuIdx.value = -1; };
            
            const saveYearlyModal = () => {
                if (currentMenuIdx.value >= 0 && expertData.sale.menuY[currentMenuIdx.value]) {
                    const target = expertData.sale.menuY[currentMenuIdx.value];
                    target.menuCd = currentYearly.menuCd;
                    target.menuQtyRate = currentYearly.menuQtyRate;
                    target.menuPriceRate = currentYearly.menuPriceRate;
                    target.menuQty = [...currentYearly.menuQty];
                    target.menuPrice = [...currentYearly.menuPrice];
                    target.menuAmt = [...currentYearly.menuAmt];
                }
                closeYearlyModal();
            };

            const calcYearly = () => {
                if (currentYearly.menuCd !== '1') return;
                const qRate = (currentYearly.menuQtyRate || 0)/100;
                const pRate = (currentYearly.menuPriceRate || 0)/100;
                const q1 = currentYearly.menuQty[0];
                const p1 = currentYearly.menuPrice[0];
                currentYearly.menuQty[1] = Math.round(q1 * (1 + qRate));
                currentYearly.menuPrice[1] = Math.round(p1 * (1 + pRate));
                currentYearly.menuAmt[1] = currentYearly.menuQty[1] * currentYearly.menuPrice[1];
                currentYearly.menuQty[2] = Math.round(currentYearly.menuQty[1] * (1 + qRate));
                currentYearly.menuPrice[2] = Math.round(currentYearly.menuPrice[1] * (1 + pRate));
                currentYearly.menuAmt[2] = currentYearly.menuQty[2] * currentYearly.menuPrice[2];
            };

            const calcYearlyDirect = () => {
                if (currentYearly.menuCd !== '2') return;
                currentYearly.menuAmt[1] = (currentYearly.menuQty[1] || 0) * (currentYearly.menuPrice[1] || 0);
                currentYearly.menuAmt[2] = (currentYearly.menuQty[2] || 0) * (currentYearly.menuPrice[2] || 0);
            };

            const onYMenuCdChange = () => {
                if (currentYearly.menuCd === '1') calcYearly();
            };
            
            // Material Cost Yearly Logic
            const showMaterialYearlyModal = ref(false);
            const currentMaterialYearly = reactive({
                costCd: '1', costAmtRate: 0,
                costRate: [0,0,0], costAmt: [0,0,0],
                DisplayYMenuAmt: [0,0,0]
            });

            const openMaterialYearlyModal = (idx) => {
                currentMenuIdx.value = idx;
                const baseRate = expertData.cost?.costRate[idx] || 0;
                const costYItem = expertData.cost?.costY[idx];
                const revYItem = expertData.sale?.menuY[idx];

                if (costYItem) {
                    currentMaterialYearly.costCd = costYItem.costCd || '1';
                    currentMaterialYearly.costAmtRate = costYItem.costAmtRate || 0;
                    currentMaterialYearly.costRate = costYItem.costRate ? [...costYItem.costRate] : [baseRate, baseRate, baseRate];
                } else {
                    currentMaterialYearly.costCd = '1'; 
                    currentMaterialYearly.costAmtRate = 0;
                    currentMaterialYearly.costRate = [baseRate, baseRate, baseRate];
                }

                if (revYItem && revYItem.menuAmt) {
                    currentMaterialYearly.DisplayYMenuAmt = [...revYItem.menuAmt];
                } else {
                    currentMaterialYearly.DisplayYMenuAmt = [0,0,0];
                }
                calcMaterialYearly();
                showMaterialYearlyModal.value = true;
            };

            const closeMaterialYearlyModal = () => { showMaterialYearlyModal.value = false; currentMenuIdx.value = -1; };

            const calcMaterialYearly = () => {
                const rateIncrease = (currentMaterialYearly.costAmtRate || 0) / 100;
                currentMaterialYearly.costAmt[0] = Math.round(currentMaterialYearly.DisplayYMenuAmt[0] * (currentMaterialYearly.costRate[0] / 100));
                
                let r2 = currentMaterialYearly.costRate[0] * (1 + rateIncrease);
                if(r2 > 100) r2 = 100; 
                currentMaterialYearly.costRate[1] = parseFloat(r2.toFixed(2)); 
                currentMaterialYearly.costAmt[1] = Math.round(currentMaterialYearly.DisplayYMenuAmt[1] * (currentMaterialYearly.costRate[1] / 100));

                let r3 = currentMaterialYearly.costRate[1] * (1 + rateIncrease);
                if(r3 > 100) r3 = 100;
                currentMaterialYearly.costRate[2] = parseFloat(r3.toFixed(2));
                currentMaterialYearly.costAmt[2] = Math.round(currentMaterialYearly.DisplayYMenuAmt[2] * (currentMaterialYearly.costRate[2] / 100));
            };

            const saveMaterialYearly = () => {
                if(currentMenuIdx.value >= 0) {
                    if (!expertData.cost.costY[currentMenuIdx.value]) {
                        expertData.cost.costY[currentMenuIdx.value] = {};
                    }
                    const target = expertData.cost.costY[currentMenuIdx.value];
                    target.costCd = '1';
                    target.costAmtRate = currentMaterialYearly.costAmtRate;
                    target.costRate = [...currentMaterialYearly.costRate];
                    target.costAmt = [...currentMaterialYearly.costAmt];
                }
                closeMaterialYearlyModal();
            };

            // Labor Yearly Logic
            const showLaborYearlyModal = ref(false);
            const currentJobIdx = ref(-1);
            const currentJobType = ref(''); // 'mfg' or 'sales'
            const currentLaborYearly = reactive({
                 jobTitle: '', jobAmtRate: 0,
                 jobAmtYear: [0,0,0], baseMonthly: 0
            });

            const openLaborYearlyModal = (idx, type) => {
                currentJobIdx.value = idx;
                currentJobType.value = type;
                const job = (type === 'mfg') ? expertData.job.production[idx] : expertData.job.sales[idx];
                
                currentLaborYearly.jobTitle = job.jobTitle;
                currentLaborYearly.jobAmtRate = job.jobAmtRate || 0;
                currentLaborYearly.baseMonthly = (job.jobCnt || 0) * (job.jobQty || 0);
                
                calcLaborYearly();
                showLaborYearlyModal.value = true;
            };

            const closeLaborYearlyModal = () => { showLaborYearlyModal.value = false; };

            const calcLaborYearly = () => {
                const rate = (currentLaborYearly.jobAmtRate || 0)/100;
                const baseYearly = currentLaborYearly.baseMonthly * 12;
                
                currentLaborYearly.jobAmtYear[0] = baseYearly;
                currentLaborYearly.jobAmtYear[1] = Math.round(baseYearly * (1 + rate));
                currentLaborYearly.jobAmtYear[2] = Math.round(currentLaborYearly.jobAmtYear[1] * (1 + rate));
            };

            const saveLaborYearly = () => {
                const job = (currentJobType.value === 'mfg') ? expertData.job.production[currentJobIdx.value] : expertData.job.sales[currentJobIdx.value];
                if(job) {
                    job.jobAmtRate = currentLaborYearly.jobAmtRate;
                    job.jobAmtYear = [...currentLaborYearly.jobAmtYear];
                }
                closeLaborYearlyModal();
                updateProjections(); 
            };

            



            // ================= LITE MODE STATE =================
            const liteData = reactive({
                basic: { industryCd: '3', monTargetPrice: 3000000, workDay: 25 },
                sale: {
                    menu: [
                        { menuTitle: 'Í∏∞Î≥∏ Î©îÎâ¥', menuPrice: 10000, menuQty: 30 }
                    ]
                },
                liteCost: { totalMonthlyCost: 1500000 }
            });

            // ================= EXPERT MODE STATE =================
            // Based on User JSON Schema
            const mfgExpMapping = [
                { title: 'Ï†ÑÎ†•ÎπÑ', baseType: 'revenue', baseName: 'Îß§Ï∂úÏï°' },
                { title: 'Í∞ÄÏä§ÏàòÎèÑÎ£å', baseType: 'revenue', baseName: 'Îß§Ï∂úÏï°' },
                { title: 'Ïö¥Î∞òÎπÑ', baseType: 'fixed', baseName: 'ÏõîÏ†ïÏï°' },
                { title: 'Ï∞®ÎüâÏú†ÏßÄÎπÑ', baseType: 'fixed', baseName: 'ÏõîÏ†ïÏï°' },
                { title: 'Î≥¥Í¥ÄÎ£å', baseType: 'fixed', baseName: 'ÏõîÏ†ïÏï°' },
                { title: 'Ìè¨Ïû•ÎπÑ', baseType: 'revenue', baseName: 'Îß§Ï∂úÏï°' },
                { title: 'Í∞êÍ∞ÄÏÉÅÍ∞ÅÎπÑ', baseType: 'asset', baseName: 'Í∏∞Ï§ÄÏï°' },
                { title: 'ÏàòÏÑ†ÎπÑ', baseType: 'fixed', baseName: 'ÏõîÏ†ïÏï°' },
                { title: 'Ïô∏Ï£ºÍ∞ÄÍ≥µÎπÑ', baseType: 'revenue', baseName: 'Îß§Ï∂úÏï°' },
                { title: 'ÏÜåÎ™®ÌíàÎπÑ', baseType: 'revenue', baseName: 'Îß§Ï∂úÏï°' },
                { title: 'ÏÑ∏Í∏àÍ≥ºÍ≥µÍ≥º', baseType: 'fixed', baseName: 'ÏõîÏ†ïÏï°' },
                { title: 'ÏßÄÍ∏âÏûÑÏ∞®Î£å', baseType: 'fixed', baseName: 'ÏõîÏ†ïÏï°' },
                { title: 'Î≥¥ÌóòÎ£å', baseType: 'fixed', baseName: 'ÏõîÏ†ïÏï°' },
                { title: 'Î≥µÎ¶¨ÌõÑÏÉùÎπÑ', baseType: 'labor', baseName: 'Ïù∏Í±¥ÎπÑ' },
                { title: 'ÍµêÌÜµÎπÑ', baseType: 'fixed', baseName: 'ÏõîÏ†ïÏï°' },
                { title: 'ÌÜµÏã†ÎπÑ', baseType: 'fixed', baseName: 'ÏõîÏ†ïÏï°' },
                { title: 'Ï†ëÎåÄÎπÑ', baseType: 'fixed', baseName: 'ÏõîÏ†ïÏï°' },
                { title: 'Í≤ΩÏÉÅÍ∞úÎ∞úÎπÑ', baseType: 'fixed', baseName: 'ÏõîÏ†ïÏï°' },
                { title: 'ÎèÑÏÑúÏù∏ÏáÑÎπÑ', baseType: 'fixed', baseName: 'ÏõîÏ†ïÏï°' },
                { title: 'ÍµêÏú°ÌõàÎ†®ÎπÑ', baseType: 'fixed', baseName: 'ÏõîÏ†ïÏï°' },
                { title: 'ÏßÄÍ∏âÏàòÏàòÎ£å', baseType: 'fixed', baseName: 'ÏõîÏ†ïÏï°' },
                { title: 'ÏãúÌóòÎπÑ', baseType: 'fixed', baseName: 'ÏõîÏ†ïÏï°' },
                { title: 'Ïû•ÎπÑÏûÑÏ∞®Î£å', baseType: 'fixed', baseName: 'ÏõîÏ†ïÏï°' },
                { title: 'Ïû°ÎπÑ', baseType: 'fixed', baseName: 'ÏõîÏ†ïÏï°' }
            ];

            const expertData = reactive({
                basic: { industryCd: '3', workDay: 25, monTargetPrice: 5000000, saleMode: '1' },
                sale: {
                    menu: [],
                    menuM: [],
                    menuY: []
                },
                cost: {
                    costRate: [], // array of numbers
                    costM: [],
                    costY: []
                },
                job: {
                    production: [],
                    sales: []
                },
                invest: {
                    production: {
                        production01: [], production02: [], production03: [], production04: []
                    },
                    sales: {
                        sales01: [], sales02: [], sales03: [], sales04: []
                    }
                },
                loan: {
                    equity: [],
                    debt: []
                },
                expense: {
                    production: mfgExpMapping.map(m => ({
                        expenseTitle: m.title,
                        expenseTVaAmt: 0,
                        expenseTVa: 0,
                        expenseAmt: Array(12).fill(0),
                        expenseAmtYear: [0, 0, 0]
                    })),
                    sales: []
                }
            });

            // ================= PROJECTION ENGINE =================
            const updateProjections = () => {
                const saleMode = expertData.basic.saleMode || '1';
                const workDay = expertData.basic.workDay || 25;

                // 1. Menu Projections
                if(!expertData.sale) expertData.sale = { menu: [], menuM: [], menuY: [] };
                expertData.sale.menuM = [];
                if(!expertData.cost) expertData.cost = { costRate: [], costM: [], costY: [] };
                expertData.cost.costM = [];
                
                const menuList = expertData.sale.menu || [];
                if(!expertData.sale.menuY) expertData.sale.menuY = [];
                if(!expertData.cost.costY) expertData.cost.costY = [];
                if(!expertData.cost.costRate) expertData.cost.costRate = [];

                menuList.forEach((m, idx) => {
                    const price = m.menuPrice || 0;
                    const baseQty = m.menuQty || 0;
                    const monthlyQty = (saleMode == '1') ? baseQty * workDay : baseQty;
                    const monthlyAmt = monthlyQty * price;

                    // A. menuM
                    expertData.sale.menuM.push({ 
                        menuQty: Array(12).fill(monthlyQty), 
                        menuAmt: Array(12).fill(monthlyAmt) 
                    });

                    // B. menuY
                    if (!expertData.sale.menuY[idx]) {
                         expertData.sale.menuY[idx] = {
                            menuCd: '1', menuQtyRate: 0, menuPriceRate: 0, 
                            menuQty: [0,0,0], menuPrice: [0,0,0], menuAmt: [0,0,0]
                         };
                    }
                    const yItem = expertData.sale.menuY[idx];
                    if(!yItem.menuQty) yItem.menuQty = [0,0,0];
                    if(!yItem.menuPrice) yItem.menuPrice = [0,0,0];
                    if(!yItem.menuAmt) yItem.menuAmt = [0,0,0];
                    if(!yItem.menuCd) yItem.menuCd = '1';

                    yItem.menuQty[0] = monthlyQty * 12;
                    yItem.menuPrice[0] = price;
                    yItem.menuAmt[0] = yItem.menuQty[0] * price;

                    if (yItem.menuCd === '1') {
                         const qRate = (yItem.menuQtyRate || 0)/100;
                         const pRate = (yItem.menuPriceRate || 0)/100;
                         for(let i=1; i<3; i++) {
                             yItem.menuQty[i] = Math.round(yItem.menuQty[i-1] * (1 + qRate));
                             yItem.menuPrice[i] = Math.round(yItem.menuPrice[i-1] * (1 + pRate));
                             yItem.menuAmt[i] = yItem.menuQty[i] * yItem.menuPrice[i];
                         }
                    } else {
                         yItem.menuAmt[1] = (yItem.menuQty[1]||0) * (yItem.menuPrice[1]||0);
                         yItem.menuAmt[2] = (yItem.menuQty[2]||0) * (yItem.menuPrice[2]||0);
                    }

                    // C. costM & costY
                    const rate = expertData.cost.costRate[idx] || 0;
                    expertData.cost.costM.push({ 
                        costAmt: Array(12).fill(Math.round(monthlyAmt * (rate/100))) 
                    });

                    if (!expertData.cost.costY[idx]) {
                        expertData.cost.costY[idx] = { 
                            costCd: '1', costAmtRate: 0,
                            costRate: [rate, rate, rate],
                            costAmt: [0,0,0]
                        };
                    }
                    const yCostItem = expertData.cost.costY[idx];
                    if(!yCostItem.costRate) yCostItem.costRate = [rate, rate, rate];
                    if(!yCostItem.costAmt) yCostItem.costAmt = [0,0,0];
                    
                    if(yItem.menuAmt) {
                        yCostItem.costAmt = yItem.menuAmt.map((amt, k) => Math.round(amt * (yCostItem.costRate[k] || 0)/100));
                    }
                });
                
                // Trim
                if (expertData.sale.menuY.length > expertData.sale.menu.length) expertData.sale.menuY.splice(expertData.sale.menu.length);
                if (expertData.cost.costY.length > expertData.sale.menu.length) expertData.cost.costY.splice(expertData.sale.menu.length);

                // 2. Labor Projections
                const processJob = (jobList) => {
                    jobList.forEach(j => {
                        const monthly = (j.jobCnt || 0) * (j.jobQty || 0);
                        j.jobAmt = Array(12).fill(monthly);
                        if(!j.jobAmtYear) j.jobAmtYear = [monthly*12, monthly*12, monthly*12];
                        else j.jobAmtYear[0] = monthly * 12;
                        
                        if(!j.jobAmtCd) j.jobAmtCd = '1';
                        if(j.jobAmtCd === '1') {
                            const rate = (j.jobAmtRate || 0)/100;
                            j.jobAmtYear[1] = Math.round(j.jobAmtYear[0] * (1 + rate));
                            j.jobAmtYear[2] = Math.round(j.jobAmtYear[1] * (1 + rate));
                        }
                    });
                };
                processJob(expertData.job.production);
                processJob(expertData.job.sales);

                // 3. Expense Projections
                const processExp = (expList, isProduction=false) => {
                    if(isProduction) {
                        const monthlyRevenue = Array(12).fill(0);
                        (expertData.sale.menuM || []).forEach(m => {
                            for(let i=0; i<12; i++) monthlyRevenue[i] += (m.menuAmt[i] || 0);
                        });

                        const monthlyLaborProd = Array(12).fill(0);
                        (expertData.job.production || []).forEach(j => {
                            for(let i=0; i<12; i++) monthlyLaborProd[i] += (j.jobAmt[i] || 0);
                        });

                        let deprBase = 0;
                        const pInvest = expertData.invest.production;
                        ['production01', 'production02'].forEach(key => {
                            (pInvest[key] || []).forEach(inv => {
                                if(inv.investYn === 'Y') deprBase += (inv.investYearAmt || 0);
                            });
                        });

                        expList.forEach(exp => {
                            const mapping = mfgExpMapping.find(m => m.title === exp.expenseTitle);
                            if(!mapping) {
                                const monthly = (exp.expenseTVaAmt || 0);
                                exp.expenseAmt = Array(12).fill(monthly);
                                exp.expenseAmtYear = [monthly*12, monthly*12, monthly*12];
                                return;
                            }

                            if(mapping.baseType === 'revenue') {
                                exp.expenseTVaAmt = monthlyRevenue.reduce((a,b)=>a+b, 0); 
                            } else if(mapping.baseType === 'labor') {
                                exp.expenseTVaAmt = monthlyLaborProd.reduce((a,b)=>a+b, 0); 
                            } else if(mapping.baseType === 'asset') {
                                exp.expenseTVaAmt = deprBase;
                            }

                            const rate = (exp.expenseTVa || 0) / 100;
                            let yearlySum = 0;
                            for(let i=0; i<12; i++) {
                                let amt = 0;
                                if(mapping.baseType === 'revenue') amt = Math.round(monthlyRevenue[i] * rate);
                                else if(mapping.baseType === 'labor') amt = Math.round(monthlyLaborProd[i] * rate);
                                else if(mapping.baseType === 'asset') amt = Math.round(deprBase * rate);
                                else amt = Math.round(exp.expenseTVaAmt || 0); // Fixed Fixed

                                exp.expenseAmt[i] = amt;
                                yearlySum += amt;
                            }
                            exp.expenseAmtYear = [yearlySum, yearlySum, yearlySum];
                        });
                    } else {
                        expList.forEach(e => {
                            const monthly = (e.expenseTVaAmt || 0);
                            e.expenseAmt = Array(12).fill(monthly);
                            e.expenseAmtYear = [monthly*12, monthly*12, monthly*12];
                        });
                    }
                };
                processExp(expertData.expense.production, true);
                processExp(expertData.expense.sales, false);
                // 4. Investment Projections (New Sync)
                const processInvestments = (section) => {
                    if(!section) return;
                    Object.keys(section).forEach(key => {
                        const list = section[key] || [];
                        const catNum = parseInt(key.slice(-1)); // 1, 2, 3, 4
                        list.forEach(inv => {
                            // Enforce Non-Depreciable Rules
                            const isLand = (catNum === 1 && inv.investTitleCd === '10');
                            const isPremium = (catNum === 2 && inv.investTitleCd === '10');
                            const isCat34 = (catNum >= 3);

                            if (isLand || isPremium || isCat34) {
                                inv.investYn = 'N';
                                inv.investYear = 0;
                                inv.investYearAmt = 0;
                            } else if (inv.investYn === 'Y' && inv.investYear > 0) {
                                inv.investYearAmt = Math.round(inv.investPrice / (inv.investYear * 12));
                            } else {
                                inv.investYearAmt = 0;
                            }
                        });
                    });
                };
                processInvestments(expertData.invest.production);
                processInvestments(expertData.invest.sales);

                // 5. Loan/Debt Interest
                (expertData.loan.debt || []).forEach(d => {
                    if(!d.loanYear) d.loanYear = [0,0,0];
                    if(!d.loanRate) d.loanRate = [0,0,0];
                    if(!d.loanRateAmt) d.loanRateAmt = [0,0,0];
                    
                    let cumPrincipal = 0;
                    for(let i=0; i<3; i++) {
                        cumPrincipal += (d.loanYear[i] || 0);
                        // Calculation: (CumPrincipal) * (Rate / 100)
                        d.loanRateAmt[i] = Math.round(cumPrincipal * ((d.loanRate[i] || 0) / 100));
                    }
                });
            };

            // Watch for changes (Defensive & Specific to avoid recursion)
            watch(
                () => {
                    if(!expertData.basic || !expertData.sale) return null;
                    return JSON.stringify({
                        saleMode: expertData.basic.saleMode,
                        workDay: expertData.basic.workDay,
                        menus: expertData.sale.menu.map(m => ({ p: m.menuPrice, q: m.menuQty })),
                        costRates: expertData.cost.costRate,
                        prodJobs: expertData.job.production.map(j => ({ c: j.jobCnt, q: j.jobQty, r: j.jobAmtRate, cd: j.jobAmtCd })),
                        salesJobs: expertData.job.sales.map(j => ({ c: j.jobCnt, q: j.jobQty, r: j.jobAmtRate, cd: j.jobAmtCd })),
                        prodExp: expertData.expense.production.map(e => ({ a: e.expenseTVaAmt })),
                        salesExp: expertData.expense.sales.map(e => ({ a: e.expenseTVaAmt })),
                        invest: { p: expertData.invest.production, s: expertData.invest.sales },
                        debt: expertData.loan.debt
                    });
                },
                (newVal, oldVal) => {
                    if (newVal && newVal !== oldVal) {
                        updateProjections();
                    }
                }
            );

            // ================= PROFIT ANALYSIS ENGINE (NEW) =================
            const analyze_profitability = (data) => {
                const saleMode = data.basic.saleMode || '1';
                const workDay = data.basic.workDay || 25;
                const industryCd = data.basic.industryCd || '3';

                let S_mon = 0;
                let MC_mon = 0;
                data.sale.menu.forEach((m, i) => {
                    const price = m.menuPrice || 0;
                    const qty = m.menuQty || 0;
                    const itemSales = (saleMode == '1') ? (price * qty * workDay) : (price * qty);
                    S_mon += itemSales;
                    const rate = data.cost.costRate[i] || 0;
                    MC_mon += itemSales * (rate / 100);
                });

                let Dep_total = 0;
                let TotalInvest = 0;
                const processInvest = (sec) => {
                    if(!sec) return;
                    Object.values(sec).forEach(list => {
                        list.forEach(inv => {
                            TotalInvest += (inv.investPrice || 0);
                            if(inv.investYn === 'Y' && (inv.investYear || 0) > 0) {
                                Dep_total += (inv.investPrice || 0) / (inv.investYear * 12);
                            }
                        });
                    });
                };
                processInvest(data.invest.production);
                processInvest(data.invest.sales);

                let Labor_total = 0;
                let Headcount = 0;
                data.job.production.forEach(j => { 
                    Labor_total += (j.jobQty || 0) * (j.jobCnt || 0); 
                    Headcount += Number(j.jobCnt || 0); 
                });
                data.job.sales.forEach(j => { 
                    Labor_total += (j.jobQty || 0) * (j.jobCnt || 0); 
                    Headcount += Number(j.jobCnt || 0); 
                });

                let Exp_total = 0;
                let Rent_cost = 0;
                data.expense.production.forEach(item => { 
                    Exp_total += (item.expenseTVaAmt || 0); 
                });
                data.expense.sales.forEach(item => { 
                    const amt = (item.expenseTVaAmt || 0);
                    Exp_total += amt;
                    if(item.expenseTitle && item.expenseTitle.includes('ÏûÑÏ∞®Î£å')) Rent_cost += amt;
                });

                let Interest_total = 0;
                data.loan.debt.forEach(l => { 
                    const principal = (Array.isArray(l.loanYear) && l.loanYear[0]) || 0;
                    const rate = (Array.isArray(l.loanRate) && l.loanRate[0]) || 0;
                    Interest_total += principal * (rate/100) / 12; 
                });

                const TotalCost = MC_mon + Labor_total + Dep_total + Exp_total + Interest_total;
                const OP = S_mon - TotalCost;
                const safeDiv = (n, d) => d > 0 ? (n/d) : 0;
                const KPI = {
                    KPI_Turnover: safeDiv(S_mon * 12, TotalInvest),
                    KPI_OPMargin: safeDiv(OP, S_mon) * 100,
                    KPI_ROA: safeDiv(OP * 12, TotalInvest) * 100,
                    KPI_LaborRatio: safeDiv(Labor_total, S_mon) * 100,
                    KPI_SalesPerPerson: safeDiv(S_mon, Headcount),
                    KPI_RentRatio: safeDiv(Rent_cost, S_mon) * 100
                };

                const benchmarks = {
                    '1': { turnover: 1.5, margin: 10.0, labor: 15.0, salesPer: 10000000, rent: 5.0 },
                    '2': { turnover: 2.7, margin: 10.8, labor: 8.8,  salesPer: 22800000, rent: 8.8 },
                    '3': { turnover: 1.8, margin: 16.2, labor: 22.0, salesPer: 9000000,  rent: 11.0 },
                    '4': { turnover: 0.9, margin: 32.4, labor: 27.5, salesPer: 7200000,  rent: 16.5 },
                    '5': { turnover: 1.4, margin: 21.8, labor: 44.0, salesPer: 4500000,  rent: 11.0 }
                };
                const std = benchmarks[industryCd] || benchmarks['3'];
                const diagnosis = [
                    { id: 'turnover', label: 'Ìà¨ÏûêÌöåÏ†ÑÏú®', value: KPI.KPI_Turnover.toFixed(1) + 'Ìöå', pass: KPI.KPI_Turnover >= std.turnover, msg: `Í∏∞Ï§Ä ${std.turnover}Ìöå` },
                    { id: 'margin', label: 'ÏòÅÏóÖÏù¥ÏùµÎ•†', value: KPI.KPI_OPMargin.toFixed(1) + '%', pass: KPI.KPI_OPMargin >= std.margin, msg: `Í∏∞Ï§Ä ${std.margin}%` },
                    { id: 'roa', label: 'ROA', value: KPI.KPI_ROA.toFixed(1) + '%', pass: KPI.KPI_ROA >= 5.0, msg: 'ÎÜíÏùÑÏàòÎ°ù ÏñëÌò∏' },
                    { id: 'labor', label: 'Ïù∏Í±¥ÎπÑÏú®', value: KPI.KPI_LaborRatio.toFixed(1) + '%', pass: KPI.KPI_LaborRatio <= std.labor, msg: `Í∏∞Ï§Ä ${std.labor}%` },
                    { id: 'salesPer', label: '1Ïù∏Îß§Ï∂ú', value: Math.round(KPI.KPI_SalesPerPerson / 10000) + 'Îßå', pass: KPI.KPI_SalesPerPerson >= std.salesPer, msg: 'ÏÉùÏÇ∞ÏÑ± Ïö∞Ïàò' },
                    { id: 'rent', label: 'ÏûÑÏ∞®Î£åÏú®', value: KPI.KPI_RentRatio.toFixed(1) + '%', pass: KPI.KPI_RentRatio <= std.rent, msg: `Í∏∞Ï§Ä ${std.rent}%` }
                ];
                return { S_mon, MC_mon, Labor_total, Dep_total, Exp_total, Interest_total, OP, TotalInvest, KPI, diagnosis };
            };

            // ================= HELPERS =================
            const formatCurrency = (val) => {
                if(isNaN(val)) return '0Ïõê';
                return new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW' }).format(val);
            };
            const formatCurrencyCheon = (val) => {
                if(isNaN(val)) return '0Ï≤úÏõê';
                const v = Math.round(val / 1000);
                return new Intl.NumberFormat('ko-KR').format(v) + 'Ï≤úÏõê';
            };
            const formatDate = (d) => d ? new Date(d).toLocaleString() : '';
            const parseReport = (rpt) => {
                try { return JSON.parse(rpt.reportData); } catch(e) { return {}; }
            };

            const getReportValues = (rpt) => {
                const data = parseReport(rpt);
                if (data.mode === 'expert' && data.summary) {
                    return {
                        mode: 'expert',
                        revenue: data.summary.totalRevenue,
                        netProfit: data.summary.opIncome,
                        bep: data.summary.bepRevenue
                    };
                }
                // Fallback / Lite
                return {
                    mode: data.mode || 'lite',
                    revenue: data.revenue || (data.liteResult ? data.liteResult.revenue : 0),
                    netProfit: data.netProfit || (data.liteResult ? data.liteResult.netProfit : 0),
                    bep: data.bep || 0
                };
            };

            // ================= LITE LOGIC =================
            const liteResult = computed(() => {
                const b = liteData.basic || {};
                const WORK_DAYS = b.workDay || 25;
                let revenue = 0;
                (liteData.sale?.menu || []).forEach(m => {
                    revenue += (m.menuPrice || 0) * (m.menuQty || 0) * WORK_DAYS;
                });
                const cost = liteData.liteCost?.totalMonthlyCost || 0;
                const netProfit = revenue - cost;
                const gap = netProfit - (b.monTargetPrice || 0);
                return { revenue, netProfit, gap };
            });

            // ================= EXPERT LOGIC (CORE) =================
            
            // 1. Calculate Revenue per Menu
            const calcMenuMonthlyRevenue = (menu) => {
                const price = menu.menuPrice || 0;
                const qty = menu.menuQty || 0;
                const b = expertData.basic || {};
                if(b.saleMode == '1') {
                    return price * qty * (b.workDay || 0);
                } else {
                    return price * qty;
                }
            };

            const expertResult = computed(() => {
                const analysis = analyze_profitability(expertData);
                const yearlySales = analysis.S_mon * 12;
                const targetGap = analysis.OP - (expertData.basic.monTargetPrice || 0);

                let fixedExp = 0;
                let varExp = 0;
                // Treat all expenses as Fixed for now in this schema unless we add a type field
                fixedExp = (analysis.Exp_total || 0);
                
                const FC = analysis.Labor_total + analysis.Dep_total + analysis.Interest_total + fixedExp;
                const VC = analysis.MC_mon + varExp;
                
                let bepRevenue = 0;
                if(analysis.S_mon > 0) {
                     const vRatio = VC / analysis.S_mon;
                     if(vRatio < 1) bepRevenue = FC / (1 - vRatio);
                }


                return {
                    totalRevenue: analysis.S_mon,
                    yearlySales,
                    totalMaterialCost: analysis.MC_mon,
                    totalLaborCost: analysis.Labor_total,
                    totalDepreciation: analysis.Dep_total,
                    totalInterest: analysis.Interest_total,
                    totalExpense: analysis.Exp_total,
                    opIncome: analysis.OP,
                    
                    opMargin: analysis.KPI.KPI_OPMargin.toFixed(1),
                    materialRatio: (analysis.MC_mon/analysis.S_mon*100).toFixed(1),
                    laborRatio: analysis.KPI.KPI_LaborRatio.toFixed(1),
                    expenseRatio: (analysis.Exp_total/analysis.S_mon*100).toFixed(1),
                    
                    targetGap,
                    totalFixedCost: FC,
                    bepRevenue,
                    diagnosis: analysis.diagnosis
                };
            });


            // ================= ACTIONS =================
            const switchMode = (m) => {
                console.log("Switching mode to:", m);
                try {
                    // 1. Prepare Data FIRST (before switching view)
                    if(m === 'expert') {
                        if(liteData.basic) {
                            expertData.basic.industryCd = liteData.basic.industryCd;
                            expertData.basic.monTargetPrice = liteData.basic.monTargetPrice;
                            expertData.basic.workDay = liteData.basic.workDay;
                        }
                        const liteMenus = liteData.sale.menu || [];
                        const expertMenus = expertData.sale.menu;
                        const expertRate = expertData.cost.costRate;
                        liteMenus.forEach((lMenu, i) => {
                            if(expertMenus[i]) {
                                expertMenus[i].menuTitle = lMenu.menuTitle;
                                expertMenus[i].menuPrice = lMenu.menuPrice;
                                expertMenus[i].menuQty = lMenu.menuQty;
                            } else {
                                expertMenus.push({ 
                                    menuTitle: lMenu.menuTitle, 
                                    menuPrice: lMenu.menuPrice, 
                                    menuQty: lMenu.menuQty 
                                });
                                expertRate.push(35);
                            }
                        });
                        if(expertMenus.length > liteMenus.length) {
                             expertMenus.splice(liteMenus.length);
                             expertRate.splice(liteMenus.length);
                        }
                    } else if (m === 'lite') {
                         if(expertData.basic) {
                            liteData.basic.industryCd = expertData.basic.industryCd;
                            liteData.basic.monTargetPrice = expertData.basic.monTargetPrice;
                            liteData.basic.workDay = expertData.basic.workDay;
                         }
                         const expertMenus = expertData.sale.menu || [];
                         const liteMenus = liteData.sale.menu;
                         expertMenus.forEach((eMenu, i) => {
                             if(liteMenus[i]) {
                                 liteMenus[i].menuTitle = eMenu.menuTitle;
                                 liteMenus[i].menuPrice = eMenu.menuPrice;
                                 liteMenus[i].menuQty = eMenu.menuQty;
                             } else {
                                  liteMenus.push({
                                    menuTitle: eMenu.menuTitle, 
                                    menuPrice: eMenu.menuPrice, 
                                    menuQty: eMenu.menuQty 
                                  });
                             }
                         });
                         if(liteMenus.length > expertMenus.length) liteMenus.splice(expertMenus.length);
                         const res = expertResult.value;
                         const totalCost = (res.totalMaterialCost || 0) + (res.totalLaborCost || 0) + (res.totalExpense || 0) + (res.totalInterest || 0) + (res.totalDepreciation || 0);
                         if(!liteData.liteCost) liteData.liteCost = {};
                         liteData.liteCost.totalMonthlyCost = Math.round(totalCost);
                    }
                    
                    // 2. Switch Mode (Trigger Render)
                    mode.value = m;

                    // 3. Init Charts if Lite
                    // Charts removed

                    
                } catch(e) {
                    console.error("Mode switch error:", e);
                    alert("Î™®Îìú Ï†ÑÌôò Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: " + e.message);
                }
            };

            const investCategories = {
                'Ïú†ÌòïÏûêÏÇ∞': ['ÌÜ†ÏßÄ', 'Í±¥Î¨º', 'ÏãúÏÑ§Í≥µÏÇ¨ÎπÑ', 'Í∏∞Í≥ÑÏû•Ïπò', 'Ï∞®ÎüâÏö¥Î∞òÍµ¨', 'ÎπÑÌíàÍµ¨ÏûÖÎπÑ', 'Í∏∞ÌÉÄ Ïú†ÌòïÏûêÏÇ∞'],
                'Î¨¥ÌòïÏûêÏÇ∞': ['ÏòÅÏóÖÍ∂å(Í∂åÎ¶¨Í∏à)', 'ÏÇ∞ÏóÖÏû¨ÏÇ∞Í∂å', 'Í∞úÎ∞úÎπÑ', 'Í∞ÄÎßπÎπÑ(ÏÜåÎ©∏ÏÑ±)', 'Í∏∞ÌÉÄ Î¨¥ÌòïÏûêÏÇ∞'],
                'Í∏∞ÌÉÄÎπÑÏú†ÎèôÏûêÏÇ∞': ['ÏûÑÏ∞®Î≥¥Ï¶ùÍ∏à', 'Í∞ÄÎßπÎ≥¥Ï¶ùÍ∏à'],
                'Í∏∞ÌÉÄÌà¨ÏûêÎπÑÏö©': ['Ï¥àÎèôÏÉÅÌíà(Ïû¨Î£å)ÎπÑ', 'Í∞úÏóÖÏ†Ñ Í∏âÎ£å', 'Í∞úÏóÖÏ†Ñ ÏßÄÍ∏âÏûÑÏ∞®Î£å', 'Í∞úÏóÖÏ†Ñ ÌôçÎ≥¥ÎπÑÏö©', 'Í∞úÏóÖÏ†Ñ ÏßÄÍ∏âÏàòÏàòÎ£å', 'Í∏∞ÌÉÄ Ìà¨ÏûêÎπÑÏö©']
            };
            const loanCategories = {
                'ÏûêÍ∏∞ÏûêÍ∏à': ['ÏûêÎ≥∏Í∏à', 'Ï∂úÏûêÍ∏à', 'Ìà¨ÏûêÏûêÍ∏à', 'Í∏∞ÌÉÄÏûêÍ∏à'],
                'ÌÉÄÏù∏ÏûêÍ∏à': ['ÏÜåÏÉÅÍ≥µÏù∏ÏúµÏûê', 'ÏùÄÌñâÏúµÏûê', 'Í∏∞ÌÉÄÏ∞®ÏûÖÍ∏à']
            };




            const addMenu = (list) => list.push({ MenuTitle: '', MenuPrice: 0, MenuQty: 0 });

            // ================= CHARTS =================
            // Charts removed as per user request

             onMounted(() => {
                // No charts
            });

            const removeMenu = (list, idx, costRateList) => {
                list.splice(idx, 1);
                if(costRateList) costRateList.splice(idx, 1);
            };
            
            const addMenuExpert = () => {
                expertData.sale.menu.push({ menuTitle: '', menuPrice: 0, menuQty: 0 });
                expertData.cost.costRate.push(35); // Default to matching user sample
            };

            const addJob = (list) => list.push({ 
                jobTitle: '', jobCnt: 1, jobQty: 0, 
                jobAmt: Array(12).fill(0), 
                jobAmtYear: [0, 0, 0], 
                jobAmtCd: '1', jobAmtRate: 0 
            });

            const investCategoryItems = {
                '1': [
                    { cd: '10', name: 'ÌÜ†ÏßÄ' }, { cd: '20', name: 'Í±¥Î¨º' }, { cd: '30', name: 'ÏãúÏÑ§Í≥µÏÇ¨ÎπÑ' },
                    { cd: '40', name: 'Í∏∞Í≥ÑÏû•Ïπò' }, { cd: '50', name: 'Ï∞®ÎüâÏö¥Î∞òÍµ¨' }, { cd: '60', name: 'ÎπÑÌíàÍµ¨ÏûÖÎπÑ' },
                    { cd: '70', name: 'Í∏∞ÌÉÄ Ïú†ÌòïÏûêÏÇ∞' }
                ],
                '2': [
                    { cd: '10', name: 'ÏòÅÏóÖÍ∂å(Í∂åÎ¶¨Í∏à)' }, { cd: '20', name: 'ÏÇ∞ÏóÖÏû¨ÏÇ∞Í∂å' }, { cd: '30', name: 'Í∞úÎ∞úÎπÑ' },
                    { cd: '40', name: 'Í∞ÄÎßπÎπÑ(ÏÜåÎ©∏ÏÑ±)' }, { cd: '50', name: 'Í∏∞ÌÉÄ Î¨¥ÌòïÏûêÏÇ∞' }
                ],
                '3': [{ cd: '10', name: 'ÏûÑÏ∞®Î≥¥Ï¶ùÍ∏à' }, { cd: '20', name: 'Í∞ÄÎßπÎ≥¥Ï¶ùÍ∏à' }],
                '4': [
                    { cd: '10', name: 'Ï¥àÎèôÏÉÅÌíà(Ïû¨Î£å)ÎπÑ' }, { cd: '20', name: 'Í∞úÏóÖÏ†Ñ Í∏âÎ£å' }, { cd: '30', name: 'Í∞úÏóÖÏ†Ñ ÏßÄÍ∏âÏûÑÏ∞®Î£å' },
                    { cd: '40', name: 'Í∞úÏóÖÏ†Ñ ÌôçÎ≥¥ÎπÑÏö©' }, { cd: '50', name: 'Í∞úÏóÖÏ†Ñ ÏßÄÍ∏âÏàòÏàòÎ£å' }, { cd: '99', name: 'Í∏∞ÌÉÄ Ìà¨ÏûêÎπÑÏö©' }
                ]
            };

            const addInvest = (list, yn='Y', defaultItem = {}) => {
                list.push({ 
                    investTitle: defaultItem.name || '', 
                    investTitleCd: defaultItem.cd || '',
                    investPrice: 0, 
                    investYear: (yn === 'Y' ? 5 : 0), 
                    investYearAmt: 0, 
                    investYn: yn 
                });
            };

            const addInvestInCategory = (catIdx, sector) => {
                const key = sector === 'production' ? `production0${catIdx}` : `sales0${catIdx}`;
                const list = expertData.invest[sector][key];
                const yn = (catIdx <= 2) ? 'Y' : 'N';
                const items = investCategoryItems[catIdx] || [];
                addInvest(list, yn, items[0] || {});
            };

            const onInvestItemChange = (inv, catIdx) => {
                const items = investCategoryItems[catIdx] || [];
                const matched = items.find(i => i.cd === inv.investTitleCd);
                if(matched) {
                    inv.investTitle = matched.name;
                    // Land (1-10) and Premium (2-10) are non-depreciable
                    if ((catIdx === 1 && inv.investTitleCd === '10') || (catIdx === 2 && inv.investTitleCd === '10')) {
                        inv.investYn = 'N';
                        inv.investYear = 0;
                        inv.investYearAmt = 0;
                    } else if (catIdx <= 2) {
                        // Default back to Y for other items in cat 1,2
                        inv.investYn = 'Y';
                        inv.investYear = 5;
                    }
                }
            };

            const calcInvestTotals = (catIdx) => {
                const keyNum = catIdx + 1;
                const prodList = (expertData.invest && expertData.invest.production) ? expertData.invest.production[`production0${keyNum}`] || [] : [];
                const salesList = (expertData.invest && expertData.invest.sales) ? expertData.invest.sales[`sales0${keyNum}`] || [] : [];
                
                const sum = (list) => list.reduce((acc, curr) => {
                    acc.price += (curr.investPrice || 0);
                    acc.depr += (curr.investYearAmt || 0);
                    return acc;
                }, { price: 0, depr: 0 });

                return {
                    production: sum(prodList),
                    sales: sum(salesList),
                    total: sum([...prodList, ...salesList])
                };
            };

            const calcAllInvestTotals = () => {
                const results = {
                    production: { price: 0, depr: 0 },
                    sales: { price: 0, depr: 0 },
                    total: { price: 0, depr: 0 }
                };
                for(let i=0; i<4; i++) {
                    const cat = calcInvestTotals(i);
                    results.production.price += cat.production.price;
                    results.production.depr += cat.production.depr;
                    results.sales.price += cat.sales.price;
                    results.sales.depr += cat.sales.depr;
                    results.total.price += cat.total.price;
                    results.total.depr += cat.total.depr;
                }
                return results;
            };
            const calcLoanTotals = () => {
                const res = {
                    eq: [0, 0, 0],
                    db: [0, 0, 0],
                    intr: [0, 0, 0],
                    total: [0, 0, 0]
                };
                (expertData.loan.equity || []).forEach(l => {
                    for(let i=0; i<3; i++) {
                        const val = l.loanYear[i] || 0;
                        res.eq[i] += val;
                        res.total[i] += val;
                    }
                });
                (expertData.loan.debt || []).forEach(l => {
                    for(let i=0; i<3; i++) {
                        const val = l.loanYear[i] || 0;
                        res.db[i] += val;
                        res.total[i] += val;
                        res.intr[i] += (l.loanRateAmt[i] || 0);
                    }
                });
                return res;
            };
            const equityCategoryItems = [
                { cd: '10', name: 'ÏûêÎ≥∏Í∏à' },
                { cd: '20', name: 'Ï∂úÏûêÍ∏à' },
                { cd: '30', name: 'Ìà¨ÏûêÏûêÍ∏à' },
                { cd: '99', name: 'Í∏∞ÌÉÄÏûêÍ∏à' }
            ];

            const addLoan = (list, isDebt=false) => {
                const item = { 
                    loanTitle: isDebt ? '' : equityCategoryItems[0].name, 
                    loanTitleCd: isDebt ? '' : equityCategoryItems[0].cd,
                    loanYear: [0, 0, 0] 
                };
                if(isDebt) {
                    item.loanRate = [5.0, 5.0, 5.0];
                    item.loanRateAmt = [0, 0, 0];
                }
                list.push(item);
            };

            const onEquityCdChange = (ln) => {
                const matched = equityCategoryItems.find(i => i.cd === ln.loanTitleCd);
                if(matched) ln.loanTitle = matched.name;
            };

            const onDebtValueChange = (ln, type, idx) => {
                if(type === 'rate' && idx === 0) {
                    ln.loanRate[1] = ln.loanRate[0];
                    ln.loanRate[2] = ln.loanRate[0];
                }
                updateProjections();
            };
            const addExpense = (list) => list.push({ 
                expenseTitle: '', expenseTVaAmt: 0, 
                expenseAmt: Array(12).fill(0), 
                expenseAmtYear: [0, 0, 0] 
            });

            // ================= TABLE HELPERS =================
            const formatNumber = (val) => {
                if(isNaN(val)) return '0';
                return new Intl.NumberFormat('ko-KR').format(val);
            };

            const sumArrayIdx = (list, keyArrayName, idx) => {
                let sum = 0;
                if(!list || !Array.isArray(list)) return 0;
                list.forEach(item => {
                    if(item && item[keyArrayName] && Array.isArray(item[keyArrayName]) && item[keyArrayName][idx] !== undefined) {
                         sum += (Number(item[keyArrayName][idx]) || 0);
                    }
                });
                return sum;
            };

            // SERVER API
            const loadReports = async () => {
                try {
                    const res = await axios.get(`/api/report/`+userEmail.value);
                    reports.value = res.data;
                } catch(e) { console.error(e); }
            };

            const saveExpertReport = async () => {
                isSaving.value = true;
                const result = expertResult.value;
                
                // Construct payload
                const cleanData = JSON.parse(JSON.stringify(expertData));
                // 7-1-4 Filter MFG Expenses with 0 values
                if(cleanData.expense && cleanData.expense.production) {
                    cleanData.expense.production = cleanData.expense.production.filter(exp => {
                        const m = mfgExpMapping.find(map => map.title === exp.expenseTitle);
                        if(!m || m.baseType === 'fixed') return (exp.expenseTVaAmt || 0) > 0;
                        return (exp.expenseTVa || 0) > 0;
                    });
                }

                const payload = {
                    mode: 'expert',
                    id: currentReportId.value, // Send ID for Update
                    ...cleanData,
                    summary: { ...result } // Snapshot results
                };

                try {
                     await axios.post('/api/report', { userId: userEmail.value, content: payload, id: currentReportId.value });
                     alert('Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!');
                     loadReports();
                } catch(e) {
                    alert('Ï†ÄÏû• Ïã§Ìå®: ' + e.message);
                } finally {
                    isSaving.value = false;
                }
            };

            const loadReportToCanvas = (rpt) => {
                currentReportId.value = rpt.id;
                try {
                    let data = JSON.parse(rpt.reportData);

                    // Deep Migration Helper
                    const migrate = (obj) => {
                        if (!obj || typeof obj !== 'object') return obj;
                        if (Array.isArray(obj)) return obj.map(migrate);
                        const newObj = {};
                        for (let k in obj) {
                            let nk = k;
                            // Key mapping
                            if(k === 'BASIC') nk = 'basic';
                            else if(k === 'SALE') nk = 'sale';
                            else if(k === 'COST') nk = 'cost';
                            else if(k === 'JOB') nk = 'job';
                            else if(k === 'INVEST') nk = 'invest';
                            else if(k === 'LOAN') nk = 'loan';
                            else if(k === 'EXPENSE') nk = 'expense';
                            else if(k === 'LITE_COST') nk = 'liteCost';
                            else if(k === 'MenuTitle') nk = 'menuTitle';
                            else if(k === 'MenuPrice') nk = 'menuPrice';
                            else if(k === 'MenuQty' || k === 'BaseQty') nk = 'menuQty';
                            else if(k === 'JobTitle') nk = 'jobTitle';
                            else if(k === 'JobCnt') nk = 'jobCnt';
                            else if(k === 'JobQty') nk = 'jobQty';
                            else if(k.startsWith('YMenu')) nk = 'menu' + k.slice(5).charAt(0).toLowerCase() + k.slice(6);
                            else if(k.startsWith('YCost')) nk = 'cost' + k.slice(5).charAt(0).toLowerCase() + k.slice(6);
                            else if(k === 'YJobAmt') nk = 'jobAmtYear';
                            else if(k === 'YJobRate') nk = 'jobAmtRate';
                            
                            newObj[nk] = migrate(obj[k]);
                        }
                        return newObj;
                    };

                    data = migrate(data);

                    if(data.mode === 'expert') {
                        mode.value = 'expert';
                        // Keep current structure but overwrite with loaded data
                        Object.assign(expertData.basic, data.basic || {});
                        if(data.sale) Object.assign(expertData.sale, data.sale);
                        if(data.cost) Object.assign(expertData.cost, data.cost);
                        
                        // Handle Job nesting
                        if(data.job) {
                            if(data.job.production) expertData.job.production = data.job.production;
                            if(data.job.sales) expertData.job.sales = data.job.sales;
                        }

                        // Handle Invest
                        if(data.invest) {
                            if(data.invest.production) {
                                Object.assign(expertData.invest.production, data.invest.production);
                            }
                            if(data.invest.sales) {
                                Object.assign(expertData.invest.sales, data.invest.sales);
                            }
                        }

                        // Handle Loan
                        if(data.loan) {
                            if(data.loan.equity) expertData.loan.equity = data.loan.equity;
                            if(data.loan.debt) expertData.loan.debt = data.loan.debt;
                        }

                        // Handle Expense
                        if(data.expense) {
                            if(data.expense.production) {
                                // Merge into fixed 24 items
                                const loaded = data.expense.production;
                                expertData.expense.production.forEach(def => {
                                    const match = loaded.find(l => l.expenseTitle === def.expenseTitle);
                                    if(match) {
                                        Object.assign(def, match);
                                    } else {
                                        // Reset to zero if not in saved data
                                        def.expenseTVaAmt = 0;
                                        def.expenseTVa = 0;
                                        def.expenseAmt = Array(12).fill(0);
                                        def.expenseAmtYear = [0, 0, 0];
                                    }
                                });
                            }
                            if(data.expense.sales) expertData.expense.sales = data.expense.sales;
                        }

                        // Ensure required arrays exist
                        if(!expertData.sale.menu) expertData.sale.menu = [];
                        if(!expertData.sale.menuY) expertData.sale.menuY = [];
                        if(!expertData.cost.costRate) expertData.cost.costRate = [];
                        if(!expertData.cost.costY) expertData.cost.costY = [];
                        
                        updateProjections(); 
                    } else {
                        mode.value = 'lite';
                        Object.assign(liteData.basic, data.basic || {});
                        if(data.sale) Object.assign(liteData.sale, data.sale);
                        if(data.liteCost) Object.assign(liteData.liteCost, data.liteCost);
                    }
                } catch(e) { console.error("Load error:", e); }
            };

            const deleteReport = async (id) => {
                if(!confirm('Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
                try {
                    await axios.delete(`/api/report/${id}`);
                    alert('ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
                    loadReports();
                    if(currentReportId.value === id) currentReportId.value = null;
                } catch(e) {
                    alert('ÏÇ≠Ï†ú Ïã§Ìå®: ' + e.message);
                }
            };

            onMounted(() => {
                loadReports();
            });

            return {
                mode, userEmail, isSaving, reports, showProjectionModal, showMaterialModal,
                liteData, expertData,
                liteResult, expertResult,
                switchMode,
                addMenu, removeMenu, addMenuExpert,
                addJob, addInvest, addLoan, addExpense,
                calcMenuMonthlyRevenue,
                formatCurrency, formatCurrencyCheon, formatDate, parseReport, getReportValues, loadReports, saveExpertReport, loadReportToCanvas, deleteReport, formatNumber, sumArrayIdx,
                showYearlyModal, currentMenu, currentYearly,
                openYearlyModal, closeYearlyModal, saveYearlyModal, calcYearly, calcYearlyDirect, onYMenuCdChange,
                showMaterialYearlyModal, currentMaterialYearly, openMaterialYearlyModal, closeMaterialYearlyModal, saveMaterialYearly, calcMaterialYearly,
                showLaborModal,
                showLaborYearlyModal, currentLaborYearly, openLaborYearlyModal, closeLaborYearlyModal, saveLaborYearly, calcLaborYearly,
                investCategories, loanCategories,
                addInvestInCategory, investCategoryItems, onInvestItemChange, calcInvestTotals, calcAllInvestTotals,
                equityCategoryItems, onEquityCdChange, onDebtValueChange, calcLoanTotals,
                mfgExpMapping
            };
        }
    }).mount('#app');
</script>
</body>
</html>
