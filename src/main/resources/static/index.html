<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlanfAi - ÏÜåÏÉÅÍ≥µÏù∏ ÏàòÏùµ Î∂ÑÏÑù</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link href="/common/common.css" rel="stylesheet">
    
    <!-- CDN Dependencies -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/common/common.js"></script>
</head>
<body>

<div id="app" class="container">
    <div class="glass-container">
        <!-- Header -->
        <header class="d-flex justify-content-between align-items-center mb-5">
            <div>
                <h1 class="display-5 mb-0" style="background: linear-gradient(to right, #6366f1, #ec4899); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent;">PlanfAi</h1>
                <p class="text-muted lead">ÏÜåÏÉÅÍ≥µÏù∏ Ïä§ÎßàÌä∏ ÏàòÏùµ Î∂ÑÏÑù ÏãúÏä§ÌÖú</p>
            </div>
            <div class="d-flex gap-2">
                 <div class="input-group">
                    <span class="input-group-text bg-white">ID</span>
                     <input type="text" class="form-control" v-model="userEmail" placeholder="Ïù¥Î©îÏùº ÏûÖÎ†•">
                 </div>
                 <button class="btn btn-outline-primary" @click="loadReports">Î∂àÎü¨Ïò§Í∏∞</button>
            </div>
        </header>

        <!-- Mode Switcher -->
        <div class="mode-switch-container">
            <div class="mode-switch">
                <button :class="{ active: mode === 'lite' }" @click="switchMode('lite')">üå± Í∞ÑÌé∏ Î™®Îìú</button>
                <button :class="{ active: mode === 'expert' }" @click="switchMode('expert')">üöÄ Ï†ÑÎ¨∏Í∞Ä Î™®Îìú</button>
            </div>
        </div>

            <!-- LITE MODE -->
            <div v-if="mode === 'lite'" key="lite">
                <div class="row g-4">
                    <div class="col-lg-5">
                        <div class="card-expert">
                            <div class="expert-header">
                                <h5>üìù Í∏∞Î≥∏ Ï†ïÎ≥¥ ÏûÖÎ†•</h5>
                            </div>
                            <div class="expert-body">
                                <div class="mb-3">
                                    <label class="form-label small fw-bold">ÏóÖÏ¢Ö ÏÑ†ÌÉù</label>
                                    <select class="form-select" v-model="liteData.BASIC.industryCd">
                                        <option value="1">Ï†úÏ°∞ÏóÖ</option>
                                        <option value="2">ÏÜåÎß§ÏóÖ</option>
                                        <option value="3">Ïô∏ÏãùÏóÖ</option>
                                        <option value="4">ÏãúÏÑ§ÏÑúÎπÑÏä§ÏóÖ</option>
                                        <option value="5">Ïö©Ïó≠ÏÑúÎπÑÏä§ÏóÖ</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label small fw-bold">Ïõî Î™©Ìëú ÏàúÏù¥Ïùµ</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" v-model.number="liteData.BASIC.monTargetPrice">
                                        <span class="input-group-text">Ïõê</span>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label small fw-bold d-flex justify-content-between">
                                        <span>Ïõî ÏòÅÏóÖÏùºÏàò</span>
                                        <span class="text-primary">{{ liteData.BASIC.workDay }}Ïùº</span>
                                    </label>
                                    <input type="range" class="form-range" min="1" max="31" v-model.number="liteData.BASIC.workDay">
                                </div>

                                <hr class="my-4" style="opacity: 0.1">

                                <h6 class="mb-3 text-primary">ÌåêÎß§ Î©îÎâ¥ ÏûÖÎ†•</h6>
                                <div v-for="(menu, idx) in liteData.SALE.menu" :key="idx" class="mb-3 p-3 bg-light rounded-3 text-end position-relative">
                                    <button class="btn-close position-absolute top-0 end-0 m-2" @click="removeMenu(liteData.SALE.menu, idx)" style="font-size: 0.7rem;"></button>
                                    <div class="row g-2 mb-2">
                                        <div class="col-12">
                                            <input type="text" class="form-control form-control-sm" v-model="menu.MenuTitle" placeholder="Î©îÎâ¥Î™Ö (Ïòà: ÏïÑÎ©îÎ¶¨Ïπ¥ÎÖ∏)">
                                        </div>
                                        <div class="col-6">
                                            <div class="input-group input-group-sm">
                                                <input type="number" class="form-control" v-model.number="menu.MenuPrice" placeholder="Îã®Í∞Ä">
                                                <span class="input-group-text">Ïõê</span>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="input-group input-group-sm">
                                                <input type="number" class="form-control" v-model.number="menu.MenuQty" placeholder="ÌïòÎ£® ÌåêÎß§Îüâ">
                                                <span class="input-group-text">Í∞ú</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <button class="btn btn-outline-primary w-100 btn-sm mb-4" @click="addMenu(liteData.SALE.menu)">+ Î©îÎâ¥ Ï∂îÍ∞Ä</button>

                                <div class="mb-3">
                                    <label class="form-label small fw-bold">Ïõî ÎåÄÎûµÏ†Å ÎπÑÏö© (Í≥†Ï†ïÎπÑ+Î≥ÄÎèôÎπÑ)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" v-model.number="liteData.LITE_COST.totalMonthlyCost" placeholder="Ï¥ù ÎπÑÏö© ÏûÖÎ†•">
                                        <span class="input-group-text">Ïõê</span>
                                    </div>
                                    <div class="form-text">Ïû¨Î£åÎπÑ, ÏõîÏÑ∏, Ïù∏Í±¥ÎπÑ Îì±ÏùÑ Ìï©Ïπú ÎåÄÎûµÏ†ÅÏù∏ Í∏àÏï°</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-7">
                        <div class="card-expert h-100 bg-white">
                            <div class="expert-header bg-white border-bottom-0">
                                <h5>üìä Î∂ÑÏÑù Í≤∞Í≥º</h5>
                            </div>
                            <div class="expert-body text-center pt-0">
                                <div class="py-5">
                                    <h6 class="text-uppercase text-muted small mb-2">ÌòÑÏû¨ ÏòàÏÉÅ ÏàúÏù¥Ïùµ</h6>
                                    <h2 class="display-4 fw-bold mb-3" :class="liteResult.netProfit >= 0 ? 'text-primary' : 'text-danger'">
                                        {{ formatCurrency(liteResult.netProfit) }}
                                    </h2>
                                    
                                    <!-- Target Gap Analysis -->
                                    <div class="alert mt-4" :class="liteResult.gap >= 0 ? 'alert-success' : 'alert-warning'">
                                        <span v-if="liteResult.gap >= 0">
                                            üéâ <strong>Ï∂ïÌïòÌï©ÎãàÎã§!</strong> Î™©Ìëú ÏàòÏùµÎ≥¥Îã§ {{ formatCurrency(liteResult.gap) }} Ï¥àÍ≥º Îã¨ÏÑ± Ï§ëÏûÖÎãàÎã§.
                                        </span>
                                        <span v-else>
                                            üí™ <strong>Ï°∞Í∏àÎßå Îçî!</strong> Î™©Ìëú({{ formatCurrency(liteData.BASIC.monTargetPrice) }})ÍπåÏßÄ <strong class="text-danger">{{ formatCurrency(Math.abs(liteResult.gap)) }}</strong>Ïù¥ Îçî ÌïÑÏöîÌï©ÎãàÎã§.
                                        </span>
                                    </div>

                                    <!-- Action Item -->
                                    <div class="card bg-light border-0 p-3 mt-4 text-start shadow-sm" v-if="liteData.SALE.menu.length > 0 && liteResult.gap < 0">
                                        <div class="d-flex align-items-center mb-2 justify-content-between">
                                            <div>
                                                <span class="badge bg-primary me-2">Action Item</span>
                                                <span class="fw-bold">ÌòÑÏã§Ï†Å ÎåÄÏïà</span>
                                            </div>
                                            <span class="badge bg-danger-subtle text-danger">ÏÑ±Í≥µ ÌôïÎ•† 85% üî•</span>
                                        </div>
                                        <p class="mb-0 text-muted small">
                                            "{{ liteData.SALE.menu[0].MenuTitle }}" Î©îÎâ¥Î•º ÌïòÎ£®Ïóê 
                                            <strong class="text-dark fs-5">{{ Math.ceil(Math.abs(liteResult.gap) / (liteData.SALE.menu[0].MenuPrice * liteData.BASIC.workDay)) }}Í∞ú</strong> 
                                            Îßå Îçî ÌåîÎ©¥ Î™©Ìëú Îã¨ÏÑ±!
                                        </p>
                                    </div>



                                    <!-- Time-based Table -->
                                    <div class="mt-4">
                                        <h6 class="text-start small fw-bold mb-2">‚è±Ô∏è ÏãúÍ∞ÑÎ≥Ñ ÌôòÏÇ∞ ÌÖåÏù¥Î∏î</h6>
                                        <table class="table table-sm table-bordered text-center small mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Íµ¨Î∂Ñ</th>
                                                    <th>Ïùº (1Ïùº)</th>
                                                    <th>Ïõî ({{ liteData.BASIC.workDay }}Ïùº)</th>
                                                    <th>ÎÖÑ (12Í∞úÏõî)</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td class="bg-light fw-bold">Îß§Ï∂ú</td>
                                                    <td>{{ formatCurrency(liteResult.revenue / liteData.BASIC.workDay) }}</td>
                                                    <td>{{ formatCurrency(liteResult.revenue) }}</td>
                                                    <td>{{ formatCurrency(liteResult.revenue * 12) }}</td>
                                                </tr>
                                                 <tr>
                                                    <td class="bg-light fw-bold">ÎπÑÏö©(ÏòàÏÉÅ)</td>
                                                    <td>{{ formatCurrency(liteData.LITE_COST.totalMonthlyCost / liteData.BASIC.workDay) }}</td>
                                                    <td>{{ formatCurrency(liteData.LITE_COST.totalMonthlyCost) }}</td>
                                                    <td>{{ formatCurrency(liteData.LITE_COST.totalMonthlyCost * 12) }}</td>
                                                </tr>
                                                <tr :class="liteResult.netProfit >= 0 ? 'table-primary' : 'table-danger'">
                                                    <td class="fw-bold">ÏàòÏùµ</td>
                                                    <td class="fw-bold">{{ formatCurrency(liteResult.netProfit / liteData.BASIC.workDay) }}</td>
                                                    <td class="fw-bold">{{ formatCurrency(liteResult.netProfit) }}</td>
                                                    <td class="fw-bold">{{ formatCurrency(liteResult.netProfit * 12) }}</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>

                                    <!-- BEP Visualization (Simplified) -->
                                    <div class="mt-4 text-start">
                                        <h6 class="small fw-bold mb-2">‚öñÔ∏è ÏÜêÏùµÎ∂ÑÍ∏∞Ï†ê (BEP) ÏãúÍ∞ÅÌôî</h6>
                                        <div class="position-relative pt-2 pb-4">
                                            <div class="progress" style="height: 10px;">
                                                <div class="progress-bar bg-success" role="progressbar" :style="{ width: Math.min(100, (liteResult.revenue / (liteData.LITE_COST.totalMonthlyCost || 1)) * 50) + '%' }"></div>
                                                <div class="progress-bar bg-warning" role="progressbar" style="width: 2px; position: absolute; left: 50%; height: 100%; top: 0; z-index: 5;"></div>
                                            </div>
                                            <div class="d-flex justify-content-between mt-1 small text-muted">
                                                <span>ÏÜêÏã§ Íµ¨Í∞Ñ</span>
                                                <span class="text-primary fw-bold">ÏàòÏùµ Íµ¨Í∞Ñ</span>
                                            </div>
                                            <p class="small text-center mt-2 text-dark bg-warning-subtle p-2 rounded">
                                                "ÏÇ¨Ïû•ÎãòÏùÄ Îß§Îã¨ <strong>{{ Math.min(liteData.BASIC.workDay, Math.ceil((liteData.LITE_COST.totalMonthlyCost / (liteResult.revenue / liteData.BASIC.workDay)) || 0)) }}ÏùºÏß∏</strong> ÎêòÎäî ÎÇ†Î∂ÄÌÑ∞ ÏßÑÏßú ÏàòÏùµÏù¥ Î∞úÏÉùÌï©ÎãàÎã§."
                                            </p>
                                        </div>
                                    </div>

                                    <hr class="my-4">

                                    <!-- Hooks (Visual Compensation & Natural Hooks) -->
                                    <div class="hooks-container text-start">
                                        <!-- Hook 1 -->
                                        <div class="card border-primary border-opacity-25 mb-3">
                                             <div class="card-body p-3 bg-primary bg-opacity-10">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <div>
                                                        <h6 class="fw-bold text-primary mb-1">üßê ÎπÑÏö© Ìö®Ïú®ÏÑ± ÏßÑÎã®</h6>
                                                        <p class="small mb-2" style="font-size: 0.85rem;">
                                                            Î∞©Í∏à ÏûÖÎ†•ÌïòÏã† ÎπÑÏö© {{ formatCurrency(liteData.LITE_COST.totalMonthlyCost) }}, ÎèôÏ¢Ö ÏóÖÍ≥Ñ ÌèâÍ∑†Î≥¥Îã§ <span class="text-danger fw-bold">12% ÎÜíÍ≤å</span> Ï∏°Ï†ïÎêòÏóàÏäµÎãàÎã§.
                                                        </p>
                                                    </div>
                                                    <span class="fs-4">üí∏</span>
                                                </div>
                                                <button class="btn btn-sm btn-outline-primary w-100 bg-white" @click="switchMode('expert')">ÎÇ¥ Ïù∏Í±¥ÎπÑ¬∑ÏûÑÏ∞®Î£å ÏÉÅÏÑ∏ ÏßÑÎã®ÌïòÍ≥† ÎÇ≠ÎπÑ Ï§ÑÏù¥Í∏∞</button>
                                             </div>
                                        </div>

                                        <!-- Hook 2 -->
                                        <div class="card border-warning border-opacity-25 mb-3">
                                             <div class="card-body p-3 bg-warning bg-opacity-10">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <div>
                                                        <h6 class="fw-bold text-dark mb-1">‚ö†Ô∏è Î¶¨Ïä§ÌÅ¨ ÏãúÎÆ¨Î†àÏù¥ÏÖò</h6>
                                                        <p class="small mb-2" style="font-size: 0.85rem;">
                                                            Îß§Ï∂úÏù¥ 10%Îßå Îñ®Ïñ¥Ï†∏ÎèÑ ÏàúÏù¥ÏùµÏù¥ Ï†àÎ∞òÏúºÎ°ú Ï§ÑÏñ¥Îì§ Ïàò ÏûàÏäµÎãàÎã§.
                                                        </p>
                                                    </div>
                                                    <span class="fs-4">üìâ</span>
                                                </div>
                                                <button class="btn btn-sm btn-outline-dark w-100 bg-white" @click="switchMode('expert')">Î¶¨Ïä§ÌÅ¨ ÌôïÏù∏ÌïòÍ∏∞</button>
                                             </div>
                                        </div>
                                        
                                        <!-- Hook 3 -->
                                        <div class="card border-info border-opacity-25">
                                             <div class="card-body p-3 bg-info bg-opacity-10">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <div>
                                                        <h6 class="fw-bold text-dark mb-1">üè≠ Ï†úÏ°∞/ÏãùÎãπÏù¥Ïã†Í∞ÄÏöî?</h6>
                                                        <p class="small mb-2" style="font-size: 0.85rem;">
                                                            Í≥µÏû•(Ï£ºÎ∞©) Í≤ΩÎπÑÏôÄ Îß§Ïû• Í≤ΩÎπÑÎ•º Î∂ÑÎ¶¨ÌïòÎ©¥ ÏÑ∏Í∏àÏùÑ ÏïÑÎÇÑ Ïàò ÏûàÏäµÎãàÎã§.
                                                        </p>
                                                    </div>
                                                    <span class="fs-4">üèóÔ∏è</span>
                                                </div>
                                                <button class="btn btn-sm btn-outline-info w-100 bg-white text-dark" @click="switchMode('expert')">Ï†àÏÑ∏ Ï†ÑÎûµ Î≥¥Í∏∞</button>
                                             </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- EXPERT MODE -->
            <div v-else key="expert">
                <div class="row">
                    <!-- Left: Input Sections -->
                    <div class="col-lg-6">
                        <div class="accordion" id="expertAccordion">
                            
                            <!-- 1. Basic Setup -->
                            <div class="accordion-item border-0 mb-3 shadow-sm rounded-3 overflow-hidden">
                                <h2 class="accordion-header">
                                    <button class="accordion-button fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBasic">
                                        <span class="section-badge">1Îã®Í≥Ñ</span> Í∏∞Î≥∏ ÌôòÍ≤Ω ÏÑ§Ï†ï
                                    </button>
                                </h2>
                                <div id="collapseBasic" class="accordion-collapse collapse show" data-bs-parent="#expertAccordion">
                                    <div class="accordion-body bg-light">
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label class="form-label small">ÏóÖÏ¢Ö</label>
                                                <select class="form-select form-select-sm" v-model="expertData.BASIC.industryCd">
                                                    <option value="1">Ï†úÏ°∞ÏóÖ</option>
                                                    <option value="2">ÏÜåÎß§ÏóÖ</option>
                                                    <option value="3">Ïô∏ÏãùÏóÖ</option>
                                                    <option value="4">ÏãúÏÑ§ÏÑúÎπÑÏä§ÏóÖ</option>
                                                    <option value="5">Ïö©Ïó≠ÏÑúÎπÑÏä§ÏóÖ</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label small">ÌåêÎß§ Í∏∞Ï§Ä</label>
                                                <select class="form-select form-select-sm" v-model="expertData.BASIC.saleMode">
                                                    <option value="1">Ïùº ÌåêÎß§Îüâ Í∏∞Ï§Ä (X ÏòÅÏóÖÏùº)</option>
                                                    <option value="2">Ïõî ÌåêÎß§Îüâ Í∏∞Ï§Ä</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label small">Ïõî ÏòÅÏóÖÏùºÏàò</label>
                                                <input type="number" class="form-control form-control-sm" v-model.number="expertData.BASIC.workDay">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label small">Î™©Ìëú ÏàúÏù¥Ïùµ</label>
                                                <input type="number" class="form-control form-control-sm" v-model.number="expertData.BASIC.monTargetPrice">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 2. Sales & Cost Plan -->
                            <div class="accordion-item border-0 mb-3 shadow-sm rounded-3 overflow-hidden">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSales">
                                        <span class="section-badge">2Îã®Í≥Ñ</span> Îß§Ï∂ú Î∞è Ïû¨Î£åÎπÑ Í≥ÑÌöç
                                    </button>
                                </h2>
                                <div id="collapseSales" class="accordion-collapse collapse" data-bs-parent="#expertAccordion">
                                    <div class="accordion-body bg-light p-2">
                                        <div v-for="(menu, idx) in expertData.SALE.menu" :key="idx" class="card mb-2 border-0 shadow-sm">
                                            <div class="card-body p-3 position-relative">
                                                <button class="btn-close position-absolute top-0 end-0 m-2" @click="removeMenu(expertData.SALE.menu, idx, expertData.COST.cost)"></button>
                                                
                                                <div class="mb-2">
                                                    <input type="text" class="form-control form-control-sm fw-bold border-0 bg-light mb-1" v-model="menu.MenuTitle" placeholder="Î©îÎâ¥Î™Ö">
                                                </div>
                                                <div class="row g-2">
                                                    <div class="col-4">
                                                        <label class="small text-muted">ÌåêÎß§Îã®Í∞Ä</label>
                                                        <input type="number" class="form-control form-control-sm" v-model.number="menu.MenuPrice">
                                                    </div>
                                                    <div class="col-4">
                                                        <label class="small text-muted">{{ expertData.BASIC.saleMode == '1' ? 'Ïùº ÌåêÎß§Îüâ' : 'Ïõî ÌåêÎß§Îüâ' }}</label>
                                                        <input type="number" class="form-control form-control-sm" v-model.number="menu.MenuQty">
                                                    </div>
                                                    <div class="col-4">
                                                        <label class="small text-muted">Ïû¨Î£åÎπÑÏú®(%)</label>
                                                        <input type="number" class="form-control form-control-sm" v-if="expertData.COST.cost[idx]" v-model.number="expertData.COST.cost[idx].costRate">
                                                    </div>
                                                </div>
                                                <div class="mt-2 d-flex justify-content-between align-items-center">
                                                    <div class="small text-muted">
                                                        <div>ÏòàÏÉÅ Ïõî Îß§Ï∂ú: <strong class="text-primary">{{ formatCurrency(calcMenuMonthlyRevenue(menu)) }}</strong></div>
                                                        <div>ÏòàÏÉÅ Ïõî Ïû¨Î£åÎπÑ: <strong class="text-danger">{{ formatCurrency(Math.round(calcMenuMonthlyRevenue(menu) * (expertData.COST.cost[idx]?.costRate || 0) / 100)) }}</strong></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <button class="btn btn-outline-secondary w-100 btn-sm" @click="addMenuExpert">+ Î©îÎâ¥ Ï∂îÍ∞Ä</button>
                                    </div>
                                </div>
                            </div>

                            <!-- 3. Labor Plan -->
                            <div class="accordion-item border-0 mb-3 shadow-sm rounded-3 overflow-hidden">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapseLabor">
                                        <span class="section-badge">3Îã®Í≥Ñ</span> Ïù∏Í±¥ÎπÑ Í≥ÑÌöç
                                    </button>
                                </h2>
                                <div id="collapseLabor" class="accordion-collapse collapse" data-bs-parent="#expertAccordion">
                                    <div class="accordion-body bg-light">
                                        
                                        <!-- Job 01 Mfg (Moved to Top) -->
                                        <h6 class="small text-muted fw-bold mb-2">ÏÉùÏÇ∞/Ï†úÏ°∞ÏßÅ (Ï†úÏ°∞ÏõêÍ∞Ä)</h6>
                                        <div v-for="(job, idx) in expertData.JOB.job01" :key="'j1'+idx" class="mb-3 p-2 bg-white rounded border border-light shadow-sm">
                                            <div class="d-flex gap-2 mb-2 align-items-center">
                                                <input type="text" class="form-control form-control-sm" v-model="job.JobTitle" placeholder="ÏßÅÏ±Ö" style="width: 30%">
                                                <input type="number" class="form-control form-control-sm" v-model.number="job.JobCnt" placeholder="Ïù∏Ïõê" style="width: 20%">
                                                <input type="number" class="form-control form-control-sm" v-model.number="job.JobQty" placeholder="Ïõî Í∏âÏó¨" style="width: 40%">
                                                <button class="btn-close" @click="expertData.JOB.job01.splice(idx, 1)"></button>
                                            </div>
                                            <div class="text-end small text-muted px-1">
                                                Ïõî Ïù∏Í±¥ÎπÑ: <strong class="text-primary">{{ formatCurrency((job.JobCnt || 0) * (job.JobQty || 0)) }}</strong>
                                            </div>
                                        </div>
                                        <button class="btn btn-sm btn-light w-100 border mb-4" @click="addJob(expertData.JOB.job01)">+ Ïù∏Ïõê Ï∂îÍ∞Ä</button>

                                        <!-- Job 02 Sales/Admin (Moved to Bottom) -->
                                        <h6 class="small text-muted fw-bold mb-2">ÌåêÎß§/Í¥ÄÎ¶¨ÏßÅ (ÌåêÍ¥ÄÎπÑ)</h6>
                                        <div v-for="(job, idx) in expertData.JOB.job02" :key="'j2'+idx" class="mb-3 p-2 bg-white rounded border border-light shadow-sm">
                                            <div class="d-flex gap-2 mb-2 align-items-center">
                                                <input type="text" class="form-control form-control-sm" v-model="job.JobTitle" placeholder="ÏßÅÏ±Ö/ÏÑ±Î™Ö" style="width: 30%">
                                                <input type="number" class="form-control form-control-sm" v-model.number="job.JobCnt" placeholder="Ïù∏Ïõê" style="width: 20%">
                                                <input type="number" class="form-control form-control-sm" v-model.number="job.JobQty" placeholder="Ïõî Í∏âÏó¨" style="width: 40%">
                                                <button class="btn-close" @click="expertData.JOB.job02.splice(idx, 1)"></button>
                                            </div>
                                            <div class="text-end small text-muted px-1">
                                                Ïõî Ïù∏Í±¥ÎπÑ: <strong class="text-primary">{{ formatCurrency((job.JobCnt || 0) * (job.JobQty || 0)) }}</strong>
                                            </div>
                                        </div>
                                        <button class="btn btn-sm btn-light w-100 border" @click="addJob(expertData.JOB.job02)">+ Ïù∏Ïõê Ï∂îÍ∞Ä</button>
                                    </div>
                                </div>
                            </div>

                            <!-- 4. Invest & Loan -->
                             <div class="accordion-item border-0 mb-3 shadow-sm rounded-3 overflow-hidden">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInvest">
                                        <span class="section-badge">4Îã®Í≥Ñ</span> Ìà¨Ïûê Î∞è ÏûêÍ∏àÏ°∞Îã¨
                                    </button>
                                </h2>
                                <div id="collapseInvest" class="accordion-collapse collapse" data-bs-parent="#expertAccordion">
                                    <div class="accordion-body bg-light">
                                        <h6 class="small text-muted fw-bold">Í∞êÍ∞ÄÏÉÅÍ∞Å ÎåÄÏÉÅ ÏûêÏÇ∞ (Ïù∏ÌÖåÎ¶¨Ïñ¥ Îì±)</h6>
                                        <div v-for="(inv, idx) in expertData.INVEST.invest02" :key="'i'+idx" class="row g-1 mb-2">
                                            <div class="col-4"><input type="text" class="form-control form-control-sm" v-model="inv.investTitle" placeholder="Ìï≠Î™©"></div>
                                            <div class="col-3"><input type="number" class="form-control form-control-sm" v-model.number="inv.investPrice" placeholder="Í∏àÏï°"></div>
                                            <div class="col-2"><input type="number" class="form-control form-control-sm" v-model.number="inv.investYear" placeholder="ÎÖÑÏàò"></div>
                                            <div class="col-2">
                                                <select class="form-select form-select-sm" v-model="inv.investYn">
                                                    <option value="Y">ÏÉÅÍ∞Å</option>
                                                    <option value="N">ÎØ∏ÏÉÅÍ∞Å</option>
                                                </select>
                                            </div>
                                            <div class="col-1"><button class="btn-close" @click="expertData.INVEST.invest02.splice(idx,1)"></button></div>
                                        </div>
                                        <button class="btn btn-sm btn-light w-100 border mb-4" @click="addInvest(expertData.INVEST.invest02)">+ ÏãúÏÑ§/ÎπÑÌíà Ï∂îÍ∞Ä</button>

                                        <h6 class="small text-muted fw-bold">Í∏∞ÌÉÄ Ìà¨Ïûê (Í∂åÎ¶¨Í∏à/Î≥¥Ï¶ùÍ∏à Îì±)</h6>
                                        <div v-for="(inv, idx) in expertData.INVEST.invest04" :key="'i4'+idx" class="row g-1 mb-2">
                                            <div class="col-6"><input type="text" class="form-control form-control-sm" v-model="inv.investTitle" placeholder="Í∂åÎ¶¨Í∏à/Í∏∞ÌÉÄ(ÏÉÅÍ∞Å)"></div>
                                            <div class="col-4"><input type="number" class="form-control form-control-sm" v-model.number="inv.investPrice" placeholder="Í∏àÏï°"></div>
                                            <div class="col-2"><button class="btn-close" @click="expertData.INVEST.invest04.splice(idx,1)"></button></div>
                                        </div>
                                        <button class="btn btn-sm btn-light w-100 border mb-2" @click="addInvest(expertData.INVEST.invest04, 'N')">+ Í∂åÎ¶¨Í∏à/Í∏∞ÌÉÄ Ï∂îÍ∞Ä</button>

                                        <div v-for="(inv, idx) in expertData.INVEST.invest06" :key="'i6'+idx" class="row g-1 mb-2">
                                            <div class="col-6"><input type="text" class="form-control form-control-sm" v-model="inv.investTitle" placeholder="Î≥¥Ï¶ùÍ∏à(ÎπÑÏÉÅÍ∞Å)"></div>
                                            <div class="col-4"><input type="number" class="form-control form-control-sm" v-model.number="inv.investPrice" placeholder="Í∏àÏï°"></div>
                                            <div class="col-2"><button class="btn-close" @click="expertData.INVEST.invest06.splice(idx,1)"></button></div>
                                        </div>
                                        <button class="btn btn-sm btn-light w-100 border mb-4" @click="addInvest(expertData.INVEST.invest06, 'N')">+ Î≥¥Ï¶ùÍ∏à Ï∂îÍ∞Ä</button>

                                        <h6 class="small text-muted fw-bold">ÎåÄÏ∂úÍ∏à (Ïù¥ÏûêÎπÑÏö©)</h6>
                                         <div v-for="(loan, idx) in expertData.LOAN.loan02" :key="'l'+idx" class="row g-1 mb-2">
                                            <div class="col-5"><input type="text" class="form-control form-control-sm" v-model="loan.loanTitle" placeholder="ÎåÄÏ∂úÎ™Ö"></div>
                                            <div class="col-4"><input type="number" class="form-control form-control-sm" v-if="loan.loanYear" v-model.number="loan.loanYear[0]" placeholder="ÏõêÍ∏à"></div>
                                            <div class="col-2"><input type="number" class="form-control form-control-sm" v-if="loan.loanRate" v-model.number="loan.loanRate[0]" placeholder="Ïù¥Ïú®%"></div>
                                            <div class="col-1"><button class="btn-close" @click="expertData.LOAN.loan02.splice(idx,1)"></button></div>
                                        </div>
                                         <button class="btn btn-sm btn-light w-100 border" @click="addLoan(expertData.LOAN.loan02)">+ ÎåÄÏ∂ú Ï∂îÍ∞Ä</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 5. General Expenses -->
                            <div class="accordion-item border-0 mb-3 shadow-sm rounded-3 overflow-hidden">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExpense">
                                        <span class="section-badge">5Îã®Í≥Ñ</span> Í≤ΩÎπÑ Í≥ÑÌöç (ÌåêÍ¥ÄÎπÑ/Ï†úÏ°∞Í≤ΩÎπÑ)
                                    </button>
                                </h2>
                                <div id="collapseExpense" class="accordion-collapse collapse" data-bs-parent="#expertAccordion">
                                    <div class="accordion-body bg-light">
                                        <h6 class="small text-muted fw-bold mb-2">ÌåêÎß§Í¥ÄÎ¶¨ÎπÑ ÏÑ§Ï†ï</h6>
                                        <div v-for="(sc, idx) in expertData.SCOST.SCost" :key="'sc'+idx" class="card mb-2 border-0 bg-white p-2">
                                            <div class="d-flex justify-content-between mb-1">
                                                 <input type="text" class="form-control form-control-sm border-0 fw-bold p-0" v-model="sc.SCostTitle" style="width: 50%">
                                                 <button class="btn-close small" @click="expertData.SCOST.SCost.splice(idx,1)"></button>
                                            </div>
                                            <div class="row g-2 align-items-center">
                                                <div class="col-5">
                                                    <select class="form-select form-select-sm" v-model="sc.SCostCd">
                                                        <option value="ÏõîÏ†ïÏï°">ÏõîÏ†ïÏï°(Ïõê)</option>
                                                        <option value="Îß§Ï∂úÏï°">Îß§Ï∂úÎåÄÎπÑ(%)</option>
                                                        <option value="Ïù∏Í±¥ÎπÑ">Ïù∏Í±¥ÎπÑÎåÄÎπÑ(%)</option>
                                                    </select>
                                                </div>
                                                <div class="col-7">
                                                    <input type="number" class="form-control form-control-sm" v-model.number="sc.SCostTVa" placeholder="Í∞í ÏûÖÎ†•">
                                                </div>
                                            </div>
                                        </div>
                                        <button class="btn btn-sm btn-light w-100 border" @click="addExpense(expertData.SCOST.SCost)">+ Í≤ΩÎπÑ Ìï≠Î™© Ï∂îÍ∞Ä</button>
                                    </div>
                                </div>
                            </div>
                        </div> <!-- End Accordion -->
                    </div>

                    <!-- Right: Dashboard -->
                    <div class="col-lg-6">
                        <div class="sticky-top" style="top: 20px; z-index: 900;">
                             <div class="card-expert bg-white shadow-lg border-0" style="border: 2px solid var(--primary-color);">
                                <div class="expert-header bg-white">
                                    <h5 class="text-primary fw-bold">üìà ÏàòÏùµÏÑ± Î∂ÑÏÑù Î¶¨Ìè¨Ìä∏</h5>
                                    <button class="btn btn-premium btn-sm py-1 px-3" @click="saveExpertReport" :disabled="isSaving">
                                        {{ isSaving ? 'Ï†ÄÏû• Ï§ë...' : 'Î¶¨Ìè¨Ìä∏ Ï†ÄÏû•' }}
                                    </button>
                                </div>
                                <div class="expert-body">
                                    <!-- Key Metrics -->
                                    <div class="row text-center mb-4">
                                        <div class="col-6 mb-3">
                                            <small class="text-muted d-block text-uppercase" style="font-size: 0.7rem;">Ïõî ÏòàÏÉÅ Îß§Ï∂ú</small>
                                            <span class="fs-4 fw-bold text-dark">{{ formatCurrency(expertResult.totalRevenue) }}</span>
                                            <div class="small text-muted clickable-link" @click="showProjectionModal = true" style="font-size: 0.65rem; cursor: pointer; text-decoration: underline;">
                                                Ïó∞Í∞Ñ: {{ formatCurrency(expertResult.yearlySales) }} (ÏÉÅÏÑ∏Î≥¥Í∏∞)
                                            </div>
                                        </div>
                                        <div class="col-6 mb-3">
                                            <small class="text-muted d-block text-uppercase" style="font-size: 0.7rem;">ÏòÅÏóÖÏù¥Ïùµ</small>
                                            <span class="fs-4 fw-bold" :class="expertResult.opIncome >= 0 ? 'text-primary' : 'text-danger'">{{ formatCurrency(expertResult.opIncome) }}</span>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted d-block text-uppercase" style="font-size: 0.7rem;">ÏòÅÏóÖ Ïù¥ÏùµÎ•†</small>
                                            <span class="fs-5 fw-bold text-dark">{{ expertResult.opMargin }}%</span>
                                        </div>
                                        <div class="col-6">
                                             <small class="text-muted d-block text-uppercase" style="font-size: 0.7rem;">Î™©Ìëú Îã¨ÏÑ±</small>
                                              <span class="badge rounded-pill" :class="expertResult.targetGap >= 0 ? 'bg-success' : 'bg-warning text-dark'">
                                                {{ expertResult.targetGap >= 0 ? 'Îã¨ÏÑ±' : 'ÎØ∏Îã¨' }}
                                              </span>
                                        </div>
                                    </div>
                                    
                                    <hr class="my-4" style="opacity: 0.1">

                                    <!-- Cost Breakdown Table -->
                                    <table class="table table-sm table-borderless small mb-4">
                                        <tbody>
                                            <tr>
                                                <td class="text-muted" @click="showMaterialModal = true" style="cursor: pointer;">
                                                    (-) Ïû¨Î£åÎπÑ (COGS) <span class="small text-primary" style="text-decoration: underline;">(ÏÉÅÏÑ∏)</span>
                                                </td>
                                                <td class="text-end fw-bold">{{ formatCurrency(expertResult.totalMaterialCost) }}</td>
                                                <td class="text-end text-muted" style="width: 40px">{{ expertResult.materialRatio }}%</td>
                                            </tr>
                                             <tr>
                                                <td class="text-muted clickable-link" @click="showLaborModal = true" style="cursor: pointer;">
                                                    (-) Ïù∏Í±¥ÎπÑ <span class="small text-primary" style="text-decoration: underline;">(ÏÉÅÏÑ∏)</span>
                                                </td>
                                                <td class="text-end fw-bold">{{ formatCurrency(expertResult.totalLaborCost) }}</td>
                                                <td class="text-end text-muted">{{ expertResult.laborRatio }}%</td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">(-) ÌåêÍ¥ÄÎπÑ/Í≤ΩÎπÑ</td>
                                                <td class="text-end fw-bold">{{ formatCurrency(expertResult.totalExpense) }}</td>
                                                <td class="text-end text-muted">{{ expertResult.expenseRatio }}%</td>
                                            </tr>
                                             <tr>
                                                <td class="text-muted ps-3 fst-italic">„Ñ¥ Ïù¥Ïûê/Í∞êÍ∞ÄÏÉÅÍ∞Å Ìè¨Ìï®</td>
                                                <td></td>
                                                <td></td>
                                            </tr>
                                        </tbody>
                                        <tfoot class="border-top">
                                            <tr>
                                                <td class="pt-2 fw-bold">(=) ÏòÅÏóÖÏù¥Ïùµ</td>
                                                <td class="pt-2 text-end fw-bold fs-6" :class="expertResult.opIncome >= 0 ? 'text-primary' : 'text-danger'">
                                                    {{ formatCurrency(expertResult.opIncome) }}
                                                </td>
                                                <td></td>
                                            </tr>
                                        </tfoot>
                                    </table>

                                    <!-- BEP Analysis -->
                                    <div class="card bg-warning-subtle border-0 p-3 mb-3">
                                        <h6 class="fw-bold mb-2 text-warning-emphasis">‚öñÔ∏è ÏÜêÏùµÎ∂ÑÍ∏∞Ï†ê (BEP) Î∂ÑÏÑù</h6>
                                        <div class="d-flex justify-content-between mb-1 small">
                                            <span>BEP Îß§Ï∂úÏï°</span>
                                            <span class="fw-bold">{{ formatCurrency(expertResult.bepRevenue) }}</span>
                                        </div>
                                        <div class="d-flex justify-content-between small">
                                            <span>Í≥†Ï†ïÎπÑ Ìï©Í≥Ñ</span>
                                            <span>{{ formatCurrency(expertResult.totalFixedCost) }}</span>
                                        </div>
                                        <div class="progress mt-2" style="height: 6px;">
                                            <div class="progress-bar bg-warning" role="progressbar" :style="{ width: Math.min(100, (expertResult.totalRevenue / expertResult.bepRevenue) * 100) + '%' }"></div>
                                        </div>
                                        <div class="text-center mt-1" style="font-size: 0.7rem;">
                                            ÌòÑÏû¨ BEPÏùò <strong>{{ Math.round((expertResult.totalRevenue / expertResult.bepRevenue) * 100) || 0 }}%</strong> Îã¨ÏÑ±
                                        </div>
                                    </div>
                                    
                                    <!-- Diagnosis Report (New) -->
                                    <div class="card border-0 bg-light p-3 mb-3">
                                        <h6 class="fw-bold mb-3 small text-primary">üìä Í≤ΩÏòÅ ÏßÑÎã® Î¶¨Ìè¨Ìä∏</h6>
                                        <div v-for="(diag, dIdx) in expertResult.diagnosis" :key="dIdx" class="d-flex justify-content-between align-items-center mb-2 border-bottom pb-2">
                                            <div>
                                                <span class="d-block small fw-bold">{{ diag.label }}</span>
                                                <small class="text-muted" style="font-size: 0.7rem">{{ diag.msg }}</small>
                                            </div>
                                            <div class="text-end">
                                                <span class="d-block fw-bold" :class="diag.pass ? 'text-success' : 'text-danger'">{{ diag.value }}</span>
                                                <span class="badge" :class="diag.pass ? 'bg-success-subtle text-success' : 'bg-danger-subtle text-danger'" style="font-size: 0.6rem">{{ diag.pass ? 'Ï†ÅÏ†ï' : 'Ï£ºÏùò' }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Action Guide -->
                                    <div class="alert alert-light border small text-muted mb-0">
                                        <strong class="d-block mb-1 text-dark">üí° AI Î∂ÑÏÑù ÏΩîÎ©òÌä∏</strong>
                                        <span v-if="expertResult.targetGap < 0">
                                            Î™©Ìëú Ïù¥ÏùµÍπåÏßÄ <strong>{{ formatCurrency(Math.abs(expertResult.targetGap)) }}</strong> ÎÇ®ÏïòÏäµÎãàÎã§. 
                                            Í≥†Ï†ïÎπÑ ÎπÑÏ§ëÏù¥ {{ expertResult.totalRevenue ? ((expertResult.totalFixedCost / expertResult.totalRevenue)*100).toFixed(1) : 0 }}% ÏûÖÎãàÎã§.
                                        </span>
                                        <span v-else>
                                            Î™©ÌëúÎ•º Îã¨ÏÑ±ÌñàÏäµÎãàÎã§! (Ï¥àÍ≥ºÎã¨ÏÑ±: {{ formatCurrency(expertResult.targetGap) }})
                                        </span>
                                    </div>

                                </div>
                             </div>
                        </div>
                    </div>
                </div>
            </div> <!-- End Expert -->

        <!-- Reports List (Common) -->
        <hr class="my-5" style="opacity: 0.1">
        <div class="card-expert">
            <div class="expert-header">
                <h5>üóÇÔ∏è Ï†ÄÏû•Îêú Î¶¨Ìè¨Ìä∏ Ïù¥Î†•</h5>
            </div>
            <div class="card-body p-0 table-responsive">
                <table class="table table-hover table-premium mb-0">
                    <thead>
                        <tr>
                            <th class="ps-4">No.</th>
                            <th>Íµ¨Î∂Ñ</th>
                            <th>Îß§Ï∂úÏï°</th>
                            <th>ÏòÅÏóÖÏù¥Ïùµ</th>
                            <th>BEP</th>
                            <th>ÏûëÏÑ±ÏùºÏãú</th>
                            <th>Ïï°ÏÖò</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="rpt in reports" :key="rpt.id">
                            <td class="ps-4 text-muted small">#{{ rpt.id }}</td>
                            <td><span class="badge" :class="getReportValues(rpt).mode === 'expert' ? 'bg-secondary' : 'bg-success'">{{ getReportValues(rpt).mode === 'expert' ? 'Ï†ÑÎ¨∏Í∞Ä' : 'Í∞ÑÌé∏' }}</span></td>
                            <td>{{ formatCurrency(getReportValues(rpt).revenue) }}</td>
                            <td :class="getReportValues(rpt).netProfit >= 0 ? 'text-primary fw-bold' : 'text-danger fw-bold'">{{ formatCurrency(getReportValues(rpt).netProfit) }}</td>
                            <td class="text-muted small">{{ getReportValues(rpt).bep ? formatCurrency(getReportValues(rpt).bep) : '-' }}</td>
                            <td class="text-muted small">{{ formatDate(rpt.createdAt) }}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-secondary me-1" @click="loadReportToCanvas(rpt)">Î∂àÎü¨Ïò§Í∏∞</button>
                                <button class="btn btn-sm btn-outline-danger" @click="deleteReport(rpt.id)">ÏÇ≠Ï†ú</button>
                            </td>
                        </tr>
                        <tr v-if="reports.length === 0">
                            <td colspan="7" class="text-center py-5 text-muted">Ï†ÄÏû•Îêú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- Projection Detail Modal (Advanced Layout) -->
    <div v-if="showProjectionModal" class="modal-backdrop fade show"></div>
    <div v-if="showProjectionModal" class="modal fade show d-block" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable"> <!-- Changed to XL -->
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">üìä ÏòàÏÉÅ Îß§Ï∂ú ÏÉÅÏÑ∏ (Revenue Projection)</h5>
                    <button type="button" class="btn-close" @click="showProjectionModal = false"></button>
                </div>
                <div class="modal-body bg-light">
                    
                    <!-- Top Summary Card (Inside Modal) -->
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-body bg-white py-3">
                            <h5 class="fw-bold mb-3 border-bottom pb-2">ÏòàÏÉÅ Îß§Ï∂úÏï° ÏöîÏïΩ</h5>
                            <div class="row text-center">
                                <div class="col-4 border-end">
                                    <small class="text-muted d-block">Ïùº ÏòàÏÉÅ Îß§Ï∂úÏï°</small>
                                    <strong class="fs-5">{{ formatCurrency(expertResult.totalRevenue / expertData.BASIC.workDay) }}</strong>
                                </div>
                                <div class="col-4 border-end">
                                    <small class="text-muted d-block">Ïõî ÏòàÏÉÅ Îß§Ï∂úÏï°</small>
                                    <strong class="fs-5">{{ formatCurrency(expertResult.totalRevenue) }}</strong>
                                </div>
                                <div class="col-4">
                                    <small class="text-muted d-block">1Ï∞®ÎÖÑÎèÑ Ïó∞ ÏòàÏÉÅ Îß§Ï∂úÏï°</small>
                                    <strong class="fs-5 text-primary">{{ formatCurrency(expertResult.totalRevenue * 12) }}</strong> 
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabs for Monthly vs Yearly -->
                    <ul class="nav nav-tabs mb-3" id="projTabs">
                        <li class="nav-item">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabMonthly" type="button">1Ï∞®ÎÖÑÎèÑ ÏõîÎ≥Ñ ÏÉÅÏÑ∏ (Monthly)</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabYearly" type="button">3Í∞úÎÖÑ ÏòàÏÉÅ Îß§Ï∂ú (Yearly)</button>
                        </li>
                    </ul>

                    <div class="tab-content" id="projTabContent">
                        
                        <!-- TAB 1: Monthly Table -->
                        <div class="tab-pane fade show active" id="tabMonthly">
                             <div class="card border-0 shadow-sm">
                                <div class="card-body p-0 table-responsive">
                                    <table class="table table-bordered mb-0 text-center align-middle small table-striped">
                                        <thead class="bg-light sticky-top">
                                            <tr>
                                                <th rowspan="1" style="min-width: 40px;">No</th>
                                                <th rowspan="1" style="min-width: 120px;">Î©îÎâ¥Î™Ö</th>
                                                <th rowspan="1" style="min-width: 80px;">Íµ¨Î∂Ñ</th>
                                                <th v-for="n in 12" :key="n" style="min-width: 70px;">{{n}}Ïõî</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <template v-for="(m, idx) in expertData.SALE.menuM" :key="'mm'+idx">
                                                <!-- Qty -->
                                                <tr>
                                                    <td rowspan="2" class="bg-white">{{ idx + 1 }}</td>
                                                    <td rowspan="2" class="text-start bg-white fw-bold">
                                                        {{ expertData.SALE.menu[idx]?.MenuTitle }}
                                                        <div class="small fw-normal text-muted">{{ formatCurrency(expertData.SALE.menu[idx]?.MenuPrice) }}</div>
                                                    </td>
                                                    <td class="bg-light">ÌåêÎß§ÏàòÎüâ</td>
                                                    <td v-for="q in m.MMenuQty" class="text-end pe-2">{{ formatNumber(q) }}</td>
                                                </tr>
                                                <!-- Amt -->
                                                <tr>
                                                    <td class="bg-light text-primary">ÌåêÎß§Í∏àÏï°</td>
                                                    <td v-for="a in m.MMenuAmt" class="text-end pe-2">{{ formatNumber(a/1000) }}</td>
                                                </tr>
                                            </template>
                                             <!-- Footer -->
                                            <tr class="table-secondary fw-bold border-top-2">
                                                <td colspan="2" rowspan="2">Ìï©Í≥Ñ</td>
                                                <td>ÌåêÎß§ÏàòÎüâ</td>
                                                <td v-for="n in 12" class="text-end pe-2">{{ formatNumber(sumArrayIdx(expertData.SALE.menuM, 'MMenuQty', n-1)) }}</td>
                                            </tr>
                                            <tr class="table-secondary fw-bold">
                                                 <td>ÌåêÎß§Í∏àÏï°</td>
                                                 <td v-for="n in 12" class="text-end pe-2">{{ formatNumber(sumArrayIdx(expertData.SALE.menuM, 'MMenuAmt', n-1)/1000) }}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- TAB 2: Yearly Table -->
                        <div class="tab-pane fade" id="tabYearly">
                            <div class="card border-0 shadow-sm">
                                <div class="card-body p-0 table-responsive">
                                    <table class="table table-bordered mb-0 text-center align-middle small table-hover">
                                        <thead class="bg-light">
                                            <tr>
                                                <th width="3%">No</th>
                                                <th width="15%">Î©îÎâ¥Î™Ö/Î©îÎâ¥Í∞ÄÍ≤©</th>
                                                <th width="8%">ÎÇ¥Ïö©</th>
                                                <th>1Ï∞®ÎÖÑÎèÑ</th>
                                                <th>2Ï∞®ÎÖÑÎèÑ</th>
                                                <th>3Ï∞®ÎÖÑÎèÑ</th>
                                                <th width="5%">ÏàòÏ†ï</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <template v-for="(m, idx) in expertData.SALE.menuY" :key="'y'+idx">
                                                <!-- Row 1: Qty -->
                                                <tr>
                                                    <td rowspan="3" class="bg-white">{{ idx + 1 }}</td>
                                                    <td class="text-start fw-bold bg-white bottom-border-0">
                                                        {{ expertData.SALE.menu[idx]?.MenuTitle }}
                                                    </td>
                                                    <td class="bg-light">ÌåêÎß§ÏàòÎüâ</td>
                                                    <td class="text-end pe-2">{{ formatNumber(m.YMenuQty[0]) }}</td>
                                                    <td class="text-end pe-2">{{ formatNumber(m.YMenuQty[1]) }}</td>
                                                    <td class="text-end pe-2">{{ formatNumber(m.YMenuQty[2]) }}</td>
                                                    <td rowspan="3">
                                                        <!-- Updated to open new Yearly Modal -->
                                                        <button class="btn btn-xs btn-outline-secondary" @click="openYearlyModal(idx)">ÏàòÏ†ï</button>
                                                    </td>
                                                </tr>
                                                <!-- Row 2: Price -->
                                                <tr>
                                                    <td class="text-start text-muted bg-white border-top-0 border-bottom-0 pb-0 pt-0">
                                                        {{ formatCurrency(expertData.SALE.menu[idx]?.MenuPrice) }}
                                                    </td>
                                                    <td class="bg-light">ÌåêÎß§Îã®Í∞Ä</td>
                                                    <td class="text-end pe-2">{{ formatNumber(m.YMenuPrice[0]) }}</td>
                                                    <td class="text-end pe-2">{{ formatNumber(m.YMenuPrice[1]) }}</td>
                                                    <td class="text-end pe-2">{{ formatNumber(m.YMenuPrice[2]) }}</td>
                                                </tr>
                                                <!-- Row 3: Amount -->
                                                <tr>
                                                    <td class="bg-white border-top-0"></td>
                                                    <td class="bg-light">ÌåêÎß§Í∏àÏï°</td>
                                                    <td class="fw-bold bg-info-subtle text-end pe-2">{{ formatNumber(m.YMenuAmt[0]/1000) }}</td>
                                                    <td class="fw-bold bg-info-subtle text-end pe-2">{{ formatNumber(m.YMenuAmt[1]/1000) }}</td>
                                                    <td class="fw-bold bg-info-subtle text-end pe-2">{{ formatNumber(m.YMenuAmt[2]/1000) }}</td>
                                                </tr>
                                            </template>
                                            
                                            <!-- Total Footer -->
                                            <tr class="table-secondary fw-bold">
                                                <td colspan="2" rowspan="2">Ìï©Í≥Ñ</td>
                                                <td>ÌåêÎß§ÏàòÎüâ</td>
                                                <!-- Sum Y1 Qty -->
                                                <td class="text-end pe-2">{{ formatNumber(sumArrayIdx(expertData.SALE.menuY, 'YMenuQty', 0)) }}</td>
                                                <td class="text-end pe-2">{{ formatNumber(sumArrayIdx(expertData.SALE.menuY, 'YMenuQty', 1)) }}</td>
                                                <td class="text-end pe-2">{{ formatNumber(sumArrayIdx(expertData.SALE.menuY, 'YMenuQty', 2)) }}</td>
                                                <td rowspan="2"></td>
                                            </tr>
                                            <tr class="table-secondary fw-bold">
                                                <td>ÌåêÎß§Í∏àÏï°</td>
                                                <td class="text-end pe-2">{{ formatNumber(sumArrayIdx(expertData.SALE.menuY, 'YMenuAmt', 0)/1000) }}</td>
                                                <td class="text-end pe-2">{{ formatNumber(sumArrayIdx(expertData.SALE.menuY, 'YMenuAmt', 1)/1000) }}</td>
                                                <td class="text-end pe-2">{{ formatNumber(sumArrayIdx(expertData.SALE.menuY, 'YMenuAmt', 2)/1000) }}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                    </div> <!-- End Tab Content -->
                </div>
                <div class="modal-footer bg-light">
                    <div class="small text-muted me-auto">* Îã®ÏúÑ(Ï≤úÏõê) ÌëúÍ∏∞ Ï∞∏Í≥†</div>
                    <button type="button" class="btn btn-secondary" @click="showProjectionModal = false">Îã´Í∏∞</button>
                </div>
            </div>
        </div>
    </div> <!-- End showProjectionModal -->

    <!-- Material Cost Detail Modal -->
    <div v-if="showMaterialModal" class="modal-backdrop fade show"></div>
    <div v-if="showMaterialModal" class="modal fade show d-block" tabindex="-1" style="z-index: 1055;">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">üìâ Ïû¨Î£åÎπÑ ÏÉÅÏÑ∏ (Material Cost Projection)</h5>
                    <button type="button" class="btn-close" @click="showMaterialModal = false"></button>
                </div>
                <div class="modal-body bg-light">
                    
                    <!-- Top Summary Card -->
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-body bg-white py-3">
                            <h5 class="fw-bold mb-3 border-bottom pb-2">Ïû¨Î£åÎπÑ ÏöîÏïΩ</h5>
                            <div class="row text-center">
                                <div class="col-4 border-end">
                                    <small class="text-muted d-block">Ïõî ÏòàÏÉÅ Ïû¨Î£åÎπÑ</small>
                                    <strong class="fs-5">{{ formatCurrency(expertResult.totalMaterialCost) }}</strong>
                                </div>
                                <div class="col-4 border-end">
                                    <small class="text-muted d-block">Ïû¨Î£åÎπÑÏú®</small>
                                    <strong class="fs-5">{{ expertResult.materialRatio }}%</strong>
                                </div>
                                <div class="col-4">
                                    <small class="text-muted d-block">1Ï∞®ÎÖÑÎèÑ Ïó∞ ÏòàÏÉÅ Ïû¨Î£åÎπÑ</small>
                                    <strong class="fs-5 text-danger">{{ formatCurrency(expertResult.totalMaterialCost * 12) }}</strong> 
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <ul class="nav nav-tabs mb-3" id="matTabs">
                        <li class="nav-item">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabMatMonthly" type="button">1Ï∞®ÎÖÑÎèÑ ÏõîÎ≥Ñ ÏÉÅÏÑ∏ (Monthly)</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabMatYearly" type="button">3Í∞úÎÖÑ ÏòàÏÉÅ Ïû¨Î£åÎπÑ (Yearly)</button>
                        </li>
                    </ul>

                    <div class="tab-content" id="matTabContent">
                        
                        <!-- TAB 1: Monthly -->
                        <div class="tab-pane fade show active" id="tabMatMonthly">
                             <div class="card border-0 shadow-sm">
                                <div class="card-body p-0 table-responsive">
                                    <table class="table table-bordered mb-0 text-center align-middle small table-striped">
                                        <thead class="bg-light sticky-top">
                                            <tr>
                                                <th rowspan="1" style="min-width: 40px;">No</th>
                                                <th rowspan="1" style="min-width: 120px;">Î©îÎâ¥Î™Ö</th>
                                                <th rowspan="1" style="min-width: 60px;">ÎπÑÏú®</th>
                                                <th v-for="n in 12" :key="n" style="min-width: 70px;">{{n}}Ïõî</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <template v-for="(m, idx) in expertData.COST.costM" :key="'cm'+idx">
                                                <tr>
                                                    <td class="bg-white">{{ idx + 1 }}</td>
                                                    <td class="text-start bg-white fw-bold">
                                                        {{ expertData.SALE.menu[idx]?.MenuTitle }}
                                                    </td>
                                                    <td class="text-muted small">{{ expertData.COST.cost[idx]?.costRate }}%</td>
                                                    <td v-for="c in m.MMenuCost" class="text-end pe-2">{{ formatNumber(Math.round(c/1000)) }}</td>
                                                </tr>
                                            </template>
                                             <!-- Footer -->
                                            <tr class="table-secondary fw-bold border-top-2">
                                                <td colspan="3">Ìï©Í≥Ñ</td>
                                                <td v-for="n in 12" class="text-end pe-2">{{ formatNumber(Math.round(sumArrayIdx(expertData.COST.costM, 'MMenuCost', n-1)/1000)) }}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- TAB 2: Yearly -->
                        <div class="tab-pane fade" id="tabMatYearly">
                            <div class="card border-0 shadow-sm">
                                <div class="card-body p-0 table-responsive">
                                    <table class="table table-bordered mb-0 text-center align-middle small table-hover">
                                        <thead class="bg-light">
                                            <tr>
                                                <th width="5%">No</th>
                                                <th width="15%">Î©îÎâ¥Î™Ö</th>
                                                <th width="10%">ÎÇ¥Ïö©</th>
                                                <th>1Ï∞®ÎÖÑÎèÑ</th>
                                                <th>2Ï∞®ÎÖÑÎèÑ</th>
                                                <th>3Ï∞®ÎÖÑÎèÑ</th>
                                                <th width="5%">ÏàòÏ†ï</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <template v-for="(m, idx) in expertData.SALE.menuY" :key="'my'+idx">
                                                <tr>
                                                    <td rowspan="2" class="bg-white">{{ idx + 1 }}</td>
                                                    <td rowspan="2" class="text-start fw-bold bg-white">
                                                        {{ expertData.SALE.menu[idx]?.MenuTitle }}
                                                    </td>
                                                    <td class="bg-light">Ïû¨Î£åÎπÑÏú®</td>
                                                    <td class="text-center text-muted">
                                                        {{ expertData.COST.costY[idx]?.YCostRate?.[0] ?? expertData.COST.cost[idx]?.costRate ?? 0 }}%
                                                    </td>
                                                    <td class="text-center text-muted">
                                                        {{ expertData.COST.costY[idx]?.YCostRate?.[1] ?? expertData.COST.cost[idx]?.costRate ?? 0 }}%
                                                    </td>
                                                    <td class="text-center text-muted">
                                                        {{ expertData.COST.costY[idx]?.YCostRate?.[2] ?? expertData.COST.cost[idx]?.costRate ?? 0 }}%
                                                    </td>
                                                    
                                                    <td rowspan="2">
                                                        <button class="btn btn-xs btn-outline-secondary" @click="openMaterialYearlyModal(idx)">ÏàòÏ†ï</button>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="bg-light">Ïû¨Î£åÎπÑ</td>
                                                    <!-- Use YMenuCost or YCostAmt. Prefer YMenuCost for display as it was populated initially -->
                                                    <td class="fw-bold text-end pe-2">{{ formatNumber(Math.round((expertData.COST.costY[idx]?.YMenuCost?.[0]||0)/1000)) }}</td>
                                                    <td class="fw-bold text-end pe-2">{{ formatNumber(Math.round((expertData.COST.costY[idx]?.YMenuCost?.[1]||0)/1000)) }}</td>
                                                    <td class="fw-bold text-end pe-2">{{ formatNumber(Math.round((expertData.COST.costY[idx]?.YMenuCost?.[2]||0)/1000)) }}</td>
                                                </tr>
                                            </template>
                                            
                                            <!-- Total Footer -->
                                            <tr class="table-secondary fw-bold">
                                                <td colspan="3">Ìï©Í≥Ñ (Ïû¨Î£åÎπÑ)</td>
                                                <td class="text-end pe-2">{{ formatNumber(Math.round(sumArrayIdx(expertData.COST.costY, 'YMenuCost', 0)/1000)) }}</td>
                                                <td class="text-end pe-2">{{ formatNumber(Math.round(sumArrayIdx(expertData.COST.costY, 'YMenuCost', 1)/1000)) }}</td>
                                                <td class="text-end pe-2">{{ formatNumber(Math.round(sumArrayIdx(expertData.COST.costY, 'YMenuCost', 2)/1000)) }}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                    </div> <!-- End Tab Content -->
                </div>
                <div class="modal-footer bg-light">
                    <div class="small text-muted me-auto">* Îã®ÏúÑ(Ï≤úÏõê) ÌëúÍ∏∞ Ï∞∏Í≥†</div>
                    <button type="button" class="btn btn-secondary" @click="showMaterialModal = false">Îã´Í∏∞</button>
                </div>
            </div>
        </div>
    </div> <!-- End showMaterialModal -->

    <!-- Labor Cost Detail Modal -->
    <div v-if="showLaborModal" class="modal-backdrop fade show"></div>
    <div v-if="showLaborModal" class="modal fade show d-block" tabindex="-1" style="z-index: 1055;">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">üë• ÏòàÏÉÅ Ïù∏Í±¥ÎπÑ ÏÉÅÏÑ∏ (Labor Cost Projection)</h5>
                    <button type="button" class="btn-close" @click="showLaborModal = false"></button>
                </div>
                <div class="modal-body bg-light">
                    
                    <!-- Top Summary Card -->
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-body bg-white py-3">
                            <h5 class="fw-bold mb-3 border-bottom pb-2">Ïù∏Í±¥ÎπÑ ÏöîÏïΩ</h5>
                            <div class="row text-center">
                                <div class="col-6 border-end">
                                    <small class="text-muted d-block">Ïõî ÏòàÏÉÅ Ïù∏Í±¥ÎπÑ</small>
                                    <strong class="fs-5">{{ formatCurrency(expertResult.totalLaborCost) }}</strong>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted d-block">1Ï∞®ÎÖÑÎèÑ Ïó∞ ÏòàÏÉÅ Ïù∏Í±¥ÎπÑ</small>
                                    <strong class="fs-5 text-danger">{{ formatCurrency(expertResult.totalLaborCost * 12) }}</strong> 
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <ul class="nav nav-tabs mb-3" id="laborTabs">
                        <li class="nav-item">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabLaborMonthly" type="button">1Ï∞®ÎÖÑÎèÑ ÏõîÎ≥Ñ ÏÉÅÏÑ∏ (Monthly)</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabLaborYearly" type="button">3Í∞úÎÖÑ ÏòàÏÉÅ Ïù∏Í±¥ÎπÑ (Yearly)</button>
                        </li>
                    </ul>

                    <div class="tab-content">
                        
                        <!-- TAB 1: Monthly -->
                        <div class="tab-pane fade show active" id="tabLaborMonthly">
                             <div class="card border-0 shadow-sm">
                                <div class="card-body p-0 table-responsive">
                                    <table class="table table-bordered mb-0 text-center align-middle small table-striped">
                                        <thead class="bg-light sticky-top">
                                            <tr>
                                                <th>Íµ¨Î∂Ñ</th>
                                                <th>ÏßÅÏúÑ(Î∂ÄÎ∂Ñ)</th>
                                                <th>Ïù∏Ïõê</th>
                                                <th v-for="n in 12" :key="n" style="min-width: 70px;">{{n}}Ïõî</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Mfg -->
                                            <template v-for="(j, idx) in expertData.JOB.job01" :key="'mfgM'+idx">
                                                <tr>
                                                    <td class="bg-white">Ï†úÏ°∞</td>
                                                    <td class="text-start bg-white fw-bold">{{ j.JobTitle }}</td>
                                                    <td>{{ j.JobCnt }}</td>
                                                    <td v-for="amt in expertData.JOB.job01M[idx]?.MJobAmt" class="text-end pe-2">{{ formatNumber(Math.round(amt/1000)) }}</td>
                                                </tr>
                                            </template>
                                            <tr class="table-light italic small" v-if="expertData.JOB.job01.length > 0">
                                                <td colspan="2">Ï†úÏ°∞ ÏÜåÍ≥Ñ</td>
                                                <td>{{ expertData.JOB.job01.reduce((s,c)=>s+(c.JobCnt||0), 0) }}</td>
                                                <td v-for="n in 12" class="text-end pe-2">{{ formatNumber(Math.round(sumArrayIdx(expertData.JOB.job01M, 'MJobAmt', n-1)/1000)) }}</td>
                                            </tr>

                                            <!-- Sales -->
                                            <template v-for="(j, idx) in expertData.JOB.job02" :key="'salesM'+idx">
                                                <tr>
                                                    <td class="bg-white">ÌåêÎß§</td>
                                                    <td class="text-start bg-white fw-bold">{{ j.JobTitle }}</td>
                                                    <td>{{ j.JobCnt }}</td>
                                                    <td v-for="amt in expertData.JOB.job02M[idx]?.MJobAmt" class="text-end pe-2">{{ formatNumber(Math.round(amt/1000)) }}</td>
                                                </tr>
                                            </template>
                                            <tr class="table-light italic small" v-if="expertData.JOB.job02.length > 0">
                                                <td colspan="2">ÌåêÎß§ ÏÜåÍ≥Ñ</td>
                                                <td>{{ expertData.JOB.job02.reduce((s,c)=>s+(c.JobCnt||0), 0) }}</td>
                                                <td v-for="n in 12" class="text-end pe-2">{{ formatNumber(Math.round(sumArrayIdx(expertData.JOB.job02M, 'MJobAmt', n-1)/1000)) }}</td>
                                            </tr>

                                             <!-- Total Footer -->
                                            <tr class="table-secondary fw-bold">
                                                <td colspan="2">Ìï©Í≥Ñ</td>
                                                <td>{{ expertData.JOB.job01.reduce((s,c)=>s+(c.JobCnt||0), 0) + expertData.JOB.job02.reduce((s,c)=>s+(c.JobCnt||0), 0) }}</td>
                                                <td v-for="n in 12" class="text-end pe-2">{{ formatNumber(Math.round((sumArrayIdx(expertData.JOB.job01M, 'MJobAmt', n-1) + sumArrayIdx(expertData.JOB.job02M, 'MJobAmt', n-1))/1000)) }}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- TAB 2: Yearly -->
                        <div class="tab-pane fade" id="tabLaborYearly">
                            <div class="card border-0 shadow-sm">
                                <div class="card-body p-0 table-responsive">
                                    <table class="table table-bordered mb-0 text-center align-middle small table-hover">
                                        <thead class="bg-light">
                                            <tr>
                                                <th width="10%">Íµ¨Î∂Ñ</th>
                                                <th width="30%">ÏßÅÏúÑ(Î∂ÄÎ∂Ñ)</th>
                                                <th width="10%">Ïù∏Ïõê</th>
                                                <th>1Ï∞®ÎÖÑÎèÑ</th>
                                                <th>2Ï∞®ÎÖÑÎèÑ</th>
                                                <th>3Ï∞®ÎÖÑÎèÑ</th>
                                                <th width="10%">ÏàòÏ†ï</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                             <!-- Mfg -->
                                             <template v-for="(j, idx) in expertData.JOB.job01" :key="'mfgY'+idx">
                                                <tr>
                                                    <td>Ï†úÏ°∞</td>
                                                    <td class="text-start fw-bold bg-white">{{ j.JobTitle }}</td>
                                                    <td>{{ j.JobCnt }}</td>
                                                    <td class="text-end pe-2">{{ formatNumber(Math.round((expertData.JOB.job01Y[idx]?.YJobAmt[0]||0)/1000)) }}</td>
                                                    <td class="text-end pe-2">{{ formatNumber(Math.round((expertData.JOB.job01Y[idx]?.YJobAmt[1]||0)/1000)) }}</td>
                                                    <td class="text-end pe-2">{{ formatNumber(Math.round((expertData.JOB.job01Y[idx]?.YJobAmt[2]||0)/1000)) }}</td>
                                                    <td>
                                                        <button class="btn btn-xs btn-outline-secondary" @click="openLaborYearlyModal(idx, 'mfg')">ÏàòÏ†ï</button>
                                                    </td>
                                                </tr>
                                            </template>
                                            <tr class="table-light italic small" v-if="expertData.JOB.job01.length > 0">
                                                <td colspan="2">Ï†úÏ°∞ ÏÜåÍ≥Ñ</td>
                                                <td>{{ expertData.JOB.job01.reduce((s,c)=>s+(c.JobCnt||0), 0) }}</td>
                                                <td class="text-end pe-2">{{ formatNumber(Math.round(sumArrayIdx(expertData.JOB.job01Y, 'YJobAmt', 0)/1000)) }}</td>
                                                <td class="text-end pe-2">{{ formatNumber(Math.round(sumArrayIdx(expertData.JOB.job01Y, 'YJobAmt', 1)/1000)) }}</td>
                                                <td class="text-end pe-2">{{ formatNumber(Math.round(sumArrayIdx(expertData.JOB.job01Y, 'YJobAmt', 2)/1000)) }}</td>
                                                <td></td>
                                            </tr>

                                            <!-- Sales -->
                                             <template v-for="(j, idx) in expertData.JOB.job02" :key="'salesY'+idx">
                                                <tr>
                                                    <td>ÌåêÎß§</td>
                                                    <td class="text-start fw-bold bg-white">{{ j.JobTitle }}</td>
                                                    <td>{{ j.JobCnt }}</td>
                                                    <td class="text-end pe-2">{{ formatNumber(Math.round((expertData.JOB.job02Y[idx]?.YJobAmt[0]||0)/1000)) }}</td>
                                                    <td class="text-end pe-2">{{ formatNumber(Math.round((expertData.JOB.job02Y[idx]?.YJobAmt[1]||0)/1000)) }}</td>
                                                    <td class="text-end pe-2">{{ formatNumber(Math.round((expertData.JOB.job02Y[idx]?.YJobAmt[2]||0)/1000)) }}</td>
                                                    <td>
                                                        <button class="btn btn-xs btn-outline-secondary" @click="openLaborYearlyModal(idx, 'sales')">ÏàòÏ†ï</button>
                                                    </td>
                                                </tr>
                                            </template>
                                            <tr class="table-light italic small" v-if="expertData.JOB.job02.length > 0">
                                                <td colspan="2">ÌåêÎß§ ÏÜåÍ≥Ñ</td>
                                                <td>{{ expertData.JOB.job02.reduce((s,c)=>s+(c.JobCnt||0), 0) }}</td>
                                                <td class="text-end pe-2">{{ formatNumber(Math.round(sumArrayIdx(expertData.JOB.job02Y, 'YJobAmt', 0)/1000)) }}</td>
                                                <td class="text-end pe-2">{{ formatNumber(Math.round(sumArrayIdx(expertData.JOB.job02Y, 'YJobAmt', 1)/1000)) }}</td>
                                                <td class="text-end pe-2">{{ formatNumber(Math.round(sumArrayIdx(expertData.JOB.job02Y, 'YJobAmt', 2)/1000)) }}</td>
                                                <td></td>
                                            </tr>
                                            
                                            <!-- Total Footer -->
                                            <tr class="table-secondary fw-bold">
                                                <td colspan="2">Ìï©Í≥Ñ</td>
                                                <td>{{ expertData.JOB.job01.reduce((s,c)=>s+(c.JobCnt||0), 0) + expertData.JOB.job02.reduce((s,c)=>s+(c.JobCnt||0), 0) }}</td>
                                                <td class="text-end pe-2">{{ formatNumber(Math.round((sumArrayIdx(expertData.JOB.job01Y, 'YJobAmt', 0) + sumArrayIdx(expertData.JOB.job02Y, 'YJobAmt', 0))/1000)) }}</td>
                                                <td class="text-end pe-2">{{ formatNumber(Math.round((sumArrayIdx(expertData.JOB.job01Y, 'YJobAmt', 1) + sumArrayIdx(expertData.JOB.job02Y, 'YJobAmt', 1))/1000)) }}</td>
                                                <td class="text-end pe-2">{{ formatNumber(Math.round((sumArrayIdx(expertData.JOB.job01Y, 'YJobAmt', 2) + sumArrayIdx(expertData.JOB.job02Y, 'YJobAmt', 2))/1000)) }}</td>
                                                <td></td>
                                            </tr>

                                            <!-- KPI Rows -->
                                            <tr class="fw-bold">
                                                <td colspan="3" class="bg-light">Ïù∏Í±¥ÎπÑ ÎπÑÏú®</td>
                                                <td v-for="k in [0,1,2]" class="text-end pe-2 text-danger">
                                                    {{ ((sumArrayIdx(expertData.JOB.job01Y, 'YJobAmt', k) + sumArrayIdx(expertData.JOB.job02Y, 'YJobAmt', k)) / (sumArrayIdx(expertData.SALE.menuY, 'YMenuAmt', k) || 1) * 100).toFixed(1) }}%
                                                </td>
                                                <td></td>
                                            </tr>
                                            <tr class="fw-bold">
                                                <td colspan="3" class="bg-light">1Ïù∏Îãπ Îß§Ï∂úÏï°(Ï≤úÏõê)</td>
                                                <td v-for="k in [0,1,2]" class="text-end pe-2 text-danger">
                                                    {{ formatNumber(Math.round(sumArrayIdx(expertData.SALE.menuY, 'YMenuAmt', k) / (expertData.JOB.job01.reduce((s,c)=>s+(c.JobCnt||0), 0) + expertData.JOB.job02.reduce((s,c)=>s+(c.JobCnt||0), 0) || 1) / 1000)) }}
                                                </td>
                                                <td></td>
                                            </tr>
                                            <tr class="fw-bold">
                                                <td colspan="3" class="bg-light">1Ïù∏Îãπ Ïù∏Í±¥ÎπÑ(Ï≤úÏõê)</td>
                                                <td v-for="k in [0,1,2]" class="text-end pe-2 text-danger">
                                                    {{ formatNumber(Math.round((sumArrayIdx(expertData.JOB.job01Y, 'YJobAmt', k) + sumArrayIdx(expertData.JOB.job02Y, 'YJobAmt', k)) / (expertData.JOB.job01.reduce((s,c)=>s+(c.JobCnt||0), 0) + expertData.JOB.job02.reduce((s,c)=>s+(c.JobCnt||0), 0) || 1) / 1000)) }}
                                                </td>
                                                <td></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                    </div> <!-- End Tab Content -->
                </div>
                <div class="modal-footer bg-light">
                    <div class="small text-muted me-auto">* Îã®ÏúÑ(Ï≤úÏõê) ÌëúÍ∏∞ Ï∞∏Í≥†</div>
                    <button type="button" class="btn btn-secondary" @click="showLaborModal = false">Îã´Í∏∞</button>
                </div>
            </div>
        </div>
    </div> <!-- End showLaborModal -->

    <!-- Yearly Labor Registration Modal -->
    <div v-if="showLaborYearlyModal" class="modal-backdrop fade show" style="z-index: 1065;"></div>
    <div v-if="showLaborYearlyModal" class="modal fade show d-block" tabindex="-1" style="z-index: 1070;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">Ïó∞ÎèÑÎ≥Ñ Ïù∏Í±¥ÎπÑ Îì±Î°ù</h5>
                    <button type="button" class="btn-close" @click="closeLaborYearlyModal"></button>
                </div>
                <div class="modal-body">
                     <div class="row mb-3">
                         <label class="col-sm-3 col-form-label text-end small fw-bold">ÏßÅÏúÑ/ÏÑ±Î™Ö</label>
                         <div class="col-sm-9 d-flex align-items-center">
                             <span class="fw-bold">{{ currentLaborYearly.JobTitle }}</span>
                         </div>
                     </div>
                     <div class="row mb-4">
                         <label class="col-sm-3 col-form-label text-end small fw-bold">Ïù∏Í±¥ÎπÑ<br>Ï¶ùÍ∞êÏú®</label>
                         <div class="col-sm-9 d-flex align-items-center">
                             <div class="input-group input-group-sm" style="width: 150px;">
                                <input type="number" class="form-control text-end" v-model.number="currentLaborYearly.YJobRate" @input="calcLaborYearly">
                                <span class="input-group-text">%</span>
                             </div>
                             <span class="small text-muted ms-2">(2,3Ï∞®ÎÖÑÎèÑ ÏûêÎèôÍ≥ÑÏÇ∞)</span>
                         </div>
                     </div>
                     <table class="table table-bordered small align-middle text-center">
                         <thead class="table-light">
                             <tr>
                                 <th>ÎÖÑÎèÑ</th>
                                 <th>Ïù∏Í±¥ÎπÑ(Ï≤úÏõê)</th>
                             </tr>
                         </thead>
                         <tbody>
                             <tr v-for="(amt, i) in currentLaborYearly.YJobAmt" :key="i">
                                 <td class="bg-light">{{ i+1 }}Ï∞®ÎÖÑÎèÑ</td>
                                 <td class="text-end pe-2">{{ formatNumber(Math.round(amt/1000)) }}</td>
                             </tr>
                         </tbody>
                     </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger btn-sm text-white" @click="saveLaborYearly" style="background-color: #ff8a80; border-color: #ff8a80;">ÏàòÏ†ï</button>
                    <button type="button" class="btn btn-secondary btn-sm" @click="closeLaborYearlyModal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Yearly Sales Modal (Per Menu) -->
    <div v-if="showYearlyModal" class="modal-backdrop fade show" style="z-index: 1075;"></div>
    <div v-if="showYearlyModal" class="modal fade show d-block" tabindex="-1" style="z-index: 1080;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">Ïó∞ÎèÑÎ≥Ñ Îß§Ï∂úÎì±Î°ù</h5>
                    <button type="button" class="btn-close" @click="closeYearlyModal"></button>
                </div>
                <div class="modal-body">
                     <!-- Menu Name -->
                     <div class="row mb-3">
                         <label class="col-sm-3 col-form-label text-end small fw-bold">Î©îÎâ¥Î™Ö</label>
                         <div class="col-sm-9 d-flex align-items-center">
                             <span class="fw-bold">{{ currentMenu?.MenuTitle }}</span>
                         </div>
                     </div>
                     
                     <!-- Input Method -->
                     <div class="row mb-3">
                         <label class="col-sm-3 col-form-label text-end small fw-bold">ÏûÖÎ†•Î∞©Î≤ïÏÑ†ÌÉù</label>
                         <div class="col-sm-9">
                             <select class="form-select form-select-sm" v-model="currentYearly.YMenuCd" @change="onYMenuCdChange">
                                 <option value="1">Ï¶ùÍ∞êÏú®</option>
                                 <option value="2">ÏßÅÏ†ëÏûÖÎ†•</option>
                             </select>
                         </div>
                     </div>

                     <!-- Rates (Visible if Cd=1) -->
                     <div v-if="currentYearly.YMenuCd === '1'">
                         <div class="row mb-2">
                             <label class="col-sm-3 col-form-label text-end small">ÌåêÎß§ÏàòÎüâ<br>Ï¶ùÍ∞êÏú®</label>
                             <div class="col-sm-9 d-flex align-items-center">
                                 <div class="input-group input-group-sm">
                                    <input type="number" class="form-control text-end" v-model.number="currentYearly.YMenuQtyRate" @input="calcYearly">
                                    <span class="input-group-text">%</span>
                                 </div>
                             </div>
                         </div>
                         <div class="row mb-3">
                             <label class="col-sm-3 col-form-label text-end small">ÌåêÎß§Îã®Í∞Ä<br>Ï¶ùÍ∞êÏú®</label>
                             <div class="col-sm-9 d-flex align-items-center">
                                 <div class="input-group input-group-sm">
                                    <input type="number" class="form-control text-end" v-model.number="currentYearly.YMenuPriceRate" @input="calcYearly">
                                    <span class="input-group-text">%</span>
                                 </div>
                             </div>
                         </div>
                     </div>

                     <!-- Table -->
                     <table class="table table-bordered small align-middle">
                         <thead class="table-light text-center">
                             <tr>
                                 <th>ÎÖÑÎèÑ</th>
                                 <th>ÌåêÎß§ÏàòÎüâ</th>
                                 <th>ÌåêÎß§Îã®Í∞Ä</th>
                                 <th>ÌåêÎß§Í∏àÏï°(Ï≤úÏõê)</th>
                             </tr>
                         </thead>
                         <tbody>
                             <!-- Year 1 (Fixed) -->
                             <tr>
                                 <td class="bg-light text-center">1Ï∞®ÎÖÑÎèÑ</td>
                                 <td class="bg-light text-end pe-2">{{ formatNumber(currentYearly.YMenuQty[0]) }}</td>
                                 <td class="bg-light text-end pe-2">{{ formatNumber(currentYearly.YMenuPrice[0]) }}</td>
                                 <td class="bg-light text-end pe-2">{{ formatNumber(Math.round(currentYearly.YMenuAmt[0]/1000)) }}</td>
                             </tr>
                             <!-- Year 2 -->
                             <tr>
                                 <td class="bg-light text-center">2Ï∞®ÎÖÑÎèÑ</td>
                                 <td class="text-end pe-2">
                                     <input v-if="currentYearly.YMenuCd === '2'" type="number" class="form-control form-control-sm text-end" v-model.number="currentYearly.YMenuQty[1]" @input="calcYearlyDirect">
                                     <span v-else>{{ formatNumber(currentYearly.YMenuQty[1]) }}</span>
                                 </td>
                                 <td class="text-end pe-2">
                                     <input v-if="currentYearly.YMenuCd === '2'" type="number" class="form-control form-control-sm text-end" v-model.number="currentYearly.YMenuPrice[1]" @input="calcYearlyDirect">
                                     <span v-else>{{ formatNumber(currentYearly.YMenuPrice[1]) }}</span>
                                 </td>
                                 <td class="bg-light text-end pe-2">{{ formatNumber(Math.round(currentYearly.YMenuAmt[1]/1000)) }}</td>
                             </tr>
                             <!-- Year 3 -->
                             <tr>
                                 <td class="bg-light text-center">3Ï∞®ÎÖÑÎèÑ</td>
                                  <td class="text-end pe-2">
                                     <input v-if="currentYearly.YMenuCd === '2'" type="number" class="form-control form-control-sm text-end" v-model.number="currentYearly.YMenuQty[2]" @input="calcYearlyDirect">
                                     <span v-else>{{ formatNumber(currentYearly.YMenuQty[2]) }}</span>
                                 </td>
                                 <td class="text-end pe-2">
                                     <input v-if="currentYearly.YMenuCd === '2'" type="number" class="form-control form-control-sm text-end" v-model.number="currentYearly.YMenuPrice[2]" @input="calcYearlyDirect">
                                     <span v-else>{{ formatNumber(currentYearly.YMenuPrice[2]) }}</span>
                                 </td>
                                 <td class="bg-light text-end pe-2">{{ formatNumber(Math.round(currentYearly.YMenuAmt[2]/1000)) }}</td>
                             </tr>
                         </tbody>
                     </table>
                </div>
                 <div class="modal-footer">
                    <button type="button" class="btn btn-danger btn-sm" @click="saveYearlyModal">ÏàòÏ†ï</button>
                    <button type="button" class="btn btn-secondary btn-sm" @click="closeYearlyModal">Close</button>
                </div>
            </div>
        </div>
    </div> <!-- End showYearlyModal -->
    <!-- Yearly Material Cost Registration Modal -->
    <div v-if="showMaterialYearlyModal" class="modal-backdrop fade show" style="z-index: 1065;"></div>
    <div v-if="showMaterialYearlyModal" class="modal fade show d-block" tabindex="-1" style="z-index: 1070;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">Ïó∞ÎèÑÎ≥Ñ Ïû¨Î£åÎπÑ Îì±Î°ù</h5>
                    <button type="button" class="btn-close" @click="closeMaterialYearlyModal"></button>
                </div>
                <div class="modal-body">
                     <!-- Menu Info -->
                     <div class="row mb-3">
                         <label class="col-sm-3 col-form-label text-end small fw-bold">Î©îÎâ¥Î™Ö</label>
                         <div class="col-sm-9 d-flex align-items-center">
                             <span class="fw-bold">{{ currentMenu?.MenuTitle }}</span>
                         </div>
                     </div>
                     
                     <!-- Increase Rate Input -->
                     <div class="row mb-4">
                         <label class="col-sm-3 col-form-label text-end small fw-bold">Ïû¨Î£åÎπÑÎπÑÏú®<br>Ï¶ùÍ∞êÏú®</label>
                         <div class="col-sm-9 d-flex align-items-center">
                             <div class="input-group input-group-sm" style="width: 150px;">
                                <input type="number" class="form-control text-end" v-model.number="currentMaterialYearly.YCostAmtRate" @input="calcMaterialYearly">
                                <span class="input-group-text">%</span>
                             </div>
                             <span class="small text-muted ms-2">(2,3Ï∞®ÎÖÑÎèÑ ÏûêÎèôÍ≥ÑÏÇ∞)</span>
                         </div>
                     </div>

                     <!-- Table -->
                     <table class="table table-bordered small align-middle text-center">
                         <thead class="table-light">
                             <tr>
                                 <th>ÎÖÑÎèÑ</th>
                                 <th>ÌåêÎß§Í∏àÏï°(Ï≤úÏõê)</th>
                                 <th>Ïû¨Î£åÎπÑ ÎπÑÏú®</th>
                                 <th>Ïû¨Î£åÎπÑ(Ï≤úÏõê)</th>
                             </tr>
                         </thead>
                         <tbody>
                             <!-- Year 1 -->
                             <tr>
                                 <td class="bg-light">1Ï∞®ÎÖÑÎèÑ</td>
                                 <td class="bg-light text-end pe-2">{{ formatNumber(Math.round(currentMaterialYearly.DisplayYMenuAmt[0]/1000)) }}</td>
                                 <td class="bg-light">
                                     <div class="input-group input-group-sm justify-content-end border-0 bg-transparent">
                                        <span class="pe-1">{{ currentMaterialYearly.YCostRate[0] }}</span>%
                                     </div>
                                 </td>
                                 <td class="bg-light text-end pe-2">{{ formatNumber(Math.round(currentMaterialYearly.YCostAmt[0]/1000)) }}</td>
                             </tr>
                             <!-- Year 2 -->
                             <tr>
                                 <td class="bg-light">2Ï∞®ÎÖÑÎèÑ</td>
                                 <td class="bg-light text-end pe-2">{{ formatNumber(Math.round(currentMaterialYearly.DisplayYMenuAmt[1]/1000)) }}</td>
                                 <td class="bg-white">
                                     <div class="d-flex justify-content-center align-items-center">
                                        <span class="fw-bold">{{ currentMaterialYearly.YCostRate[1] }}</span>
                                        <span class="small ms-1">%</span>
                                     </div>
                                 </td>
                                 <td class="bg-light text-end pe-2">{{ formatNumber(Math.round(currentMaterialYearly.YCostAmt[1]/1000)) }}</td>
                             </tr>
                             <!-- Year 3 -->
                             <tr>
                                 <td class="bg-light">3Ï∞®ÎÖÑÎèÑ</td>
                                 <td class="bg-light text-end pe-2">{{ formatNumber(Math.round(currentMaterialYearly.DisplayYMenuAmt[2]/1000)) }}</td>
                                  <td class="bg-white">
                                     <div class="d-flex justify-content-center align-items-center">
                                        <span class="fw-bold">{{ currentMaterialYearly.YCostRate[2] }}</span>
                                        <span class="small ms-1">%</span>
                                     </div>
                                 </td>
                                 <td class="bg-light text-end pe-2">{{ formatNumber(Math.round(currentMaterialYearly.YCostAmt[2]/1000)) }}</td>
                             </tr>
                         </tbody>
                     </table>
                </div>
                 <div class="modal-footer">
                     <!-- Button color red-ish as per user image 'ÏàòÏ†ï'-->
                    <button type="button" class="btn btn-danger btn-sm text-white" @click="saveMaterialYearly" style="background-color: #ff8a80; border-color: #ff8a80;">ÏàòÏ†ï</button>
                    <button type="button" class="btn btn-secondary btn-sm" @click="closeMaterialYearlyModal">Close</button>
                </div>
            </div>
        </div>
    </div> <!-- End showMaterialYearlyModal -->
</div> <!-- End #app -->

<script>
  
    const { createApp, ref, reactive, computed, watch, onMounted } = Vue;

    createApp({
        setup() {
            const mode = ref('lite'); // 'lite' or 'expert'
            const userEmail = ref('test@example.com');
            const isSaving = ref(false);
            const reports = ref([]);
            const currentReportId = ref(null);
            const showProjectionModal = ref(false);
            const showMaterialModal = ref(false);
            const showLaborModal = ref(false);

            // Yearly Sales Logic
            const showYearlyModal = ref(false);
            const currentMenuIdx = ref(-1);
            const currentMenu = computed(() => currentMenuIdx.value >= 0 ? expertData.SALE.menu[currentMenuIdx.value] : null);
            const currentYearly = reactive({
                YMenuCd: '1', YMenuQtyRate: 0, YMenuPriceRate: 0,
                YMenuQty: [0,0,0], YMenuPrice: [0,0,0], YMenuAmt: [0,0,0]
            });

            const openYearlyModal = (idx) => {
                currentMenuIdx.value = idx;
                const existing = expertData.SALE.menuY[idx];
                if (existing) {
                    currentYearly.YMenuCd = existing.YMenuCd || '1';
                    currentYearly.YMenuQtyRate = existing.YMenuQtyRate || 0;
                    currentYearly.YMenuPriceRate = existing.YMenuPriceRate || 0;
                    currentYearly.YMenuQty = [...(existing.YMenuQty || [0,0,0])];
                    currentYearly.YMenuPrice = [...(existing.YMenuPrice || [0,0,0])];
                    currentYearly.YMenuAmt = [...(existing.YMenuAmt || [0,0,0])];
                }
                showYearlyModal.value = true;
            };

            const closeYearlyModal = () => { showYearlyModal.value = false; currentMenuIdx.value = -1; };
            
            const saveYearlyModal = () => {
                if (currentMenuIdx.value >= 0 && expertData.SALE.menuY[currentMenuIdx.value]) {
                    const target = expertData.SALE.menuY[currentMenuIdx.value];
                    target.YMenuCd = currentYearly.YMenuCd;
                    target.YMenuQtyRate = currentYearly.YMenuQtyRate;
                    target.YMenuPriceRate = currentYearly.YMenuPriceRate;
                    target.YMenuQty = [...currentYearly.YMenuQty];
                    target.YMenuPrice = [...currentYearly.YMenuPrice];
                    target.YMenuAmt = [...currentYearly.YMenuAmt];
                }
                closeYearlyModal();
            };

            const calcYearly = () => {
                if (currentYearly.YMenuCd !== '1') return;
                const qRate = (currentYearly.YMenuQtyRate || 0)/100;
                const pRate = (currentYearly.YMenuPriceRate || 0)/100;
                
                // Y1 base
                const q1 = currentYearly.YMenuQty[0];
                const p1 = currentYearly.YMenuPrice[0];
                
                // Y2
                currentYearly.YMenuQty[1] = Math.round(q1 * (1 + qRate));
                currentYearly.YMenuPrice[1] = Math.round(p1 * (1 + pRate));
                currentYearly.YMenuAmt[1] = currentYearly.YMenuQty[1] * currentYearly.YMenuPrice[1];
                
                // Y3
                currentYearly.YMenuQty[2] = Math.round(currentYearly.YMenuQty[1] * (1 + qRate));
                currentYearly.YMenuPrice[2] = Math.round(currentYearly.YMenuPrice[1] * (1 + pRate));
                currentYearly.YMenuAmt[2] = currentYearly.YMenuQty[2] * currentYearly.YMenuPrice[2];
            };

            const calcYearlyDirect = () => {
                if (currentYearly.YMenuCd !== '2') return;
                currentYearly.YMenuAmt[1] = (currentYearly.YMenuQty[1] || 0) * (currentYearly.YMenuPrice[1] || 0);
                currentYearly.YMenuAmt[2] = (currentYearly.YMenuQty[2] || 0) * (currentYearly.YMenuPrice[2] || 0);
            };

            const onYMenuCdChange = () => {
                if (currentYearly.YMenuCd === '1') {
                     calcYearly();
                }
            };
            
            // Material Cost Yearly Logic
            const showMaterialYearlyModal = ref(false);
            const currentMaterialYearly = reactive({
                YCostCd: '1', YCostAmtRate: 0,
                YCostRate: [0,0,0], YCostAmt: [0,0,0],
                DisplayYMenuAmt: [0,0,0] // For reference only (Revenue)
            });

            const openMaterialYearlyModal = (idx) => {
                currentMenuIdx.value = idx;
                const costItem = expertData.COST.cost[idx]; // Base info
                const costYItem = expertData.COST.costY[idx]; // Yearly info
                const revYItem = expertData.SALE.menuY[idx]; // Yearly Revenue

                // Init Defaults if missing
                const baseRate = costItem ? (costItem.costRate || 0) : 0;
                
                // Set Current State
                if (costYItem) {
                    currentMaterialYearly.YCostCd = '1'; // Fixed as 1
                    currentMaterialYearly.YCostAmtRate = costYItem.YCostAmtRate || 0;
                    
                    // If Rates exist, use them, else init from Base
                    if(costYItem.YCostRate && costYItem.YCostRate.length === 3) {
                         currentMaterialYearly.YCostRate = [...costYItem.YCostRate];
                    } else {
                         currentMaterialYearly.YCostRate = [baseRate, baseRate, baseRate];
                    }
                } else {
                    currentMaterialYearly.YCostCd = '1'; 
                    currentMaterialYearly.YCostAmtRate = 0;
                    currentMaterialYearly.YCostRate = [baseRate, baseRate, baseRate];
                }

                // Load Revenue for Ref (Read Only)
                if (revYItem && revYItem.YMenuAmt) {
                    currentMaterialYearly.DisplayYMenuAmt = [...revYItem.YMenuAmt];
                } else {
                    currentMaterialYearly.DisplayYMenuAmt = [0,0,0]; // Should not happen if projections up to date
                }

                // Recalc to ensure consistency
                calcMaterialYearly();
                showMaterialYearlyModal.value = true;
            };

            const closeMaterialYearlyModal = () => { showMaterialYearlyModal.value = false; currentMenuIdx.value = -1; };

            const calcMaterialYearly = () => {
                // Logic: 
                // Y1 Rate = Base (Fixed? Or editable? Prompt says "Increase Rate" input. Usually Y1 is fixed by Menu Setup, but let's assume Y1 starts at base and Y2 changes).
                // Let's assume Y1 Rate is fixed from the Basic Menu Input (Input 0% increase implies keeping Y1 rate).
                // If user changes YCostAmtRate, it applies to Y2, Y3 compounding.
                
                const rateIncrease = (currentMaterialYearly.YCostAmtRate || 0) / 100;
                
                // Y1
                // Rate: Keep as is (or reset to base? Let's use current [0] but ensure it matches base logic if wanted. For now trust stored Y1 or base).
                // Actually, if we want to "Input Increase Rate", we usually base it off Y1.
                // Let's ensure Y1 Amt is correct based on Y1 Rate.
                currentMaterialYearly.YCostAmt[0] = Math.round(currentMaterialYearly.DisplayYMenuAmt[0] * (currentMaterialYearly.YCostRate[0] / 100));

                // Y2
                // New Rate = Y1 Rate * (1 + Inc)
                let r2 = currentMaterialYearly.YCostRate[0] * (1 + rateIncrease);
                // Clamp max 100?
                if(r2 > 100) r2 = 100; 
                currentMaterialYearly.YCostRate[1] = parseFloat(r2.toFixed(2)); // clean decimals
                currentMaterialYearly.YCostAmt[1] = Math.round(currentMaterialYearly.DisplayYMenuAmt[1] * (currentMaterialYearly.YCostRate[1] / 100));

                // Y3
                // New Rate = Y2 Rate * (1 + Inc)
                let r3 = currentMaterialYearly.YCostRate[1] * (1 + rateIncrease);
                if(r3 > 100) r3 = 100;
                currentMaterialYearly.YCostRate[2] = parseFloat(r3.toFixed(2));
                currentMaterialYearly.YCostAmt[2] = Math.round(currentMaterialYearly.DisplayYMenuAmt[2] * (currentMaterialYearly.YCostRate[2] / 100));
            };

            const saveMaterialYearly = () => {
                if(currentMenuIdx.value >= 0) {
                    // Update global state
                    // Ensure object exists
                    if (!expertData.COST.costY[currentMenuIdx.value]) {
                        expertData.COST.costY[currentMenuIdx.value] = {};
                    }
                    const target = expertData.COST.costY[currentMenuIdx.value];
                    
                    target.YCostCd = '1';
                    target.YCostAmtRate = currentMaterialYearly.YCostAmtRate;
                    target.YCostRate = [...currentMaterialYearly.YCostRate];
                    // Map Amt to YMenuCost (old name) AND YCostAmt (new name) for safety
                    target.YCostAmt = [...currentMaterialYearly.YCostAmt];
                    target.YMenuCost = [...currentMaterialYearly.YCostAmt]; 
                }
                closeMaterialYearlyModal();
            };

            // Labor Yearly Logic
            const showLaborYearlyModal = ref(false);
            const currentJobIdx = ref(-1);
            const currentJobType = ref(''); // 'mfg' or 'sales'
            const currentLaborYearly = reactive({
                 JobTitle: '', YJobRate: 0,
                 YJobAmt: [0,0,0], BaseMonthly: 0
            });

            const openLaborYearlyModal = (idx, type) => {
                currentJobIdx.value = idx;
                currentJobType.value = type;
                const job = (type === 'mfg') ? expertData.JOB.job01[idx] : expertData.JOB.job02[idx];
                const jobY = (type === 'mfg') ? expertData.JOB.job01Y[idx] : expertData.JOB.job02Y[idx];
                
                currentLaborYearly.JobTitle = job.JobTitle;
                currentLaborYearly.YJobRate = jobY ? (jobY.YJobRate || 0) : 0;
                currentLaborYearly.BaseMonthly = (job.JobCnt || 0) * (job.JobQty || 0);
                
                calcLaborYearly();
                showLaborYearlyModal.value = true;
            };

            const closeLaborYearlyModal = () => { showLaborYearlyModal.value = false; };

            const calcLaborYearly = () => {
                const rate = (currentLaborYearly.YJobRate || 0)/100;
                const baseYearly = currentLaborYearly.BaseMonthly * 12;
                
                currentLaborYearly.YJobAmt[0] = baseYearly;
                currentLaborYearly.YJobAmt[1] = Math.round(baseYearly * (1 + rate));
                currentLaborYearly.YJobAmt[2] = Math.round(currentLaborYearly.YJobAmt[1] * (1 + rate));
            };

            const saveLaborYearly = () => {
                const targetList = (currentJobType.value === 'mfg') ? expertData.JOB.job01Y : expertData.JOB.job02Y;
                if(!targetList[currentJobIdx.value]) {
                    targetList[currentJobIdx.value] = { YJobAmt: [0,0,0], YJobRate: 0 };
                }
                targetList[currentJobIdx.value].YJobRate = currentLaborYearly.YJobRate;
                targetList[currentJobIdx.value].YJobAmt = [...currentLaborYearly.YJobAmt];
                
                closeLaborYearlyModal();
                updateProjections(); // Force refresh
            };

            



            // ================= LITE MODE STATE =================
            const liteData = reactive({
                BASIC: { industryCd: '3', monTargetPrice: 3000000, workDay: 25 },
                SALE: {
                    menu: [
                        { MenuTitle: 'Í∏∞Î≥∏ Î©îÎâ¥', MenuPrice: 10000, MenuQty: 30 }
                    ]
                },
                LITE_COST: { totalMonthlyCost: 1500000 }
            });

            // ================= EXPERT MODE STATE =================
            // ================= EXPERT MODE STATE =================
            // Based on User JSON Schema
            const expertData = reactive({
                BASIC: { industryCd: '3', workDay: 25, monTargetPrice: 5000000, saleMode: '1', growthRate: 5 },
                SALE: {
                    menu: [],
                    menuM: [],
                    menuY: []
                },
                COST: {
                    cost: [],
                    costM: [],
                    costY: []
                },
                JOB: {
                    job01: [],
                    job02: [], 
                    job01M: [], job02M: [],
                    job01Y: [], job02Y: [],
                    benefitRate: 0
                },
                INVEST: {
                    invest01: [],
                    invest02: [],
                    invest04: [],
                    invest06: [],
                    invest08: []
                },
                LOAN: {
                    loan01: [], // Capital
                    loan02: []  // Loans
                },
                MCOST: {
                    MCost: [],
                    MCostM: [],
                    MCostY: []
                },
                SCOST: {
                    SCost: [
                        { SCostTitle: 'ÏßÄÍ∏âÏûÑÏ∞®Î£å', SCostTitleCd: '12', SCostCd: 'ÏõîÏ†ïÏï°', SCostTVa: 1000000 },
                        { SCostTitle: 'Í≥µÍ≥ºÍ∏à', SCostCd: 'ÏõîÏ†ïÏï°', SCostTVa: 300000 },
                        { SCostTitle: 'Ïπ¥ÎìúÏàòÏàòÎ£å', SCostCd: 'Îß§Ï∂úÏï°', SCostTVa: 1.5 }
                    ],
                    SCostM: [],
                    SCostY: []
                }
            });

            // ================= PROJECTION ENGINE =================
            const updateProjections = () => {
                const saleMode = expertData.BASIC.saleMode || '1';
                const workDay = expertData.BASIC.workDay || 25;
                // Global growthRate is ignored now

                // 1. Menu Projections
                // Reset menuM (always recalc)
                expertData.SALE.menuM = [];
                expertData.COST.costM = [];
                
                expertData.SALE.menu.forEach((m, idx) => {
                    // Calc Monthly Qty/Amt per item
                    const price = m.MenuPrice || 0;
                    const baseQty = m.MenuQty || 0;
                    
                    const monthlyQty = (saleMode == '1') ? baseQty * workDay : baseQty;
                    const monthlyAmt = monthlyQty * price;

                    // A. menuM (12 Months)
                    const mQtyArr = Array(12).fill(monthlyQty);
                    const mAmtArr = Array(12).fill(monthlyAmt);
                    
                    expertData.SALE.menuM.push({ MMenuQty: mQtyArr, MMenuAmt: mAmtArr });

                    // B. menuY (3 Years)
                    // Init if missing
                    if (!expertData.SALE.menuY[idx]) {
                         expertData.SALE.menuY[idx] = {
                            YMenuCd: '1', YMenuQtyRate: 0, YMenuPriceRate: 0, 
                            YMenuQty: [0,0,0], YMenuPrice: [0,0,0], YMenuAmt: [0,0,0]
                         };
                    }
                    const yItem = expertData.SALE.menuY[idx];

                    // Year 1 Base (Always Sync with Menu Input)
                    const y1Qty = monthlyQty * 12;
                    const y1Amt = monthlyAmt * 12;
                    yItem.YMenuQty[0] = y1Qty;
                    yItem.YMenuPrice[0] = price;
                    yItem.YMenuAmt[0] = y1Amt;

                    // Recalc Y2/Y3 based on stored Cd
                    if (yItem.YMenuCd === '1') {
                         const qRate = (yItem.YMenuQtyRate || 0)/100;
                         const pRate = (yItem.YMenuPriceRate || 0)/100;
                         
                         yItem.YMenuQty[1] = Math.round(yItem.YMenuQty[0] * (1 + qRate));
                         yItem.YMenuPrice[1] = Math.round(yItem.YMenuPrice[0] * (1 + pRate));
                         yItem.YMenuAmt[1] = yItem.YMenuQty[1] * yItem.YMenuPrice[1];
                         
                         yItem.YMenuQty[2] = Math.round(yItem.YMenuQty[1] * (1 + qRate));
                         yItem.YMenuPrice[2] = Math.round(yItem.YMenuPrice[1] * (1 + pRate));
                         yItem.YMenuAmt[2] = yItem.YMenuQty[2] * yItem.YMenuPrice[2];
                    } else {
                         // Cd=2. Preserve Y2/Y3 Qty/Price. Update Amt.
                         yItem.YMenuAmt[1] = (yItem.YMenuQty[1]||0) * (yItem.YMenuPrice[1]||0);
                         yItem.YMenuAmt[2] = (yItem.YMenuQty[2]||0) * (yItem.YMenuPrice[2]||0);
                    }

                    // C. costM & costY (Material Cost Projections)
                    const costItem = expertData.COST.cost[idx];
                    const costRate = costItem ? (costItem.costRate || 0) : 0;

                    // Monthly Cost (Rate fixed for Month 1-12 in Y1)
                    // If Y1 rate is changed in Yearly modal, should we update costItem.costRate? 
                    // Usually Detailed Plan overrides Basic. But for now, let's keep basic sync one-way or simple.
                    // Let's assume MMenuCost uses the Basic Rate. 
                    const mCostArr = mAmtArr.map(amt => Math.round(amt * (costRate/100)));
                    expertData.COST.costM.push({ MMenuCost: mCostArr });

                    // Yearly Cost
                    // IMPORTANT: If YCostCd='1' is set by detailed modal, PRESERVE IT. 
                    // Otherwise, Init Default.
                    let yCostItem = expertData.COST.costY[idx];
                    if (!yCostItem) {
                        yCostItem = { 
                            YCostCd: '1', YCostAmtRate: 0,
                            YCostRate: [costRate, costRate, costRate],
                            YCostAmt: [0,0,0], YMenuCost: [0,0,0]
                        };
                        expertData.COST.costY[idx] = yCostItem;
                    }
                    
                    // Always Recalc Y1 Amt based on Revenue * Y1 Rate (Fixed or User set?)
                    // If user hasn't edited (default), YCostRate is [costRate, costRate, costRate].
                    // If user edited, YCostRate is preserved.
                    // BUT: Revenue (YMenuAmt) might have changed due to Sales Projection Update.
                    // SO: We MUST re-calculate AMOUNTS based on Rates.
                    
                    // Sync Y1 Rate to Menu Base if not edited? 
                    // Let's trust stored YCostRate if it exists. If empty, fill.
                    if(!yCostItem.YCostRate || yCostItem.YCostRate.length < 3) {
                         yCostItem.YCostRate = [costRate, costRate, costRate];
                    } else {
                        // Ensure Y1 Rate syncs with Basic Cost setting initially?
                        // If user changes "Basic Cost Rate" in Accordion, it should probably propagate to Y1.
                        // But if user manually edited Yearly Plan, maybe not?
                        // Let's Simple Sync: If YCostAmtRate is 0 and it looks like default, update Y1.
                        // Safest: Update Y1 Rate to matches Basic Cost Rate IF it seems like default mode.
                        // Or Just: Always calculate Amounts using stored Rates.
                        // AND: If YCostCd=1, we should theoretically re-run the "Increase Rate" logic if Revenue changed.
                        // To keep it clean: We just re-calc Amounts here using stored Rates.
                    }

                    // Recalc Amounts (Rev * Rate)
                    yCostItem.YMenuCost = yItem.YMenuAmt.map((amt, k) => Math.round(amt * (yCostItem.YCostRate[k] || 0)/100));
                    yCostItem.YCostAmt = [...yCostItem.YMenuCost];
                });
                
                // Trim menuY
                if (expertData.SALE.menuY.length > expertData.SALE.menu.length) {
                    expertData.SALE.menuY.splice(expertData.SALE.menu.length);
                }

                 // Trim costY
                 if (expertData.COST.costY.length > expertData.SALE.menu.length) {
                    expertData.COST.costY.splice(expertData.SALE.menu.length);
                }

                // 2. Labor Projections
                expertData.JOB.job01M = [];
                expertData.JOB.job02M = [];
                
                const processJob = (jobList, mList, yList) => {
                    jobList.forEach((j, idx) => {
                        const monthly = (j.JobCnt || 0) * (j.JobQty || 0);
                        mList.push({ MJobAmt: Array(12).fill(monthly) });
                        
                        // Yearly init
                        if(!yList[idx]) {
                            yList[idx] = { YJobAmt: [monthly*12, monthly*12, monthly*12], YJobRate: 0 };
                        } else {
                            // Sync Y1
                            yList[idx].YJobAmt[0] = monthly * 12;
                            // Recalc Y2, Y3 if needed? For now just keep or calc based on rate if we add it.
                            const rate = (yList[idx].YJobRate || 0) / 100;
                            yList[idx].YJobAmt[1] = Math.round(yList[idx].YJobAmt[0] * (1 + rate));
                            yList[idx].YJobAmt[2] = Math.round(yList[idx].YJobAmt[1] * (1 + rate));
                        }
                    });
                    if(yList.length > jobList.length) yList.splice(jobList.length);
                };

                processJob(expertData.JOB.job01, expertData.JOB.job01M, expertData.JOB.job01Y);
                processJob(expertData.JOB.job02, expertData.JOB.job02M, expertData.JOB.job02Y);
            };

            // Watch for changes that affect projection (Added JOB)
            watch(
                () => [expertData.SALE.menu, expertData.BASIC.saleMode, expertData.BASIC.workDay, expertData.JOB.job01, expertData.JOB.job02],
                () => {
                   updateProjections();
                },
                { deep: true }
            );

            // ================= PROFIT ANALYSIS ENGINE (NEW) =================
            const analyze_profitability = (data) => {
                const saleMode = data.BASIC.saleMode || '1';
                const workDay = data.BASIC.workDay || 25;
                const growthRate = (data.BASIC.growthRate || 0) / 100;
                const industryCd = data.BASIC.industryCd || '3'; // Default Food

                // 2.1 Sales & Material Cost
                let S_mon = 0;
                let MC_mon = 0;
                data.SALE.menu.forEach((m, i) => {
                    const price = m.MenuPrice || 0;
                    const qty = m.MenuQty || 0;
                    const itemSales = (saleMode == '1') ? (price * qty * workDay) : (price * qty);
                    S_mon += itemSales;
                    
                    const costItem = data.COST.cost[i];
                    const rate = costItem ? (costItem.costRate || 0) : 0;
                    MC_mon += itemSales * (rate / 100);
                });

                // 2.3 Depreciation (By BizCd: 1=Mfg, 2=Sales)
                // In current simple UI, assume all invest02 are Sales/Admin assets unless specified?
                // PRD says loop invest02 and check bizCd. Since UI doesn't have bizCd per item yet, assume all are General(2) for simplicity or split logic if needed.
                // Let's assume all are General Depreciation for now to fit KPI logic.
                // 2.3 Depreciation
                // Sum all relevant assets (invest01..08) IF investYn == 'Y'
                let Dep_total = 0;
                let TotalInvest = 0;
                
                const calcDep = (list) => {
                    if(!list) return;
                    list.forEach(inv => {
                        // In JSON, investPrice is raw int (e.g. 40000). 
                        // If it's 40,000 KRW, it's correct. 
                        // If it means 40,000 'Cheon-won' (40M), we should check.
                        // User prompt example: MenuPrice 20000 (20k), Invest 40000 (40k?). 
                        // Likely Invest is in 'Cheon-won' (Thousands) unit in typical KR apps, 
                        // BUT user sample menu is 20,000. Let's assume RAW UNIT for now as per valid JSON.
                        // Or if Invest is 40000 and Year is 5, YearAmt is 667 (~40000/60). 
                        // So 40000 is the full amount. 
                        
                        TotalInvest += (inv.investPrice || 0);
                        if(inv.investYn === 'Y' && (inv.investYear || 0) > 0) {
                            Dep_total += (inv.investPrice || 0) / (inv.investYear * 12);
                        }
                    });
                };
                
                calcDep(data.INVEST.invest01);
                calcDep(data.INVEST.invest02);
                calcDep(data.INVEST.invest04);
                // Deposit (invest06) usually not depreciated, but verify Yn
                calcDep(data.INVEST.invest06);
                calcDep(data.INVEST.invest08);

                // 2.4 Labor Cost
                let Labor_mfg = 0;
                let Labor_sales = 0;
                let Headcount = 0;
                
                // Job01 (Mfg)
                data.JOB.job01.forEach(j => {
                    Labor_mfg += (j.JobQty || 0) * (j.JobCnt || 0);
                    Headcount += (j.JobCnt || 0);
                });
                // Job02 (Sales)
                data.JOB.job02.forEach(j => {
                   Labor_sales += (j.JobQty || 0) * (j.JobCnt || 0);
                   Headcount += (j.JobCnt || 0);
                });
                
                const benefitRate = 0; // Removed as per user request
                const Labor_total = (Labor_mfg + Labor_sales);

                // 2.5 Expenses (Mfg vs Sales)
                let Exp_mfg = 0; 
                let Exp_sales = 0;
                let Rent_cost = 0; // For Rent Ratio

                // SCOST (Sales Expense)
                data.SCOST.SCost.forEach(item => {
                    let val = item.SCostTVa || 0;
                    let type = item.SCostCd;
                    let amount = 0;
                    
                    if(type === 'ÏõîÏ†ïÏï°') amount = val;
                    else if(type === 'Îß§Ï∂úÏï°') amount = S_mon * (val / 100);
                    else if(type === 'Ïù∏Í±¥ÎπÑ') amount = Labor_sales * (val / 100); // Linked to Sales Labor
                    
                    Exp_sales += amount;
                    
                    // Check Rent
                    if(item.SCostTitle && item.SCostTitle.includes('ÏûÑÏ∞®Î£å')) {
                        Rent_cost += amount;
                    }
                });
                
                // MCOST (Mfg Expense)
                if(data.MCOST && data.MCOST.MCost) {
                    data.MCOST.MCost.forEach(item => {
                         let val = item.MCostTVa || 0;
                        let type = item.MCostCd;
                        let amount = 0;
                        if(type === 'ÏõîÏ†ïÏï°') amount = val;
                        else if(type === 'Îß§Ï∂úÏï°') amount = S_mon * (val / 100);
                        else if(type === 'Ïù∏Í±¥ÎπÑ') amount = Labor_mfg * (val / 100);
                        
                        Exp_mfg += amount;
                    });
                }

                // 2.5 Interest
                // Loan uses array [Principal, ..] and [Rate, ..]
                let Interest_total = 0;
                if(data.LOAN.loan02) {
                    data.LOAN.loan02.forEach(l => {
                        // Access first element [0]
                        const principal = (l.loanYear && l.loanYear.length > 0) ? l.loanYear[0] : 0;
                        const rate = (l.loanRate && l.loanRate.length > 0) ? l.loanRate[0] : 0;
                        Interest_total += principal * (rate/100) / 12;
                    });
                }

                // Final Profit Calculation
                const TotalCost = MC_mon + Labor_total + Dep_total + Exp_mfg + Exp_sales + Interest_total;
                const OP = S_mon - TotalCost;
                
                // Indicators Calculation
                const safeDiv = (n, d) => d > 0 ? (n/d) : 0;
                
                const KPI_Turnover = safeDiv(S_mon * 12, TotalInvest);
                const KPI_OPMargin = safeDiv(OP, S_mon) * 100;
                const KPI_ROA = safeDiv(OP * 12, TotalInvest) * 100;
                const KPI_LaborRatio = safeDiv(Labor_total, S_mon) * 100;
                const KPI_SalesPerPerson = safeDiv(S_mon, Headcount);
                const KPI_RentRatio = safeDiv(Rent_cost, S_mon) * 100;

                // Industry Benchmarks (Standard)
                // 1:Mfg, 2:Retail, 3:Food, 4:Service, 5:Tech
                const benchmarks = {
                    '1': { turnover: 1.5, margin: 10.0, labor: 15.0, salesPer: 10000000, rent: 5.0 },
                    '2': { turnover: 2.7, margin: 10.8, labor: 8.8,  salesPer: 22800000, rent: 8.8 },
                    '3': { turnover: 1.8, margin: 16.2, labor: 22.0, salesPer: 9000000,  rent: 11.0 },
                    '4': { turnover: 0.9, margin: 32.4, labor: 27.5, salesPer: 7200000,  rent: 16.5 },
                    '5': { turnover: 1.4, margin: 21.8, labor: 44.0, salesPer: 4500000,  rent: 11.0 }
                };
                
                const std = benchmarks[industryCd] || benchmarks['3']; // Default to Food

                const diagnosis = [
                    { 
                        id: 'turnover', label: 'Ìà¨ÏûêÌöåÏ†ÑÏú®', 
                        value: KPI_Turnover.toFixed(1) + 'Ìöå', 
                        pass: KPI_Turnover >= std.turnover, 
                        msg: `Í∏∞Ï§Ä ${std.turnover}Ìöå Ïù¥ÏÉÅ` 
                    },
                    { 
                        id: 'margin', label: 'ÏòÅÏóÖÏù¥ÏùµÎ•†', 
                        value: KPI_OPMargin.toFixed(1) + '%', 
                        pass: KPI_OPMargin >= std.margin, 
                        msg: `Í∏∞Ï§Ä ${std.margin}% Ïù¥ÏÉÅ` 
                    },
                    { 
                        id: 'roa', label: 'Ï¥ùÏûêÏÇ∞Ïù¥ÏùµÎ•†(ROA)', 
                        value: KPI_ROA.toFixed(1) + '%', 
                        pass: KPI_ROA >= 5.0, // ROA benchmark missing in prompt table, assume 5% or just show? Prompt didn't give ROA specific standard. Let's use Margin logic or just pass true. 
                        // Wait, prompt 4. Comparisons only lists 5 indicators. ROA is derived. Let's use OpMargin pass as proxy or just show. 
                        // Actually, let's look at prompt table: It has 5 columns. 
                        // Let's just default ROA to 'info' or use > 5% as generic.
                        msg: 'ÎÜíÏùÑÏàòÎ°ù ÏñëÌò∏'
                    },
                    { 
                        id: 'labor', label: 'Ïù∏Í±¥ÎπÑÏú®', 
                        value: KPI_LaborRatio.toFixed(1) + '%', 
                        pass: KPI_LaborRatio <= std.labor, 
                        msg: `Í∏∞Ï§Ä ${std.labor}% Ïù¥Ìïò` 
                    },
                    { 
                        id: 'salesPer', label: '1Ïù∏Îãπ Îß§Ï∂ú', 
                        value: (KPI_SalesPerPerson / 10000).toFixed(0) + 'ÎßåÏõê', 
                        pass: KPI_SalesPerPerson >= std.salesPer, 
                        msg: `Í∏∞Ï§Ä ${std.salesPer/10000}ÎßåÏõê Ïù¥ÏÉÅ` 
                    },
                    { 
                        id: 'rent', label: 'ÏûÑÏ∞®Î£åÏú®', 
                        value: KPI_RentRatio.toFixed(1) + '%', 
                        pass: KPI_RentRatio <= std.rent, 
                        msg: `Í∏∞Ï§Ä ${std.rent}% Ïù¥Ìïò` 
                    }
                ];

                return {
                    S_mon, MC_mon, Labor_total, Dep_total, Exp_total: Exp_mfg + Exp_sales, Interest_total,
                    OP, TotalInvest,
                    KPI: { KPI_Turnover, KPI_OPMargin, KPI_ROA, KPI_LaborRatio, KPI_SalesPerPerson, KPI_RentRatio },
                    diagnosis
                };
            };

            // ================= HELPERS =================
            const formatCurrency = (val) => {
                if(isNaN(val)) return '0Ïõê';
                return new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW' }).format(val);
            };
            const formatCurrencyCheon = (val) => {
                if(isNaN(val)) return '0Ï≤úÏõê';
                const v = Math.round(val / 1000);
                return new Intl.NumberFormat('ko-KR').format(v) + 'Ï≤úÏõê';
            };
            const formatDate = (d) => d ? new Date(d).toLocaleString() : '';
            const parseReport = (rpt) => {
                try { return JSON.parse(rpt.reportData); } catch(e) { return {}; }
            };

            const getReportValues = (rpt) => {
                const data = parseReport(rpt);
                if (data.mode === 'expert' && data.summary) {
                    return {
                        mode: 'expert',
                        revenue: data.summary.totalRevenue,
                        netProfit: data.summary.opIncome,
                        bep: data.summary.bepRevenue
                    };
                }
                // Fallback / Lite
                return {
                    mode: data.mode || 'lite',
                    revenue: data.revenue || (data.liteResult ? data.liteResult.revenue : 0),
                    netProfit: data.netProfit || (data.liteResult ? data.liteResult.netProfit : 0),
                    bep: data.bep || 0
                };
            };

            // ================= LITE LOGIC =================
            const liteResult = computed(() => {
                // Revenue = sum(Price * Qty * 25days) assuming saleMode 1 default for Lite
                // Lite assumes Daily Qty input usually. Let's fix 25 days for Lite ease.
                // Revenue = sum(Price * Qty * WorkDays)
                const WORK_DAYS = liteData.BASIC.workDay || 25;
                let revenue = 0;
                liteData.SALE.menu.forEach(m => {
                    revenue += (m.MenuPrice || 0) * (m.MenuQty || 0) * WORK_DAYS;
                });
                
                const cost = liteData.LITE_COST.totalMonthlyCost || 0;
                const netProfit = revenue - cost;
                const gap = netProfit - liteData.BASIC.monTargetPrice;
                
                return { revenue, netProfit, gap };
            });

            // ================= EXPERT LOGIC (CORE) =================
            
            // 1. Calculate Revenue per Menu
            const calcMenuMonthlyRevenue = (menu) => {
                const price = menu.MenuPrice || 0;
                const qty = menu.MenuQty || 0;
                if(expertData.BASIC.saleMode == '1') {
                    // Daily
                    return price * qty * (expertData.BASIC.workDay || 0);
                } else {
                    // Monthly
                    return price * qty;
                }
            };

            const expertResult = computed(() => {
                // Use the new Analysis Engine
                const analysis = analyze_profitability(expertData);
                
                // Map Analysis to View Data
                const yearlySales = analysis.S_mon * 12;
                
                // Target Gap
                const targetGap = analysis.OP - (expertData.BASIC.monTargetPrice || 0);

                // BEP (Simplified from analysis data)
                const totalFixed = analysis.Labor_total + analysis.Dep_total + analysis.Interest_total + 
                                   (analysis.Exp_total * 0.5); // Approximation: Expenses are mixed. 
                                   // Accurate BEP needs split Fixed/Var expenses.
                                   // In analyze_profitability, we summed Exp. 
                                   // Let's re-calculate strict BEP here or enhance engine. 
                                   // The Engine calculated OP correctly. Let's reconstruct BEP logic here using data.
                
                // Re-calc strict BEP components for UI
                let fixedExp = 0;
                let varExp = 0;
                // Re-loop SCOST for Fixed/Var split
                 expertData.SCOST.SCost.forEach(item => {
                    let val = item.SCostTVa || 0;
                    if(item.SCostCd == 'ÏõîÏ†ïÏï°') fixedExp += val;
                    else if(item.SCostCd == 'Îß§Ï∂úÏï°') varExp += analysis.S_mon * (val / 100);
                    else if(item.SCostCd == 'Ïù∏Í±¥ÎπÑ') fixedExp += (analysis.Labor_total / (1+(expertData.JOB.benefitRate||0)/100)) * (val / 100); // approx
                });
                
                const FC = analysis.Labor_total + analysis.Dep_total + analysis.Interest_total + fixedExp;
                const VC = analysis.MC_mon + varExp;
                
                let bepRevenue = 0;
                if(analysis.S_mon > 0) {
                     const vRatio = VC / analysis.S_mon;
                     if(vRatio < 1) bepRevenue = FC / (1 - vRatio);
                }

                return {
                    totalRevenue: analysis.S_mon,
                    yearlySales,
                    totalMaterialCost: analysis.MC_mon,
                    totalLaborCost: analysis.Labor_total,
                    totalDepreciation: analysis.Dep_total,
                    totalInterest: analysis.Interest_total,
                    totalExpense: analysis.Exp_total,
                    opIncome: analysis.OP,
                    
                    opMargin: analysis.KPI.KPI_OPMargin.toFixed(1),
                    materialRatio: (analysis.MC_mon/analysis.S_mon*100).toFixed(1),
                    laborRatio: analysis.KPI.KPI_LaborRatio.toFixed(1),
                    expenseRatio: (analysis.Exp_total/analysis.S_mon*100).toFixed(1),
                    
                    targetGap,
                    totalFixedCost: FC,
                    bepRevenue,
                    diagnosis: analysis.diagnosis
                };
            });


            // ================= ACTIONS =================
            const switchMode = (m) => {
                console.log("Switching mode to:", m);
                try {
                    // 1. Prepare Data FIRST (before switching view)
                    if(m === 'expert') {
                        // ALWAYS Sync Basic Info from Lite -> Expert
                        if(liteData.BASIC) {
                            expertData.BASIC.industryCd = liteData.BASIC.industryCd;
                            expertData.BASIC.monTargetPrice = liteData.BASIC.monTargetPrice;
                            expertData.BASIC.workDay = liteData.BASIC.workDay;
                        }

                        // ALWAYS Sync/Merge Menus from Lite -> Expert
                        // We treat Lite as source of truth for the MAIN list structure when switching 
                        // but try to preserve Expert-only fields (like Cost Rate) if they exist.
                        
                        const liteMenus = liteData.SALE.menu || [];
                        const expertMenus = expertData.SALE.menu;
                        const expertCosts = expertData.COST.cost;

                        // 1. Update/Add items
                        liteMenus.forEach((lMenu, i) => {
                            if(expertMenus[i]) {
                                // Update existing
                                expertMenus[i].MenuTitle = lMenu.MenuTitle;
                                expertMenus[i].MenuPrice = lMenu.MenuPrice;
                                expertMenus[i].MenuQty = lMenu.MenuQty;
                                // costRate is preserved in expertCosts[i]
                            } else {
                                // Add new
                                expertMenus.push({ 
                                    MenuTitle: lMenu.MenuTitle, 
                                    MenuPrice: lMenu.MenuPrice, 
                                    MenuQty: lMenu.MenuQty 
                                });
                                expertCosts.push({ costRate: 35 }); // Default cost rate
                            }
                        });

                        // 2. Remove extra items if Lite list is shorter
                        if(expertMenus.length > liteMenus.length) {
                             expertMenus.splice(liteMenus.length);
                             expertCosts.splice(liteMenus.length);
                        }

                    } else if (m === 'lite') {
                         // ALWAYS Sync Basic Info from Expert -> Lite
                         if(expertData.BASIC) {
                            liteData.BASIC.industryCd = expertData.BASIC.industryCd;
                            liteData.BASIC.monTargetPrice = expertData.BASIC.monTargetPrice;
                            liteData.BASIC.workDay = expertData.BASIC.workDay;
                         }
                         
                         // ALWAYS Sync Menus from Expert -> Lite
                         const expertMenus = expertData.SALE.menu || [];
                         const liteMenus = liteData.SALE.menu;
                         
                         expertMenus.forEach((eMenu, i) => {
                             if(liteMenus[i]) {
                                 liteMenus[i].MenuTitle = eMenu.MenuTitle;
                                 liteMenus[i].MenuPrice = eMenu.MenuPrice;
                                 liteMenus[i].MenuQty = eMenu.MenuQty;
                             } else {
                                  liteMenus.push({
                                    MenuTitle: eMenu.MenuTitle, 
                                    MenuPrice: eMenu.MenuPrice, 
                                    MenuQty: eMenu.MenuQty 
                                  });
                             }
                         });
                         
                         // Remove extra
                         if(liteMenus.length > expertMenus.length) {
                             liteMenus.splice(expertMenus.length);
                         }

                         // Sync Total Cost (Material + Labor + Expense)
                         const res = expertResult.value;
                         const totalCost = (res.totalMaterialCost || 0) + (res.totalLaborCost || 0) + (res.totalExpense || 0);
                         if(!liteData.LITE_COST) liteData.LITE_COST = {};
                         liteData.LITE_COST.totalMonthlyCost = Math.round(totalCost);
                    }
                    
                    // 2. Switch Mode (Trigger Render)
                    mode.value = m;

                    // 3. Init Charts if Lite
                    // Charts removed

                    
                } catch(e) {
                    console.error("Mode switch error:", e);
                    alert("Î™®Îìú Ï†ÑÌôò Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: " + e.message);
                }
            };

            const addMenu = (list) => list.push({ MenuTitle: '', MenuPrice: 0, MenuQty: 0 });

            // ================= CHARTS =================
            // Charts removed as per user request

             onMounted(() => {
                // No charts
            });

            const removeMenu = (list, idx, costList) => {
                list.splice(idx, 1);
                if(costList) costList.splice(idx, 1);
            };
            
            const addMenuExpert = () => {
                expertData.SALE.menu.push({ MenuTitle: '', MenuPrice: 0, MenuQty: 0 });
                expertData.COST.cost.push({ costRate: 0 });
            };

            const addJob = (list) => list.push({ JobTitle: '', JobCnt: 1, JobQty: 0 });
            const addInvest = (list, yn='Y') => list.push({ investTitle: '', investPrice: 0, investYear: 5, investYn: yn });
            const addLoan = (list) => list.push({ loanTitle: '', loanYear: [0,0,0], loanRate: [5.0, 5.0, 5.0] });
            const addExpense = (list) => list.push({ SCostTitle: '', SCostCd: 'ÏõîÏ†ïÏï°', SCostTVa: 0 });

            // ================= TABLE HELPERS =================
            const formatNumber = (val) => {
                if(isNaN(val)) return '0';
                return new Intl.NumberFormat('ko-KR').format(val);
            };

            const sumArrayIdx = (list, keyArrayName, idx) => {
                let sum = 0;
                if(!list) return 0;
                list.forEach(item => {
                    if(item[keyArrayName] && item[keyArrayName][idx]) {
                         sum += item[keyArrayName][idx];
                    }
                });
                return sum;
            };

            // SERVER API
            const loadReports = async () => {
                try {
                    const res = await axios.get(`/api/report/`+userEmail.value);
                    reports.value = res.data;
                } catch(e) { console.error(e); }
            };

            const saveExpertReport = async () => {
                isSaving.value = true;
                const result = expertResult.value;
                
                // Construct payload
                const payload = {
                    mode: 'expert',
                    id: currentReportId.value, // Send ID for Update
                    ...expertData, // Spread full expert data
                    summary: { ...result } // Snapshot results
                };

                try {
                     await axios.post('/api/report', { userId: userEmail.value, content: payload, id: currentReportId.value });
                     alert('Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!');
                     loadReports();
                } catch(e) {
                    alert('Ï†ÄÏû• Ïã§Ìå®: ' + e.message);
                } finally {
                    isSaving.value = false;
                }
            };

            const loadReportToCanvas = (rpt) => {
                currentReportId.value = rpt.id; // Set ID
                const data = JSON.parse(rpt.reportData);
                if(data.mode === 'expert') {
                    mode.value = 'expert';
                    Object.assign(expertData, data);
                    // Ensure arrays exists (backward compatibility)
                    if(!expertData.BASIC) expertData.BASIC = {};
                    // ... verify other keys if needed
                } else {
                    mode.value = 'lite';
                   // Object.assign(liteData, data); // Map accordingly
                }
            };

            const deleteReport = async (id) => {
                if(!confirm('Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
                try {
                    await axios.delete(`/api/report/${id}`);
                    alert('ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
                    loadReports();
                    if(currentReportId.value === id) currentReportId.value = null;
                } catch(e) {
                    alert('ÏÇ≠Ï†ú Ïã§Ìå®: ' + e.message);
                }
            };

            onMounted(() => {
                loadReports();
            });

            return {
                mode, userEmail, isSaving, reports, showProjectionModal, showMaterialModal,
                liteData, expertData,
                liteResult, expertResult,
                switchMode,
                addMenu, removeMenu, addMenuExpert,
                addJob, addInvest, addLoan, addExpense,
                calcMenuMonthlyRevenue,
                formatCurrency, formatCurrencyCheon, formatDate, parseReport, getReportValues, loadReports, saveExpertReport, loadReportToCanvas, deleteReport, formatNumber, sumArrayIdx,
                showYearlyModal, currentMenu, currentYearly,
                openYearlyModal, closeYearlyModal, saveYearlyModal, calcYearly, calcYearlyDirect, onYMenuCdChange,
                showMaterialYearlyModal, currentMaterialYearly, openMaterialYearlyModal, closeMaterialYearlyModal, saveMaterialYearly, calcMaterialYearly,
                showLaborModal, expertData,
                showLaborYearlyModal, currentLaborYearly, openLaborYearlyModal, closeLaborYearlyModal, saveLaborYearly, calcLaborYearly


            };
        }
    }).mount('#app');
</script>
</body>
</html>
