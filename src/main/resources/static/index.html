<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlanfAi - ì†Œìƒê³µì¸ ìˆ˜ìµ ë¶„ì„</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link href="/common/common.css" rel="stylesheet">
    
    <!-- CDN Dependencies -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/common/common.js"></script>
</head>
<body>

<div id="app" class="container">
    <div class="glass-container">
        <!-- Header -->
        <header class="d-flex justify-content-between align-items-center mb-5">
            <div>
                <h1 class="display-5 mb-0" style="background: linear-gradient(to right, #6366f1, #ec4899); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent;">PlanfAi</h1>
                <p class="text-muted lead">ì†Œìƒê³µì¸ ìŠ¤ë§ˆíŠ¸ ìˆ˜ìµ ë¶„ì„ ì‹œìŠ¤í…œ</p>
            </div>
            <div class="d-flex gap-2">
                 <div class="input-group">
                    <span class="input-group-text bg-white">ID</span>
                    <input type="text" class="form-control" v-model="userEmail" placeholder="ì´ë©”ì¼ ì…ë ¥">
                 </div>
                 <button class="btn btn-outline-primary" @click="loadReports">ë¶ˆëŸ¬ì˜¤ê¸°</button>
            </div>
        </header>

        <!-- Mode Switcher -->
        <div class="mode-switch-container">
            <div class="mode-switch">
                <button :class="{ active: mode === 'lite' }" @click="switchMode('lite')">ğŸŒ± ê°„í¸ ëª¨ë“œ</button>
                <button :class="{ active: mode === 'expert' }" @click="switchMode('expert')">ğŸš€ ì „ë¬¸ê°€ ëª¨ë“œ</button>
            </div>
        </div>

            <!-- LITE MODE -->
            <div v-if="mode === 'lite'" key="lite">
                <div class="row g-4">
                    <div class="col-lg-5">
                        <div class="card-expert">
                            <div class="expert-header">
                                <h5>ğŸ“ ê¸°ë³¸ ì •ë³´ ì…ë ¥</h5>
                            </div>
                            <div class="expert-body">
                                <div class="mb-3">
                                    <label class="form-label small fw-bold">ì—…ì¢… ì„ íƒ</label>
                                    <select class="form-select" v-model="liteData.BASIC.industryCd">
                                        <option value="1">ì œì¡°ì—…</option>
                                        <option value="2">ì†Œë§¤ì—…</option>
                                        <option value="3">ì™¸ì‹ì—…</option>
                                        <option value="4">ì‹œì„¤ì„œë¹„ìŠ¤ì—…</option>
                                        <option value="5">ìš©ì—­ì„œë¹„ìŠ¤ì—…</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label small fw-bold">ì›” ëª©í‘œ ìˆœì´ìµ</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" v-model.number="liteData.BASIC.monTargetPrice">
                                        <span class="input-group-text">ì›</span>
                                    </div>
                                </div>

                                <hr class="my-4" style="opacity: 0.1">

                                <h6 class="mb-3 text-primary">íŒë§¤ ë©”ë‰´ ì…ë ¥</h6>
                                <div v-for="(menu, idx) in liteData.SALE.menu" :key="idx" class="mb-3 p-3 bg-light rounded-3 text-end position-relative">
                                    <button class="btn-close position-absolute top-0 end-0 m-2" @click="removeMenu(liteData.SALE.menu, idx)" style="font-size: 0.7rem;"></button>
                                    <div class="row g-2 mb-2">
                                        <div class="col-12">
                                            <input type="text" class="form-control form-control-sm" v-model="menu.MenuTitle" placeholder="ë©”ë‰´ëª… (ì˜ˆ: ì•„ë©”ë¦¬ì¹´ë…¸)">
                                        </div>
                                        <div class="col-6">
                                            <div class="input-group input-group-sm">
                                                <input type="number" class="form-control" v-model.number="menu.MenuPrice" placeholder="ë‹¨ê°€">
                                                <span class="input-group-text">ì›</span>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="input-group input-group-sm">
                                                <input type="number" class="form-control" v-model.number="menu.MenuQty" placeholder="í•˜ë£¨ íŒë§¤ëŸ‰">
                                                <span class="input-group-text">ê°œ</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <button class="btn btn-outline-primary w-100 btn-sm mb-4" @click="addMenu(liteData.SALE.menu)">+ ë©”ë‰´ ì¶”ê°€</button>

                                <div class="mb-3">
                                    <label class="form-label small fw-bold">ì›” ëŒ€ëµì  ë¹„ìš© (ê³ ì •ë¹„+ë³€ë™ë¹„)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" v-model.number="liteData.LITE_COST.totalMonthlyCost" placeholder="ì´ ë¹„ìš© ì…ë ¥">
                                        <span class="input-group-text">ì›</span>
                                    </div>
                                    <div class="form-text">ì¬ë£Œë¹„, ì›”ì„¸, ì¸ê±´ë¹„ ë“±ì„ í•©ì¹œ ëŒ€ëµì ì¸ ê¸ˆì•¡</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-7">
                        <div class="card-expert h-100 bg-white">
                            <div class="expert-header bg-white border-bottom-0">
                                <h5>ğŸ“Š ë¶„ì„ ê²°ê³¼</h5>
                            </div>
                            <div class="expert-body text-center pt-0">
                                <div class="py-5">
                                    <h6 class="text-uppercase text-muted small mb-2">í˜„ì¬ ì˜ˆìƒ ìˆœì´ìµ</h6>
                                    <h2 class="display-4 fw-bold mb-3" :class="liteResult.netProfit >= 0 ? 'text-primary' : 'text-danger'">
                                        {{ formatCurrency(liteResult.netProfit) }}
                                    </h2>
                                    
                                    <div class="alert mt-4" :class="liteResult.gap >= 0 ? 'alert-success' : 'alert-warning'">
                                        <span v-if="liteResult.gap >= 0">
                                            ğŸ‰ <strong>ì¶•í•˜í•©ë‹ˆë‹¤!</strong> ëª©í‘œ ìˆ˜ìµë³´ë‹¤ {{ formatCurrency(liteResult.gap) }} ì´ˆê³¼ ë‹¬ì„± ì¤‘ì…ë‹ˆë‹¤.
                                        </span>
                                        <span v-else>
                                            ğŸ’ª <strong>ì¡°ê¸ˆë§Œ ë”!</strong> ëª©í‘œê¹Œì§€ {{ formatCurrency(Math.abs(liteResult.gap)) }} ë¶€ì¡±í•©ë‹ˆë‹¤.
                                        </span>
                                    </div>

                                    <div class="card bg-light border-0 p-3 mt-4 text-start">
                                        <div class="d-flex align-items-center mb-2">
                                            <span class="badge bg-primary me-2">TIP</span>
                                            <span class="fw-bold">ëª©í‘œ ë‹¬ì„±ì„ ìœ„í•œ ì•¡ì…˜</span>
                                        </div>
                                        <p class="mb-0 text-muted small" v-if="liteData.SALE.menu.length > 0 && liteResult.gap < 0">
                                            "{{ liteData.SALE.menu[0].MenuTitle }}" ë©”ë‰´ë¥¼ í•˜ë£¨ì— 
                                            <strong class="text-dark">{{ Math.ceil(Math.abs(liteResult.gap) / (liteData.SALE.menu[0].MenuPrice * 25)) }}ê°œ</strong> 
                                            ë” íŒë§¤í•˜ë©´ ëª©í‘œì— ë„ë‹¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤! (25ì¼ ì˜ì—… ê¸°ì¤€)
                                        </p>
                                        <p class="mb-0 text-muted small" v-else>
                                            í˜„ì¬ ìƒíƒœê°€ ì•„ì£¼ ì¢‹ìŠµë‹ˆë‹¤. ë” ì •êµí•œ ë¶„ì„ì„ ì›í•˜ì‹œë©´ ì „ë¬¸ê°€ ëª¨ë“œë¥¼ ì´ìš©í•´ë³´ì„¸ìš”.
                                        </p>
                                    </div>
                                    
                                    <div class="mt-4 pt-3 border-top">
                                        <p class="text-muted small mb-3">ë‚´ ì¸ê±´ë¹„, ì„¸ê¸ˆ, ëŒ€ì¶œì´ìê¹Œì§€ ì •í™•íˆ ê³„ì‚°í•˜ê³  ì‹¶ìœ¼ì‹ ê°€ìš”?</p>
                                        <button class="btn btn-premium w-100" @click="switchMode('expert')">ğŸš€ ì „ë¬¸ê°€ ëª¨ë“œë¡œ ì „í™˜í•˜ì—¬ ì •ë°€ ë¶„ì„í•˜ê¸°</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- EXPERT MODE -->
            <div v-else key="expert">
                <div class="row">
                    <!-- Left: Input Sections -->
                    <div class="col-lg-6">
                        <div class="accordion" id="expertAccordion">
                            
                            <!-- 1. Basic Setup -->
                            <div class="accordion-item border-0 mb-3 shadow-sm rounded-3 overflow-hidden">
                                <h2 class="accordion-header">
                                    <button class="accordion-button fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBasic">
                                        <span class="section-badge">1ë‹¨ê³„</span> ê¸°ë³¸ í™˜ê²½ ì„¤ì •
                                    </button>
                                </h2>
                                <div id="collapseBasic" class="accordion-collapse collapse show" data-bs-parent="#expertAccordion">
                                    <div class="accordion-body bg-light">
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label class="form-label small">ì—…ì¢…</label>
                                                <select class="form-select form-select-sm" v-model="expertData.BASIC.industryCd">
                                                    <option value="1">ì œì¡°ì—…</option>
                                                    <option value="2">ì†Œë§¤ì—…</option>
                                                    <option value="3">ì™¸ì‹ì—…</option>
                                                    <option value="4">ì‹œì„¤ì„œë¹„ìŠ¤ì—…</option>
                                                    <option value="5">ìš©ì—­ì„œë¹„ìŠ¤ì—…</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label small">íŒë§¤ ê¸°ì¤€</label>
                                                <select class="form-select form-select-sm" v-model="expertData.BASIC.saleMode">
                                                    <option value="1">ì¼ íŒë§¤ëŸ‰ ê¸°ì¤€ (X ì˜ì—…ì¼)</option>
                                                    <option value="2">ì›” íŒë§¤ëŸ‰ ê¸°ì¤€</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label small">ì›” ì˜ì—…ì¼ìˆ˜</label>
                                                <input type="number" class="form-control form-control-sm" v-model.number="expertData.BASIC.workDay">
                                            </div>
                                             <div class="col-md-6">
                                                <label class="form-label small">ëª©í‘œ ìˆœì´ìµ</label>
                                                <input type="number" class="form-control form-control-sm" v-model.number="expertData.BASIC.monTargetPrice">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 2. Sales & Cost Plan -->
                            <div class="accordion-item border-0 mb-3 shadow-sm rounded-3 overflow-hidden">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSales">
                                        <span class="section-badge">2ë‹¨ê³„</span> ë§¤ì¶œ ë° ì¬ë£Œë¹„ ê³„íš
                                    </button>
                                </h2>
                                <div id="collapseSales" class="accordion-collapse collapse" data-bs-parent="#expertAccordion">
                                    <div class="accordion-body bg-light p-2">
                                        <div v-for="(menu, idx) in expertData.SALE.menu" :key="idx" class="card mb-2 border-0 shadow-sm">
                                            <div class="card-body p-3 position-relative">
                                                <button class="btn-close position-absolute top-0 end-0 m-2" @click="removeMenu(expertData.SALE.menu, idx, expertData.COST.cost)"></button>
                                                
                                                <div class="mb-2">
                                                    <input type="text" class="form-control form-control-sm fw-bold border-0 bg-light mb-1" v-model="menu.MenuTitle" placeholder="ë©”ë‰´ëª…">
                                                </div>
                                                <div class="row g-2">
                                                    <div class="col-4">
                                                        <label class="small text-muted">íŒë§¤ë‹¨ê°€</label>
                                                        <input type="number" class="form-control form-control-sm" v-model.number="menu.MenuPrice">
                                                    </div>
                                                    <div class="col-4">
                                                        <label class="small text-muted">{{ expertData.BASIC.saleMode == '1' ? 'ì¼ íŒë§¤ëŸ‰' : 'ì›” íŒë§¤ëŸ‰' }}</label>
                                                        <input type="number" class="form-control form-control-sm" v-model.number="menu.MenuQty">
                                                    </div>
                                                    <div class="col-4">
                                                        <label class="small text-muted">ì¬ë£Œë¹„ìœ¨(%)</label>
                                                        <input type="number" class="form-control form-control-sm" v-if="expertData.COST.cost[idx]" v-model.number="expertData.COST.cost[idx].costRate">
                                                    </div>
                                                </div>
                                                <div class="mt-2 text-end small text-muted">
                                                    ì˜ˆìƒ ì›” ë§¤ì¶œ: <strong class="text-primary">{{ formatCurrency(calcMenuMonthlyRevenue(menu)) }}</strong>
                                                </div>
                                            </div>
                                        </div>
                                        <button class="btn btn-outline-secondary w-100 btn-sm" @click="addMenuExpert">+ ë©”ë‰´ ì¶”ê°€</button>
                                    </div>
                                </div>
                            </div>

                            <!-- 3. Labor Plan -->
                            <div class="accordion-item border-0 mb-3 shadow-sm rounded-3 overflow-hidden">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapseLabor">
                                        <span class="section-badge">3ë‹¨ê³„</span> ì¸ê±´ë¹„ ê³„íš
                                    </button>
                                </h2>
                                <div id="collapseLabor" class="accordion-collapse collapse" data-bs-parent="#expertAccordion">
                                    <div class="accordion-body bg-light">
                                        
                                        <!-- Job 02 Sales/Admin -->
                                        <h6 class="small text-muted fw-bold mb-2">íŒë§¤/ê´€ë¦¬ì§ (íŒê´€ë¹„)</h6>
                                        <div v-for="(job, idx) in expertData.JOB.job02" :key="'j2'+idx" class="d-flex gap-2 mb-2 align-items-center">
                                            <input type="text" class="form-control form-control-sm" v-model="job.JobTitle" placeholder="ì§ì±…/ì„±ëª…" style="width: 30%">
                                            <input type="number" class="form-control form-control-sm" v-model.number="job.JobCnt" placeholder="ì¸ì›" style="width: 20%">
                                            <input type="number" class="form-control form-control-sm" v-model.number="job.JobQty" placeholder="ì›” ê¸‰ì—¬" style="width: 40%">
                                            <button class="btn-close" @click="expertData.JOB.job02.splice(idx, 1)"></button>
                                        </div>
                                        <button class="btn btn-sm btn-light w-100 border mb-3" @click="addJob(expertData.JOB.job02)">+ ì¸ì› ì¶”ê°€</button>

                                        <!-- Job 01 Mfg -->
                                        <h6 class="small text-muted fw-bold mb-2">ìƒì‚°/ì œì¡°ì§ (ì œì¡°ì›ê°€)</h6>
                                        <div v-for="(job, idx) in expertData.JOB.job01" :key="'j1'+idx" class="d-flex gap-2 mb-2 align-items-center">
                                            <input type="text" class="form-control form-control-sm" v-model="job.JobTitle" placeholder="ì§ì±…" style="width: 30%">
                                            <input type="number" class="form-control form-control-sm" v-model.number="job.JobCnt" placeholder="ì¸ì›" style="width: 20%">
                                            <input type="number" class="form-control form-control-sm" v-model.number="job.JobQty" placeholder="ì›” ê¸‰ì—¬" style="width: 40%">
                                            <button class="btn-close" @click="expertData.JOB.job01.splice(idx, 1)"></button>
                                        </div>
                                        <button class="btn btn-sm btn-light w-100 border" @click="addJob(expertData.JOB.job01)">+ ì¸ì› ì¶”ê°€</button>
                                    </div>
                                </div>
                            </div>

                            <!-- 4. Invest & Loan -->
                             <div class="accordion-item border-0 mb-3 shadow-sm rounded-3 overflow-hidden">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInvest">
                                        <span class="section-badge">4ë‹¨ê³„</span> íˆ¬ì ë° ìê¸ˆì¡°ë‹¬
                                    </button>
                                </h2>
                                <div id="collapseInvest" class="accordion-collapse collapse" data-bs-parent="#expertAccordion">
                                    <div class="accordion-body bg-light">
                                        <h6 class="small text-muted fw-bold">ê°ê°€ìƒê° ëŒ€ìƒ ìì‚° (ì¸í…Œë¦¬ì–´ ë“±)</h6>
                                        <div v-for="(inv, idx) in expertData.INVEST.invest02" :key="'i'+idx" class="row g-1 mb-2">
                                            <div class="col-4"><input type="text" class="form-control form-control-sm" v-model="inv.investTitle" placeholder="í•­ëª©"></div>
                                            <div class="col-3"><input type="number" class="form-control form-control-sm" v-model.number="inv.investPrice" placeholder="ê¸ˆì•¡"></div>
                                            <div class="col-2"><input type="number" class="form-control form-control-sm" v-model.number="inv.investYear" placeholder="ë…„ìˆ˜"></div>
                                            <div class="col-2">
                                                <select class="form-select form-select-sm" v-model="inv.investYn">
                                                    <option value="Y">ìƒê°</option>
                                                    <option value="N">ë¯¸ìƒê°</option>
                                                </select>
                                            </div>
                                            <div class="col-1"><button class="btn-close" @click="expertData.INVEST.invest02.splice(idx,1)"></button></div>
                                        </div>
                                        <button class="btn btn-sm btn-light w-100 border mb-4" @click="addInvest(expertData.INVEST.invest02)">+ ìì‚° ì¶”ê°€</button>

                                        <h6 class="small text-muted fw-bold">ëŒ€ì¶œê¸ˆ (ì´ìë¹„ìš©)</h6>
                                         <div v-for="(loan, idx) in expertData.LOAN.loan02" :key="'l'+idx" class="row g-1 mb-2">
                                            <div class="col-5"><input type="text" class="form-control form-control-sm" v-model="loan.loanTitle" placeholder="ëŒ€ì¶œëª…"></div>
                                            <div class="col-4"><input type="number" class="form-control form-control-sm" v-model.number="loan.loanPrice" placeholder="ì›ê¸ˆ"></div>
                                            <div class="col-2"><input type="number" class="form-control form-control-sm" v-model.number="loan.loanRate" placeholder="ì´ìœ¨%"></div>
                                            <div class="col-1"><button class="btn-close" @click="expertData.LOAN.loan02.splice(idx,1)"></button></div>
                                        </div>
                                         <button class="btn btn-sm btn-light w-100 border" @click="addLoan(expertData.LOAN.loan02)">+ ëŒ€ì¶œ ì¶”ê°€</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 5. General Expenses -->
                            <div class="accordion-item border-0 mb-3 shadow-sm rounded-3 overflow-hidden">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExpense">
                                        <span class="section-badge">5ë‹¨ê³„</span> ê²½ë¹„ ê³„íš (íŒê´€ë¹„/ì œì¡°ê²½ë¹„)
                                    </button>
                                </h2>
                                <div id="collapseExpense" class="accordion-collapse collapse" data-bs-parent="#expertAccordion">
                                    <div class="accordion-body bg-light">
                                        <h6 class="small text-muted fw-bold mb-2">íŒë§¤ê´€ë¦¬ë¹„ ì„¤ì •</h6>
                                        <div v-for="(sc, idx) in expertData.SCOST.SCost" :key="'sc'+idx" class="card mb-2 border-0 bg-white p-2">
                                            <div class="d-flex justify-content-between mb-1">
                                                 <input type="text" class="form-control form-control-sm border-0 fw-bold p-0" v-model="sc.SCostTitle" style="width: 50%">
                                                 <button class="btn-close small" @click="expertData.SCOST.SCost.splice(idx,1)"></button>
                                            </div>
                                            <div class="row g-2 align-items-center">
                                                <div class="col-5">
                                                    <select class="form-select form-select-sm" v-model="sc.SCostCd">
                                                        <option value="ì›”ì •ì•¡">ì›”ì •ì•¡(ì›)</option>
                                                        <option value="ë§¤ì¶œì•¡">ë§¤ì¶œëŒ€ë¹„(%)</option>
                                                        <option value="ì¸ê±´ë¹„">ì¸ê±´ë¹„ëŒ€ë¹„(%)</option>
                                                    </select>
                                                </div>
                                                <div class="col-7">
                                                    <input type="number" class="form-control form-control-sm" v-model.number="sc.SCostTVa" placeholder="ê°’ ì…ë ¥">
                                                </div>
                                            </div>
                                        </div>
                                        <button class="btn btn-sm btn-light w-100 border" @click="addExpense(expertData.SCOST.SCost)">+ ê²½ë¹„ í•­ëª© ì¶”ê°€</button>
                                    </div>
                                </div>
                            </div>
                        </div> <!-- End Accordion -->
                    </div>

                    <!-- Right: Dashboard -->
                    <div class="col-lg-6">
                        <div class="sticky-top" style="top: 20px; z-index: 900;">
                             <div class="card-expert bg-white shadow-lg border-0" style="border: 2px solid var(--primary-color);">
                                <div class="expert-header bg-white">
                                    <h5 class="text-primary fw-bold">ğŸ“ˆ ìˆ˜ìµì„± ë¶„ì„ ë¦¬í¬íŠ¸</h5>
                                    <button class="btn btn-premium btn-sm py-1 px-3" @click="saveExpertReport" :disabled="isSaving">
                                        {{ isSaving ? 'ì €ì¥ ì¤‘...' : 'ë¦¬í¬íŠ¸ ì €ì¥' }}
                                    </button>
                                </div>
                                <div class="expert-body">
                                    <!-- Key Metrics -->
                                    <div class="row text-center mb-4">
                                        <div class="col-6 mb-3">
                                            <small class="text-muted d-block text-uppercase" style="font-size: 0.7rem;">ì›” ì˜ˆìƒ ë§¤ì¶œ</small>
                                            <span class="fs-4 fw-bold text-dark">{{ formatCurrency(expertResult.totalRevenue) }}</span>
                                        </div>
                                        <div class="col-6 mb-3">
                                            <small class="text-muted d-block text-uppercase" style="font-size: 0.7rem;">ì˜ì—…ì´ìµ</small>
                                            <span class="fs-4 fw-bold" :class="expertResult.opIncome >= 0 ? 'text-primary' : 'text-danger'">{{ formatCurrency(expertResult.opIncome) }}</span>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted d-block text-uppercase" style="font-size: 0.7rem;">ì˜ì—… ì´ìµë¥ </small>
                                            <span class="fs-5 fw-bold text-dark">{{ expertResult.opMargin }}%</span>
                                        </div>
                                        <div class="col-6">
                                             <small class="text-muted d-block text-uppercase" style="font-size: 0.7rem;">ëª©í‘œ ë‹¬ì„±</small>
                                              <span class="badge rounded-pill" :class="expertResult.targetGap >= 0 ? 'bg-success' : 'bg-warning text-dark'">
                                                {{ expertResult.targetGap >= 0 ? 'ë‹¬ì„±' : 'ë¯¸ë‹¬' }}
                                              </span>
                                        </div>
                                    </div>
                                    
                                    <hr class="my-4" style="opacity: 0.1">

                                    <!-- Cost Breakdown Table -->
                                    <table class="table table-sm table-borderless small mb-4">
                                        <tbody>
                                            <tr>
                                                <td class="text-muted">(-) ì¬ë£Œë¹„ (COGS)</td>
                                                <td class="text-end fw-bold">{{ formatCurrency(expertResult.totalMaterialCost) }}</td>
                                                <td class="text-end text-muted" style="width: 40px">{{ expertResult.materialRatio }}%</td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">(-) ì¸ê±´ë¹„</td>
                                                <td class="text-end fw-bold">{{ formatCurrency(expertResult.totalLaborCost) }}</td>
                                                <td class="text-end text-muted">{{ expertResult.laborRatio }}%</td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">(-) íŒê´€ë¹„/ê²½ë¹„</td>
                                                <td class="text-end fw-bold">{{ formatCurrency(expertResult.totalExpense) }}</td>
                                                <td class="text-end text-muted">{{ expertResult.expenseRatio }}%</td>
                                            </tr>
                                             <tr>
                                                <td class="text-muted ps-3 fst-italic">ã„´ ì´ì/ê°ê°€ìƒê° í¬í•¨</td>
                                                <td></td>
                                                <td></td>
                                            </tr>
                                        </tbody>
                                        <tfoot class="border-top">
                                            <tr>
                                                <td class="pt-2 fw-bold">(=) ì˜ì—…ì´ìµ</td>
                                                <td class="pt-2 text-end fw-bold fs-6" :class="expertResult.opIncome >= 0 ? 'text-primary' : 'text-danger'">
                                                    {{ formatCurrency(expertResult.opIncome) }}
                                                </td>
                                                <td></td>
                                            </tr>
                                        </tfoot>
                                    </table>

                                    <!-- BEP Analysis -->
                                    <div class="card bg-warning-subtle border-0 p-3 mb-3">
                                        <h6 class="fw-bold mb-2 text-warning-emphasis">âš–ï¸ ì†ìµë¶„ê¸°ì  (BEP) ë¶„ì„</h6>
                                        <div class="d-flex justify-content-between mb-1 small">
                                            <span>BEP ë§¤ì¶œì•¡</span>
                                            <span class="fw-bold">{{ formatCurrency(expertResult.bepRevenue) }}</span>
                                        </div>
                                        <div class="d-flex justify-content-between small">
                                            <span>ê³ ì •ë¹„ í•©ê³„</span>
                                            <span>{{ formatCurrency(expertResult.totalFixedCost) }}</span>
                                        </div>
                                        <div class="progress mt-2" style="height: 6px;">
                                            <div class="progress-bar bg-warning" role="progressbar" :style="{ width: Math.min(100, (expertResult.totalRevenue / expertResult.bepRevenue) * 100) + '%' }"></div>
                                        </div>
                                        <div class="text-center mt-1" style="font-size: 0.7rem;">
                                            í˜„ì¬ BEPì˜ <strong>{{ Math.round((expertResult.totalRevenue / expertResult.bepRevenue) * 100) || 0 }}%</strong> ë‹¬ì„±
                                        </div>
                                    </div>
                                    
                                    <!-- Action Guide -->
                                    <div class="alert alert-light border small text-muted mb-0">
                                        <strong class="d-block mb-1 text-dark">ğŸ’¡ AI ë¶„ì„ ì½”ë©˜íŠ¸</strong>
                                        <span v-if="expertResult.targetGap < 0">
                                            ëª©í‘œ ì´ìµê¹Œì§€ <strong>{{ formatCurrency(Math.abs(expertResult.targetGap)) }}</strong> ë‚¨ì•˜ìŠµë‹ˆë‹¤. 
                                            ê³ ì •ë¹„ ë¹„ì¤‘ì´ {{ ((expertResult.totalFixedCost / expertResult.totalRevenue)*100).toFixed(1) }}%ë¡œ 
                                            {{ (expertResult.totalFixedCost / expertResult.totalRevenue) > 0.4 ? 'ë†’ì€ í¸ì…ë‹ˆë‹¤. ì„ì°¨ë£Œë‚˜ ì¸ê±´ë¹„ ì ˆê°ì´ í•„ìš”í•©ë‹ˆë‹¤.' : 'ì ì • ìˆ˜ì¤€ì…ë‹ˆë‹¤. ë§¤ì¶œ ì¦ëŒ€ì— ì§‘ì¤‘í•˜ì„¸ìš”.' }}
                                        </span>
                                        <span v-else>
                                            ëª©í‘œë¥¼ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤! í˜„ì¬ ì´ìµë¥  {{ expertResult.opMargin }}%ëŠ” ë§¤ìš° ì–‘í˜¸í•œ ìˆ˜ì¤€ì…ë‹ˆë‹¤.
                                        </span>
                                    </div>

                                </div>
                             </div>
                        </div>
                    </div>
                </div>
            </div> <!-- End Expert -->

        <!-- Reports List (Common) -->
        <hr class="my-5" style="opacity: 0.1">
        <div class="card-expert">
            <div class="expert-header">
                <h5>ğŸ—‚ï¸ ì €ì¥ëœ ë¦¬í¬íŠ¸ ì´ë ¥</h5>
            </div>
            <div class="card-body p-0 table-responsive">
                <table class="table table-hover table-premium mb-0">
                    <thead>
                        <tr>
                            <th class="ps-4">No.</th>
                            <th>êµ¬ë¶„</th>
                            <th>ë§¤ì¶œì•¡</th>
                            <th>ì˜ì—…ì´ìµ</th>
                            <th>BEP</th>
                            <th>ì‘ì„±ì¼ì‹œ</th>
                            <th>ì•¡ì…˜</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="rpt in reports" :key="rpt.id">
                            <td class="ps-4 text-muted small">#{{ rpt.id }}</td>
                            <td><span class="badge" :class="parseReport(rpt).mode === 'expert' ? 'bg-secondary' : 'bg-success'">{{ parseReport(rpt).mode === 'expert' ? 'ì „ë¬¸ê°€' : 'ê°„í¸' }}</span></td>
                            <td>{{ formatCurrency(parseReport(rpt).revenue) }}</td>
                            <td :class="parseReport(rpt).netProfit >= 0 ? 'text-primary fw-bold' : 'text-danger fw-bold'">{{ formatCurrency(parseReport(rpt).netProfit) }}</td>
                            <td class="text-muted small">{{ parseReport(rpt).bep ? formatCurrency(parseReport(rpt).bep) : '-' }}</td>
                            <td class="text-muted small">{{ formatDate(rpt.createdAt) }}</td>
                            <td><button class="btn btn-sm btn-outline-secondary" @click="loadReportToCanvas(rpt)">ë¶ˆëŸ¬ì˜¤ê¸°</button></td>
                        </tr>
                        <tr v-if="reports.length === 0">
                            <td colspan="7" class="text-center py-5 text-muted">ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</div>

<script>
    const { createApp, ref, reactive, computed, watch, onMounted } = Vue;

    createApp({
        setup() {
            const mode = ref('lite'); // 'lite' or 'expert'
            const userEmail = ref('test@example.com');
            const isSaving = ref(false);
            const reports = ref([]);

            // ================= LITE MODE STATE =================
            const liteData = reactive({
                BASIC: { industryCd: '3', monTargetPrice: 3000000 },
                SALE: {
                    menu: [
                        { MenuTitle: 'ê¸°ë³¸ ë©”ë‰´', MenuPrice: 10000, MenuQty: 30 }
                    ]
                },
                LITE_COST: { totalMonthlyCost: 1500000 }
            });

            // ================= EXPERT MODE STATE =================
            const expertData = reactive({
                BASIC: { industryCd: '3', saleMode: '1', workDay: 25, monTargetPrice: 5000000 },
                SALE: { menu: [] },
                COST: { cost: [] }, // matched index with SALE.menu
                JOB: { job01: [], job02: [] }, // Mfg, Sales
                INVEST: { invest02: [], invest06: [] },
                LOAN: { loan01: [], loan02: [] },
                SCOST: { SCost: [
                    { SCostTitle: 'ì„ì°¨ë£Œ', SCostCd: 'ì›”ì •ì•¡', SCostTVa: 1000000 },
                    { SCostTitle: 'ê³µê³¼ê¸ˆ', SCostCd: 'ì›”ì •ì•¡', SCostTVa: 300000 },
                    { SCostTitle: 'ì¹´ë“œìˆ˜ìˆ˜ë£Œ', SCostCd: 'ë§¤ì¶œì•¡', SCostTVa: 1.5 }
                ] }, 
                MCOST: { MCost: [] }
            });

            // ================= HELPERS =================
            const formatCurrency = (val) => {
                if(isNaN(val)) return '0ì›';
                return new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW' }).format(val);
            };
            const formatDate = (d) => d ? new Date(d).toLocaleString() : '';
            const parseReport = (rpt) => {
                try { return JSON.parse(rpt.reportData); } catch(e) { return {}; }
            };

            // ================= LITE LOGIC =================
            const liteResult = computed(() => {
                // Revenue = sum(Price * Qty * 25days) assuming saleMode 1 default for Lite
                // Lite assumes Daily Qty input usually. Let's fix 25 days for Lite ease.
                const WORK_DAYS = 25;
                let revenue = 0;
                liteData.SALE.menu.forEach(m => {
                    revenue += (m.MenuPrice || 0) * (m.MenuQty || 0) * WORK_DAYS;
                });
                
                const cost = liteData.LITE_COST.totalMonthlyCost || 0;
                const netProfit = revenue - cost;
                const gap = netProfit - liteData.BASIC.monTargetPrice;
                
                return { revenue, netProfit, gap };
            });

            // ================= EXPERT LOGIC (CORE) =================
            
            // 1. Calculate Revenue per Menu
            const calcMenuMonthlyRevenue = (menu) => {
                const price = menu.MenuPrice || 0;
                const qty = menu.MenuQty || 0;
                if(expertData.BASIC.saleMode == '1') {
                    // Daily
                    return price * qty * (expertData.BASIC.workDay || 0);
                } else {
                    // Monthly
                    return price * qty;
                }
            };

            const expertResult = computed(() => {
                // A. Total Revenue
                let totalRevenue = 0;
                expertData.SALE.menu.forEach(m => totalRevenue += calcMenuMonthlyRevenue(m));

                // B. Material Cost (Variable)
                let totalMaterialCost = 0;
                expertData.SALE.menu.forEach((m, idx) => {
                    const rev = calcMenuMonthlyRevenue(m);
                    const costItem = expertData.COST.cost[idx];
                    const rate = costItem ? (costItem.costRate || 0) : 0;
                    totalMaterialCost += rev * (rate / 100);
                });

                // C. Labor Cost (Fixed usually)
                let totalLaborCost = 0;
                // Job01 (Mfg) + Job02 (Sales)
                [...expertData.JOB.job01, ...expertData.JOB.job02].forEach(j => {
                    totalLaborCost += (j.JobQty || 0) * (j.JobCnt || 0);
                });

                // D. Depreciation (Fixed)
                let totalDepreciation = 0;
                [...expertData.INVEST.invest02].forEach(inv => {
                    if(inv.investYn === 'Y' && inv.investYear > 0) {
                        // Monthly depreciation
                        totalDepreciation += (inv.investPrice || 0) / (inv.investYear * 12);
                    }
                });

                // E. Interest (Fixed)
                let totalInterest = 0;
                [...expertData.LOAN.loan02].forEach(l => {
                    // Monthly interest
                    totalInterest += (l.loanPrice || 0) * ((l.loanRate || 0)/100) / 12;
                });

                // F. Other Expenses (Variable vs Fixed Mix)
                let totalFixedExpense = 0;
                let totalVariableExpense = 0; // % of Revenue

                // Helper to process SCost/MCost
                const processExpense = (list) => {
                    list.forEach(item => {
                        let val = item.SCostTVa || item.MCostTVa || 0; 
                        let type = item.SCostCd || item.MCostCd;
                        
                        if(type === 'ì›”ì •ì•¡') {
                            totalFixedExpense += val;
                        } else if(type === 'ë§¤ì¶œì•¡') {
                            // Variable
                            totalVariableExpense += totalRevenue * (val / 100);
                        } else if(type === 'ì¸ê±´ë¹„') {
                            // Fixed (linked to fixed labor)
                            totalFixedExpense += totalLaborCost * (val / 100);
                        }
                    });
                };

                processExpense(expertData.SCOST.SCost);
                // processExpense(expertData.MCOST.MCost); // Add if needed

                // Aggregates
                const totalExpense = totalFixedExpense + totalVariableExpense + totalDepreciation + totalInterest;
                const totalCostAll = totalMaterialCost + totalLaborCost + totalExpense;
                const opIncome = totalRevenue - totalCostAll;
                
                // Ratios
                const materialRatio = totalRevenue ? ((totalMaterialCost/totalRevenue)*100).toFixed(1) : 0;
                const laborRatio = totalRevenue ? ((totalLaborCost/totalRevenue)*100).toFixed(1) : 0;
                const expenseRatio = totalRevenue ? ((totalExpense/totalRevenue)*100).toFixed(1) : 0;
                const opMargin = totalRevenue ? ((opIncome/totalRevenue)*100).toFixed(1) : 0;
                const targetGap = opIncome - (expertData.BASIC.monTargetPrice || 0);

                // BEP Calculation
                // BEP Revenue = Total Fixed Cost / (1 - Variable Ratio)
                // Fixed Costs = Labor + Depreciation + Interest + Fixed Expenses
                const totalFixed = totalLaborCost + totalDepreciation + totalInterest + totalFixedExpense;
                
                // Variable Costs = Material + Variable Expenses
                const totalVariable = totalMaterialCost + totalVariableExpense;
                
                let bepRevenue = 0;
                if(totalRevenue > 0) {
                    const variableRatio = totalVariable / totalRevenue;
                    if(variableRatio < 1) {
                         bepRevenue = totalFixed / (1 - variableRatio);
                    }
                }

                return {
                    totalRevenue,
                    totalMaterialCost,
                    totalLaborCost,
                    totalExpense,
                    opIncome,
                    opMargin,
                    materialRatio, laborRatio, expenseRatio,
                    targetGap,
                    totalFixedCost: totalFixed,
                    bepRevenue
                };
            });


            // ================= ACTIONS =================
            const switchMode = (m) => {
                console.log("Switching mode to:", m);
                try {
                    // 1. Prepare Data FIRST (before switching view)
                    if(m === 'expert') {
                        // A. Migration from Lite if needed
                        if(expertData.SALE.menu.length === 0 && liteData.SALE.menu.length > 0) {
                             console.log("Migrating data from Lite...");
                             expertData.SALE.menu = JSON.parse(JSON.stringify(liteData.SALE.menu));
                             expertData.COST.cost = []; 
                             expertData.SALE.menu.forEach(() => {
                                 expertData.COST.cost.push({ costRate: 35 });
                             });
                        }

                        // B. Safety Sync (Ensure Cost array matches Sales array)
                        const diff = expertData.SALE.menu.length - expertData.COST.cost.length;
                        if(diff > 0) {
                             console.log("Syncing cost array...", diff);
                             for(let i=0; i<diff; i++) expertData.COST.cost.push({ costRate: 35 });
                        }
                    }
                    
                    // 2. Switch Mode (Trigger Render)
                    mode.value = m;
                    
                } catch(e) {
                    console.error("Mode switch error:", e);
                    alert("ëª¨ë“œ ì „í™˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.message);
                }
            };

            const addMenu = (list) => list.push({ MenuTitle: '', MenuPrice: 0, MenuQty: 0 });
            const removeMenu = (list, idx, costList) => {
                list.splice(idx, 1);
                if(costList) costList.splice(idx, 1);
            };
            
            const addMenuExpert = () => {
                expertData.SALE.menu.push({ MenuTitle: '', MenuPrice: 0, MenuQty: 0 });
                expertData.COST.cost.push({ costRate: 0 });
            };

            const addJob = (list) => list.push({ JobTitle: '', JobCnt: 1, JobQty: 0 });
            const addInvest = (list) => list.push({ investTitle: '', investPrice: 0, investYear: 5, investYn: 'Y' });
            const addLoan = (list) => list.push({ loanTitle: '', loanPrice: 0, loanRate: 5.0 });
            const addExpense = (list) => list.push({ SCostTitle: '', SCostCd: 'ì›”ì •ì•¡', SCostTVa: 0 });

            // SERVER API
            const loadReports = async () => {
                try {
                    const res = await axios.get(`/api/report/${userEmail.value}`);
                    reports.value = res.data;
                } catch(e) { console.error(e); }
            };

            const saveExpertReport = async () => {
                isSaving.value = true;
                const result = expertResult.value;
                
                // Construct payload
                const payload = {
                    mode: 'expert',
                    ...expertData, // Spread full expert data
                    summary: { ...result } // Snapshot results
                };

                try {
                     await axios.post('/api/report', { userId: userEmail.value, content: payload });
                     alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                     loadReports();
                } catch(e) {
                    alert('ì €ì¥ ì‹¤íŒ¨: ' + e.message);
                } finally {
                    isSaving.value = false;
                }
            };

            const loadReportToCanvas = (rpt) => {
                const data = JSON.parse(rpt.reportData);
                if(data.mode === 'expert') {
                    mode.value = 'expert';
                    Object.assign(expertData, data);
                    // Ensure arrays exists (backward compatibility)
                    if(!expertData.BASIC) expertData.BASIC = {};
                    // ... verify other keys if needed
                } else {
                    mode.value = 'lite';
                   // Object.assign(liteData, data); // Map accordingly
                }
            };

            onMounted(() => {
                loadReports();
            });

            return {
                mode, userEmail, isSaving, reports,
                liteData, expertData,
                liteResult, expertResult,
                switchMode,
                addMenu, removeMenu, addMenuExpert,
                addJob, addInvest, addLoan, addExpense,
                calcMenuMonthlyRevenue,
                formatCurrency, formatDate, parseReport, loadReports, saveExpertReport, loadReportToCanvas
            };
        }
    }).mount('#app');
</script>
</body>
</html>
