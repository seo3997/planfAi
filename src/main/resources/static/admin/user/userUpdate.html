<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>사용자 수정 - PlanfAi 관리자</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="/admin/js/admin_common.js"></script>
    <link href="/admin/css/admin_style.css" rel="stylesheet">
    <style>
        .form-section { background: #fff; border: 1px solid #dee2e6; padding: 0; margin-bottom: 30px; }
        .section-title { padding: 15px 20px; font-size: 16px; font-weight: 600; color: #2b4c80; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 8px; }
        .form-table { width: 100%; border-collapse: collapse; }
        .form-table th { width: 150px; background: #f8f9fa; padding: 15px 20px; font-weight: 500; font-size: 14px; text-align: left; border-bottom: 1px solid #eee; border-right: 1px solid #eee; }
        .form-table td { padding: 12px 20px; border-bottom: 1px solid #eee; }
        .input-group-contact { display: flex; align-items: center; gap: 10px; width: 350px; }
        .btn-cancel { background-color: #31c4b6; border: none; color: white; padding: 8px 40px; border-radius: 4px; font-size: 14px; }
        .btn-submit { background-color: #2b4c80; color: white; border: none; padding: 8px 40px; border-radius: 4px; font-size: 14px; }
        .radio-group label { margin-right: 25px; cursor: pointer; font-size: 14px; }
    </style>
</head>
<body>
    <div id="app">
        <admin-header></admin-header>

        <div class="main-container">
            <admin-sidebar></admin-sidebar>

            <main class="content">
                <div class="page-title-box">
                    <h2 class="page-title">사용자 수정</h2>
                    <div class="breadcrumb-area">
                        <i class="bi bi-house-door text-muted"></i> > 기본정보 > <span class="text-primary fw-medium">사용자</span>
                    </div>
                </div>

                <div class="form-section">
                    <div class="section-title">
                        <i class="bi bi-caret-right-fill text-primary"></i> 기본정보
                    </div>
                    <table class="form-table">
                        <tr>
                            <th>사용자ID</th>
                            <td>
                                <input type="text" class="form-control bg-light" v-model="user.userId" readonly style="width: 350px;">
                            </td>
                            <th>비밀번호</th>
                            <td>
                                <input type="password" class="form-control" v-model="user.password" placeholder="변경 시에만 입력" style="width: 350px;">
                            </td>
                        </tr>
                        <tr>
                            <th>이름</th>
                            <td>
                                <input type="text" class="form-control" v-model="user.userNm" placeholder="이름" style="width: 350px;">
                            </td>
                            <th>연락처</th>
                            <td>
                                <div class="input-group-contact">
                                    <input type="text" class="form-control text-center" v-model="contact.part1">
                                    <span>-</span>
                                    <input type="text" class="form-control text-center" v-model="contact.part2">
                                    <span>-</span>
                                    <input type="text" class="form-control text-center" v-model="contact.part3">
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <th>이메일</th>
                            <td>
                                <input type="email" class="form-control" v-model="user.email" placeholder="이메일" style="width: 350px;">
                            </td>
                            <th>사용자 상태 코드</th>
                            <td>
                                <select class="form-select" v-model="user.userSttusCode" style="width: 350px;">
                                    <option v-for="st in statusCodes" :key="st.CODE" :value="st.CODE">{{ st.CODE_NM }}</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <th>지역</th>
                            <td colspan="3">
                                <div class="d-flex gap-2">
                                    <select class="form-select" v-model="user.areaCode" style="width: 200px;">
                                        <option value="">서울특별시</option>
                                    </select>
                                    <select class="form-select" v-model="user.areaSeCodeS" style="width: 200px;">
                                        <option value="">선택하세요</option>
                                    </select>
                                    <select class="form-select" v-model="user.areaSeCodeD" style="width: 200px;">
                                        <option value="">선택하세요</option>
                                    </select>
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>

                <div class="form-section">
                    <div class="section-title">
                        <i class="bi bi-caret-right-fill text-primary"></i> 권한
                    </div>
                    <table class="form-table">
                        <tr>
                            <th>권한선택</th>
                            <td>
                                <div class="radio-group">
                                    <label v-for="auth in authors" :key="auth.AUTHOR_ID">
                                        <input type="radio" v-model="user.authorId" :value="auth.AUTHOR_ID"> {{ auth.AUTHOR_NM }}
                                    </label>
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>

                <div class="d-flex justify-content-center gap-2 mt-4 mb-5">
                    <button class="btn btn-cancel" @click="goBack"><i class="bi bi-reply"></i> 취소</button>
                    <button class="btn btn-submit" @click="saveUser">확인</button>
                </div>

                <admin-footer></admin-footer>
            </main>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted } = Vue;
        const app = createApp({
            setup() {
                const authors = ref([]);
                const statusCodes = ref([]);
                const user = ref({});
                const contact = ref({ part1: '', part2: '', part3: '' });
                const userNo = new URLSearchParams(window.location.search).get('userNo');

                const fetchAuthors = () => {
                    axios.get('/api/admin/user/authors')
                        .then(res => authors.value = res.data);
                };

                const fetchStatusCodes = () => {
                    axios.get('/api/admin/user/status-codes')
                        .then(res => statusCodes.value = res.data);
                };

                const fetchUserDetail = () => {
                    if(!userNo) return;
                    axios.get(`/api/admin/user/${userNo}`)
                        .then(res => {
                            user.value = res.data;
                            user.value.password = ''; // Don't show hash
                            if (user.value.cttpc) {
                                const parts = user.value.cttpc.split('-');
                                contact.value.part1 = parts[0] || '';
                                contact.value.part2 = parts[1] || '';
                                contact.value.part3 = parts[2] || '';
                            }
                        });
                };

                const saveUser = () => {
                    user.value.cttpc = `${contact.value.part1}-${contact.value.part2}-${contact.value.part3}`;
                    
                    axios.put('/api/admin/user', user.value)
                        .then(res => {
                            alert('수정되었습니다.');
                            location.href = `/admin/user/selectUserMgt.do?userNo=${userNo}`;
                        }).catch(err => alert('수정 중 오류 발생'));
                };

                const goBack = () => history.back();

                onMounted(() => {
                    AdminMenu.init();
                    fetchAuthors();
                    fetchStatusCodes();
                    fetchUserDetail();
                });

                return { authors, statusCodes, user, contact, saveUser, goBack };
            }
        });
        AdminLayout.register(app);
        app.mount('#app');
    </script>
</body>
</html>
