<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>코드 상세 관리 - PlanfAi 관리자</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="/admin/js/admin_common.js"></script>
    <link href="/admin/css/admin_style.css" rel="stylesheet">
    <style>
        .form-table { width: 100%; border-collapse: collapse; background: #fff; margin-bottom: 20px; }
        .form-table th { background: #f9f9f9; padding: 12px; border: 1px solid #ddd; width: 180px; text-align: center; font-weight: 500; }
        .form-table td { padding: 8px 12px; border: 1px solid #ddd; }
        .inline-input { width: 100%; border: 1px solid #ddd; padding: 4px 8px; font-size: 13px; }
        .inline-select { width: 100%; border: 1px solid #ddd; padding: 4px 8px; font-size: 13px; }
    </style>
</head>
<body>
    <div id="app">
        <admin-header></admin-header>

        <div class="main-container">
            <admin-sidebar></admin-sidebar>

            <main class="content">
                <div class="page-title-box">
                    <h2 class="page-title">코드관리</h2>
                    <div class="breadcrumb-area">
                        <i class="bi bi-house-door"></i> > 시스템 > <span class="text-dark fw-medium">코드관리</span>
                    </div>
                </div>

                <!-- Group Code Info -->
                <div class="card shadow-sm border-0 p-3 mb-4" style="background-color: #f4f7f6;">
                    <table class="form-table">
                        <tr>
                            <th>그룹코드</th>
                            <td><input type="text" v-model="group.groupId" class="form-control" readonly style="background-color: #eee;"></td>
                        </tr>
                        <tr>
                            <th>그룹코드명</th>
                            <td><input type="text" v-model="group.groupNm" class="form-control"></td>
                        </tr>
                        <tr>
                            <th>영문그룹코드명</th>
                            <td><input type="text" v-model="group.groupNmEng" class="form-control"></td>
                        </tr>
                        <tr>
                            <th>비고</th>
                            <td><input type="text" v-model="group.rm" class="form-control"></td>
                        </tr>
                    </table>
                </div>

                <!-- Sub Codes Table -->
                <div class="card shadow-sm border-0 p-3" style="background-color: #f4f7f6;">
                    <div class="data-table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 15%;">코드</th>
                                    <th style="width: 20%;">코드명</th>
                                    <th style="width: 15%;">영문코드명</th>
                                    <th>속성1</th>
                                    <th>속성2</th>
                                    <th>속성3</th>
                                    <th style="width: 80px;">순서</th>
                                    <th style="width: 100px;">사용여부</th>
                                    <th style="width: 80px;">삭제</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="(code, index) in codes" :key="index">
                                    <td><input type="text" v-model="code.code" class="inline-input" :readonly="!code.isNew"></td>
                                    <td><input type="text" v-model="code.codeNm" class="inline-input"></td>
                                    <td><input type="text" v-model="code.codeNmEng" class="inline-input"></td>
                                    <td><input type="text" v-model="code.attrb1" class="inline-input"></td>
                                    <td><input type="text" v-model="code.attrb2" class="inline-input"></td>
                                    <td><input type="text" v-model="code.attrb3" class="inline-input"></td>
                                    <td><input type="number" v-model="code.sortOrdr" class="inline-input text-center"></td>
                                    <td>
                                        <select v-model="code.useYn" class="inline-select">
                                            <option value="Y">예</option>
                                            <option value="N">아니오</option>
                                        </select>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-table-del" @click="removeRow(index, code)"><i class="bi bi-dash-circle"></i> 삭제</button>
                                    </td>
                                </tr>
                                <tr v-if="codes.length === 0">
                                    <td colspan="9" class="text-center py-4 text-muted">등록된 코드가 없습니다.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="d-flex justify-content-center gap-2 mt-4">
                        <button class="btn btn-list px-4" @click="goBack"><i class="bi bi-reply-fill"></i> 목록</button>
                        <button class="btn btn-save px-4" @click="saveAll"><i class="bi bi-check-lg"></i> 수정</button>
                        <button class="btn btn-write px-4" @click="addRow"><i class="bi bi-plus-lg"></i> 신규등록</button>
                    </div>
                </div>
                <admin-footer></admin-footer>
            </main>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted } = Vue;
        const app = createApp({
            setup() {
                const groupId = new URLSearchParams(window.location.search).get('groupId');
                const group = ref({ groupId: '', groupNm: '', groupNmEng: '', rm: '' });
                const codes = ref([]);

                const fetchGroupDetail = () => {
                    axios.get(`/api/admin/code/groups/${groupId}`)
                        .then(res => group.value = res.data)
                        .catch(err => alert('그룹 조회 실패'));
                };

                const fetchCodes = () => {
                    axios.get(`/api/admin/code/sub/${groupId}`)
                        .then(res => {
                            codes.value = res.data.map(c => ({ ...c, isNew: false, isDeleted: false }));
                        })
                        .catch(err => alert('코드 조회 실패'));
                };

                const addRow = () => {
                    codes.value.push({
                        groupId: groupId,
                        code: '',
                        codeNm: '',
                        codeNmEng: '',
                        attrb1: '',
                        attrb2: '',
                        attrb3: '',
                        sortOrdr: codes.value.length + 1,
                        useYn: 'Y',
                        isNew: true
                    });
                };

                const removeRow = async (index, code) => {
                    if (code.isNew) {
                        codes.value.splice(index, 1);
                    } else {
                        if (confirm('정말 삭제하시겠습니까?')) {
                            try {
                                await axios.delete(`/api/admin/code/sub/${groupId}/${code.code}`);
                                codes.value.splice(index, 1);
                                alert('삭제되었습니다.');
                            } catch (err) {
                                alert('삭제 실패');
                            }
                        }
                    }
                };

                const saveAll = async () => {
                    try {
                        // 1. Save Group Info
                        await axios.put('/api/admin/code/groups', group.value);

                        // 2. Save Codes
                        for (const code of codes.value) {
                            if (code.isNew) {
                                await axios.post('/api/admin/code/sub', code);
                            } else {
                                await axios.put('/api/admin/code/sub', code);
                            }
                        }
                        alert('저장되었습니다.');
                        location.href = '/admin/code/selectPageListGroupCodeMgt.do';
                    } catch (err) {
                        alert('저장 중 오류 발생: ' + (err.response?.data || ''));
                    }
                };

                const goBack = () => location.href = '/admin/code/selectPageListGroupCodeMgt.do';

                onMounted(() => {
                    AdminMenu.init();
                    if (groupId) {
                        fetchGroupDetail();
                        fetchCodes();
                    }
                });

                return { group, codes, addRow, removeRow, saveAll, goBack };
            }
        });
        AdminLayout.register(app);
        app.mount('#app');
    </script>
</body>
</html>
