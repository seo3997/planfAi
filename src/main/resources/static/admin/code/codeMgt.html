<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>코드 상세 관리 - PlanfAi 관리자</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="/admin/js/admin_common.js"></script>
    <link href="/admin/css/admin_style.css" rel="stylesheet">
    <style>
        .form-table { width: 100%; border-collapse: collapse; background: #fff; margin-bottom: 20px; }
        .form-table th { background: #f9f9f9; padding: 12px; border: 1px solid #ddd; width: 180px; text-align: center; font-weight: 500; }
        .form-table td { padding: 8px 12px; border: 1px solid #ddd; }
        .inline-input { width: 100%; border: 1px solid #ddd; padding: 4px 8px; font-size: 13px; }
        .inline-select { width: 100%; border: 1px solid #ddd; padding: 4px 8px; font-size: 13px; }
        #sclasModal .modal-dialog, #sdclasModal .modal-dialog { 
            max-width: 95% !important;
            width: 95% !important;
            margin-left: auto !important;
            margin-right: auto !important;
        }
        #sclasModal .modal-content, #sdclasModal .modal-content {
            max-width: none !important;
            width: 100% !important;
        }
        @media (min-width: 1200px) {
            #sclasModal .modal-dialog, #sdclasModal .modal-dialog {
                max-width: 1600px !important;
            }
        }
        .data-table input.inline-input { height: 32px; }
    </style>
</head>
<body>
    <div id="app">
        <admin-header></admin-header>

        <div class="main-container">
            <admin-sidebar></admin-sidebar>

            <main class="content">
                <div class="page-title-box">
                    <h2 class="page-title">코드관리</h2>
                    <div class="breadcrumb-area">
                        <i class="bi bi-house-door"></i> > 시스템 > <span class="text-dark fw-medium">코드관리</span>
                    </div>
                </div>

                <!-- Group Code Info -->
                <div class="card shadow-sm border-0 p-3 mb-4" style="background-color: #f4f7f6;">
                    <table class="form-table">
                        <tr>
                            <th>그룹코드</th>
                            <td><input type="text" v-model="group.groupId" class="form-control" readonly style="background-color: #eee;"></td>
                        </tr>
                        <tr>
                            <th>그룹코드명</th>
                            <td><input type="text" v-model="group.groupNm" class="form-control"></td>
                        </tr>
                        <tr>
                            <th>영문그룹코드명</th>
                            <td><input type="text" v-model="group.groupNmEng" class="form-control"></td>
                        </tr>
                        <tr>
                            <th>비고</th>
                            <td><input type="text" v-model="group.rm" class="form-control"></td>
                        </tr>
                    </table>
                </div>

                <!-- Sub Codes Table (Middle Classification) -->
                <div class="card shadow-sm border-0 p-3" style="background-color: #f4f7f6;">
                    <div class="data-table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 120px;">코드</th>
                                    <th style="width: 18%;">코드명</th>
                                    <th style="width: 12%;">영문코드명</th>
                                    <th>속성1</th>
                                    <th>속성2</th>
                                    <th>속성3</th>
                                    <th style="width: 100px;">순서</th>
                                    <th style="width: 90px;">사용여부</th>
                                    <th style="width: 100px;">하위코드</th>
                                    <th style="width: 80px;">삭제</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="(code, index) in codes" :key="index">
                                    <td><input type="text" v-model="code.code" class="inline-input" :readonly="!code.isNew"></td>
                                    <td><input type="text" v-model="code.codeNm" class="inline-input"></td>
                                    <td><input type="text" v-model="code.codeNmEng" class="inline-input"></td>
                                    <td><input type="text" v-model="code.attrb1" class="inline-input"></td>
                                    <td><input type="text" v-model="code.attrb2" class="inline-input"></td>
                                    <td><input type="text" v-model="code.attrb3" class="inline-input"></td>
                                    <td><input type="number" v-model="code.sortOrdr" class="inline-input text-center"></td>
                                    <td>
                                        <select v-model="code.useYn" class="inline-select">
                                            <option value="Y">예</option>
                                            <option value="N">아니오</option>
                                        </select>
                                    </td>
                                    <td class="text-center">
                                        <button v-if="!code.isNew" class="btn btn-sm btn-primary px-3 py-1" style="font-size: 12px;" @click="openSclasModal(code)">관리</button>
                                    </td>
                                    <td class="text-center">
                                        <button class="btn btn-sm btn-table-del py-0" @click="removeRow(index, code)"><i class="bi bi-dash-circle"></i></button>
                                    </td>
                                </tr>
                                <tr v-if="codes.length === 0">
                                    <td colspan="10" class="text-center py-4 text-muted">등록된 코드가 없습니다.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="d-flex justify-content-center gap-2 mt-4">
                        <button class="btn btn-list px-4" @click="goBack"><i class="bi bi-reply-fill"></i> 목록</button>
                        <button class="btn btn-save px-4" @click="saveAll"><i class="bi bi-check-lg"></i> 수정</button>
                        <button class="btn btn-write px-4" @click="addRow"><i class="bi bi-plus-lg"></i> 신규등록</button>
                    </div>
                </div>

                <!-- Sclas Management Modal -->
                <div class="modal fade" id="sclasModal" tabindex="-1">
                    <div class="modal-dialog modal-wide">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">소분류 코드 관리 [{{ selectedCode.codeNm }}]</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="data-table-wrapper">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th style="width: 120px;">소분류코드</th>
                                                <th style="width: 18%;">소분류명</th>
                                                <th>속성1</th>
                                                <th>속성2</th>
                                                <th>속성3</th>
                                                <th>속성4</th>
                                                <th style="width: 100px;">순서</th>
                                                <th style="width: 90px;">사용여부</th>
                                                <th style="width: 100px;">하위코드</th>
                                                <th style="width: 80px;">액션</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="(sc, sidx) in sclasCodes" :key="sidx">
                                                <td><input type="text" v-model="sc.sclasCode" class="inline-input" :readonly="!sc.isNew"></td>
                                                <td><input type="text" v-model="sc.sclasNm" class="inline-input"></td>
                                                <td><input type="text" v-model="sc.attrb1" class="inline-input"></td>
                                                <td><input type="text" v-model="sc.attrb2" class="inline-input"></td>
                                                <td><input type="text" v-model="sc.attrb3" class="inline-input"></td>
                                                <td><input type="text" v-model="sc.attrb4" class="inline-input"></td>
                                                <td><input type="number" v-model="sc.sortOrdr" class="inline-input text-center"></td>
                                                <td>
                                                    <select v-model="sc.useYn" class="inline-select">
                                                        <option value="Y">예</option>
                                                        <option value="N">아니오</option>
                                                    </select>
                                                </td>
                                                <td class="text-center">
                                                    <button v-if="!sc.isNew" class="btn btn-sm btn-primary px-3 py-1" style="font-size: 12px;" @click="openSdclasModal(sc)">관리</button>
                                                </td>
                                                <td class="text-center">
                                                    <button class="btn btn-sm btn-danger py-0 px-2" @click="deleteSclas(sc, sidx)"><i class="bi bi-trash"></i></button>
                                                </td>
                                            </tr>
                                            <tr v-if="sclasCodes.length === 0">
                                                <td colspan="10" class="text-center py-4 text-muted">등록된 소분류 코드가 없습니다.</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="text-center mt-3 gap-2 d-flex justify-content-center">
                                    <button class="btn btn-sm btn-primary px-4" @click="saveSclas"><i class="bi bi-check-lg"></i> 소분류 저장</button>
                                    <button class="btn btn-sm btn-success px-4" @click="addSclasRow"><i class="bi bi-plus-lg"></i> 소분류 추가</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sdclas Management Modal -->
                <div class="modal fade" id="sdclasModal" tabindex="-1">
                    <div class="modal-dialog modal-wide">
                        <div class="modal-content">
                            <div class="modal-header bg-light">
                                <h5 class="modal-title">세분류 코드 관리 [{{ selectedSclas.sclasNm }}]</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="data-table-wrapper">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th style="width: 120px;">세분류코드</th>
                                                <th style="width: 25%;">세분류명</th>
                                                <th>속성1</th>
                                                <th>속성2</th>
                                                <th>속성3</th>
                                                <th style="width: 80px;">순서</th>
                                                <th style="width: 100px;">사용여부</th>
                                                <th style="width: 100px;">액션</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="(sd, sdidx) in sdclasCodes" :key="sdidx">
                                                <td><input type="text" v-model="sd.sdclasCode" class="inline-input" :readonly="!sd.isNew"></td>
                                                <td><input type="text" v-model="sd.sdclasNm" class="inline-input"></td>
                                                <td><input type="text" v-model="sd.attrb1" class="inline-input"></td>
                                                <td><input type="text" v-model="sd.attrb2" class="inline-input"></td>
                                                <td><input type="text" v-model="sd.attrb3" class="inline-input"></td>
                                                <td><input type="number" v-model="sd.sortOrdr" class="inline-input text-center"></td>
                                                <td>
                                                    <select v-model="sd.useYn" class="inline-select">
                                                        <option value="Y">예</option>
                                                        <option value="N">아니오</option>
                                                    </select>
                                                </td>
                                                <td class="text-center">
                                                    <button class="btn btn-sm btn-danger py-0 px-2" @click="deleteSdclas(sd, sdidx)"><i class="bi bi-trash"></i></button>
                                                </td>
                                            </tr>
                                            <tr v-if="sdclasCodes.length === 0">
                                                <td colspan="8" class="text-center py-4 text-muted">등록된 세분류 코드가 없습니다.</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="text-center mt-3 gap-2 d-flex justify-content-center">
                                    <button class="btn btn-sm btn-primary px-4" @click="saveSdclas"><i class="bi bi-check-lg"></i> 세분류 저장</button>
                                    <button class="btn btn-sm btn-success px-4" @click="addSdclasRow"><i class="bi bi-plus-lg"></i> 세분류 추가</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <admin-footer></admin-footer>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const { createApp, ref, onMounted } = Vue;
        const app = createApp({
            setup() {
                const groupId = new URLSearchParams(window.location.search).get('groupId');
                const group = ref({ groupId: '', groupNm: '', groupNmEng: '', rm: '' });
                const codes = ref([]);

                // Small classification
                const selectedCode = ref({});
                const sclasCodes = ref([]);
                let sclasModalObj = null;

                // Sub classification
                const selectedSclas = ref({});
                const sdclasCodes = ref([]);
                let sdclasModalObj = null;

                const fetchGroupDetail = () => {
                    axios.get(`/api/admin/code/groups/${groupId}`)
                        .then(res => group.value = res.data)
                        .catch(err => alert('그룹 조회 실패'));
                };

                const fetchCodes = () => {
                    axios.get(`/api/admin/code/sub/${groupId}`)
                        .then(res => {
                            codes.value = res.data.map(c => ({ ...c, isNew: false }));
                        })
                        .catch(err => alert('코드 조회 실패'));
                };

                const addRow = () => {
                    codes.value.push({
                        groupId: groupId,
                        code: '',
                        codeNm: '',
                        codeNmEng: '',
                        attrb1: '',
                        attrb2: '',
                        attrb3: '',
                        sortOrdr: codes.value.length + 1,
                        useYn: 'Y',
                        isNew: true
                    });
                };

                const removeRow = async (index, code) => {
                    if (code.isNew) {
                        codes.value.splice(index, 1);
                    } else {
                        if (confirm('정말 삭제하시겠습니까? 하위 분류 코드도 모두 삭제될 수 있습니다.')) {
                            try {
                                await axios.delete(`/api/admin/code/sub/${groupId}/${code.code}`);
                                codes.value.splice(index, 1);
                                alert('삭제되었습니다.');
                            } catch (err) {
                                alert('삭제 실패');
                            }
                        }
                    }
                };

                const saveAll = async () => {
                    try {
                        await axios.put('/api/admin/code/groups', group.value);
                        for (const code of codes.value) {
                            if (code.isNew) {
                                if(!code.code) continue;
                                await axios.post('/api/admin/code/sub', code);
                            } else {
                                await axios.put('/api/admin/code/sub', code);
                            }
                        }
                        alert('저장되었습니다.');
                        fetchCodes();
                    } catch (err) {
                        alert('저장 중 오류 발생: ' + (err.response?.data || ''));
                    }
                };

                // Sclas Methods
                const openSclasModal = (code) => {
                    selectedCode.value = code;
                    fetchSclasCodes(code.code);
                    sclasModalObj.show();
                };

                const fetchSclasCodes = (code) => {
                    axios.get(`/api/admin/code/sclas/${groupId}/${code}`)
                        .then(res => sclasCodes.value = res.data.map(i => ({...i, isNew: false})));
                };

                const addSclasRow = () => {
                    sclasCodes.value.push({
                        groupId: groupId,
                        code: selectedCode.value.code,
                        sclasCode: '',
                        sclasNm: '',
                        attrb1: '',
                        attrb2: '',
                        attrb3: '',
                        attrb4: '',
                        sortOrdr: sclasCodes.value.length + 1,
                        useYn: 'Y',
                        isNew: true
                    });
                };

                const saveSclas = async () => {
                    try {
                        await axios.post('/api/admin/code/sclas/all', sclasCodes.value);
                        alert('저장되었습니다.');
                        fetchSclasCodes(selectedCode.value.code);
                    } catch (err) { alert('저장 실패'); }
                };

                const deleteSclas = async (sc, idx) => {
                    if(sc.isNew) return sclasCodes.value.splice(idx, 1);
                    if(confirm('삭제하시겠습니까?')) {
                        try {
                            await axios.delete(`/api/admin/code/sclas/${groupId}/${sc.code}/${sc.sclasCode}`);
                            alert('삭제되었습니다.');
                            fetchSclasCodes(selectedCode.value.code);
                        } catch (err) { alert('삭제 실패'); }
                    }
                };

                // Sdclas Methods
                const openSdclasModal = (sc) => {
                    selectedSclas.value = sc;
                    fetchSdclasCodes(sc.code, sc.sclasCode);
                    sdclasModalObj.show();
                };

                const fetchSdclasCodes = (code, sclasCode) => {
                    axios.get(`/api/admin/code/sdclas/${groupId}/${code}/${sclasCode}`)
                        .then(res => sdclasCodes.value = res.data.map(i => ({...i, isNew: false})));
                };

                const addSdclasRow = () => {
                    sdclasCodes.value.push({
                        groupId: groupId,
                        code: selectedSclas.value.code,
                        sclasCode: selectedSclas.value.sclasCode,
                        sdclasCode: '',
                        sdclasNm: '',
                        attrb1: '',
                        attrb2: '',
                        attrb3: '',
                        sortOrdr: sdclasCodes.value.length + 1,
                        useYn: 'Y',
                        isNew: true
                    });
                };

                const saveSdclas = async () => {
                    try {
                        await axios.post('/api/admin/code/sdclas/all', sdclasCodes.value);
                        alert('저장되었습니다.');
                        fetchSdclasCodes(selectedSclas.value.code, selectedSclas.value.sclasCode);
                    } catch (err) { alert('저장 실패'); }
                };

                const deleteSdclas = async (sd, idx) => {
                    if(sd.isNew) return sdclasCodes.value.splice(idx, 1);
                    if(confirm('삭제하시겠습니까?')) {
                        try {
                            await axios.delete(`/api/admin/code/sdclas/${groupId}/${sd.code}/${sd.sclasCode}/${sd.sdclasCode}`);
                            alert('삭제되었습니다.');
                            fetchSdclasCodes(selectedSclas.value.code, selectedSclas.value.sclasCode);
                        } catch (err) { alert('삭제 실패'); }
                    }
                };

                const goBack = () => location.href = '/admin/code/selectPageListGroupCodeMgt.do';

                onMounted(() => {
                    AdminMenu.init();
                    if (groupId) {
                        fetchGroupDetail();
                        fetchCodes();
                    }
                    sclasModalObj = new bootstrap.Modal(document.getElementById('sclasModal'));
                    sdclasModalObj = new bootstrap.Modal(document.getElementById('sdclasModal'));
                });

                return { 
                    group, codes, addRow, removeRow, saveAll, goBack,
                    selectedCode, sclasCodes, openSclasModal, addSclasRow, saveSclas, deleteSclas,
                    selectedSclas, sdclasCodes, openSdclasModal, addSdclasRow, saveSdclas, deleteSdclas
                };
            }
        });
        AdminLayout.register(app);
        app.mount('#app');
    </script>
</body>
</html>
