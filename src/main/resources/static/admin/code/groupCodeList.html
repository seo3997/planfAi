<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>코드 관리 - PlanfAi 관리자</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="/admin/js/admin_common.js"></script>
    <link href="/admin/css/admin_style.css" rel="stylesheet">
</head>
<body>
    <div id="app">
        <admin-header></admin-header>

        <div class="main-container">
            <admin-sidebar></admin-sidebar>

            <main class="content">
                <div class="page-title-box">
                    <h2 class="page-title">코드관리</h2>
                    <div class="breadcrumb-area">
                        <i class="bi bi-house-door"></i> > 시스템 > <span class="text-dark fw-bold">코드관리</span>
                    </div>
                </div>

                <!-- Search Area -->
                <div class="search-box-wrapper">
                    <input type="text" v-model="schGroupNm" @keyup.enter="fetchGroups" class="search-input" placeholder="그룹코드명">
                    <button class="btn-search-icon" @click="fetchGroups"><i class="bi bi-search"></i></button>
                </div>

                <div class="actions-area">
                    <button class="btn btn-search" @click="deleteSelected" style="background-color: #ed5f39;"><i class="bi bi-trash"></i> 삭제</button>
                    <button class="btn btn-search" @click="goRegister"><i class="bi bi-pencil-square"></i> 등록</button>
                </div>

                <div class="data-table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="width: 50px;"><input type="checkbox" v-model="allSelected" @change="selectAll"></th>
                                <th style="width: 60px;">No</th>
                                <th style="width: 15%;">그룹코드</th>
                                <th>그룹코드명</th>
                                <th>영문그룹코드명</th>
                                <th style="width: 120px;">등록자</th>
                                <th style="width: 120px;">등록일</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="(item, index) in groupList" :key="item.groupId">
                                <td><input type="checkbox" v-model="selectedIds" :value="item.groupId"></td>
                                <td>{{ totCnt - ((page - 1) * size) - index }}</td>
                                <td><a href="#" @click.prevent="goDetail(item.groupId)" class="text-primary text-decoration-none">{{ item.groupId }}</a></td>
                                <td class="text-start px-3">{{ item.groupNm }}</td>
                                <td class="text-start px-3">{{ item.groupNmEng }}</td>
                                <td>{{ item.registerNm }}</td>
                                <td>{{ item.registYmd }}</td>
                            </tr>
                            <tr v-if="groupList.length === 0">
                                <td colspan="7" class="text-center py-5 text-muted">결과가 없습니다.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="d-flex justify-content-center mt-4" v-if="totCnt > 0">
                    <nav>
                        <ul class="pagination pagination-sm">
                            <li class="page-item" :class="{ disabled: page === 1 }">
                                <a class="page-link" href="#" @click.prevent="changePage(page - 1)"><i class="bi bi-chevron-left"></i></a>
                            </li>
                            <li v-for="p in totalPages" :key="p" class="page-item" :class="{ active: p === page }">
                                <a class="page-link" href="#" @click.prevent="changePage(p)">{{ p }}</a>
                            </li>
                            <li class="page-item" :class="{ disabled: page === totalPages }">
                                <a class="page-link" href="#" @click.prevent="changePage(page + 1)"><i class="bi bi-chevron-right"></i></a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </main>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted, computed } = Vue;
        const app = createApp({
            setup() {
                const groupList = ref([]);
                const totCnt = ref(0);
                const page = ref(1);
                const size = 10;
                const schGroupNm = ref('');
                const selectedIds = ref([]);
                const allSelected = ref(false);

                const fetchGroups = () => {
                    axios.get('/api/admin/code/groups', {
                        params: { schGroupNm: schGroupNm.value, page: page.value, size: size }
                    }).then(res => {
                        groupList.value = res.data.list;
                        totCnt.value = res.data.totCnt;
                    }).catch(err => alert('조회 실패'));
                };

                const changePage = (p) => {
                    if (p < 1 || p > totalPages.value) return;
                    page.value = p;
                    fetchGroups();
                };

                const totalPages = computed(() => Math.ceil(totCnt.value / size));

                const selectAll = () => {
                    if (allSelected.value) {
                        selectedIds.value = groupList.value.map(i => i.groupId);
                    } else {
                        selectedIds.value = [];
                    }
                };

                const goRegister = () => location.href = '/admin/code/insertFormGroupCodeMgt.do';
                const goDetail = (id) => location.href = `/admin/code/selectListCodeMgt.do?groupId=${id}`;

                const deleteSelected = async () => {
                    if (selectedIds.value.length === 0) {
                        alert('삭제할 항목을 선택해주세요.');
                        return;
                    }
                    if (confirm('선택한 항목을 삭제하시겠습니까? 관련 세부 코드도 모두 삭제됩니다.')) {
                        try {
                            for (const id of selectedIds.value) {
                                await axios.delete(`/api/admin/code/groups/${id}`);
                            }
                            alert('삭제되었습니다.');
                            fetchGroups();
                        } catch (err) {
                            alert('삭제 중 오류 발생');
                        }
                    }
                };

                onMounted(() => {
                    AdminMenu.init();
                    fetchGroups();
                });

                return { groupList, totCnt, page, size, schGroupNm, selectedIds, allSelected, totalPages, fetchGroups, changePage, selectAll, goRegister, goDetail, deleteSelected };
            }
        });
        AdminLayout.register(app);
        app.mount('#app');
    </script>
</body>
</html>
