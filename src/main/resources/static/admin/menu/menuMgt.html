<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>메뉴 관리 - PlanfAi 관리자</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="/admin/js/admin_common.js"></script>
    <link href="/admin/css/admin_style.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuedraggable@4.1.0/dist/vuedraggable.umd.min.js"></script>
    <style>
        .menu-mgmt-container { display: flex; gap: 20px; align-items: flex-start; }
        
        /* Left: Tree Section */
        .tree-section {
            flex: 0 0 400px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            min-height: 800px;
        }
        .tree-header { margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; display: flex; gap: 5px; align-items: center;}
        .btn-tree-ctrl { font-size: 13px; padding: 4px 10px; background: #f5f5f5; border: 1px solid #ccc; border-radius: 3px; }
        .btn-save-order { font-size: 13px; padding: 4px 12px; background: #2b579a; color: #fff; border: none; border-radius: 3px; font-weight: bold; margin-left: auto;}
        
        .tree-list { list-style: none; padding-left: 0; margin: 0; min-height: 5px;}
        .tree-node { list-style: none; padding-left: 20px; margin-top: 5px; position: relative; }
        .tree-label-row { display: flex; align-items: center; cursor: pointer; padding: 4px 8px; border-radius: 3px; transition: background 0.2s; }
        .tree-label-row:hover { background: #f0f7ff; }
        .tree-label-row.selected { background: #d7ebff; font-weight: bold; color: #2b579a; }
        .tree-toggle { color: #888; margin-right: 5px; cursor: pointer; display: inline-block; width: 14px; text-align: center; }
        .tree-label { font-size: 14px; color: #333; flex: 1; pointer-events: auto;}
        .selected .tree-label { color: #2b579a; }

        .ghost { opacity: 0.5; background: #c8ebfb; }
        .drag-handle { cursor: grab; margin-right: 8px; color: #ccc; }

        /* Right: Form Section */
        .form-section { flex: 1; display: flex; flex-direction: column; gap: 20px; }
        .mgmt-card { background: #fff; border: 1px solid #ddd; border-top: 2px solid #3b5998; border-radius: 4px; padding: 25px; }
        .form-table { width: 100%; border-collapse: collapse; margin-bottom: 0; }
        .form-table th { background: #f9f9f9; padding: 12px 15px; border: 1px solid #ddd; font-size: 13px; color: #333; font-weight: bold; text-align: left; width: 150px; }
        .form-table td { padding: 8px 15px; border: 1px solid #ddd; vertical-align: middle; }
        .form-control, .form-select { border: 1px solid #ccc; font-size: 13px; padding: 6px 10px; border-radius: 3px; }
        .form-control:read-only { background-color: #f1f1f1 !important; color: #666; cursor: default; }
        .required::after { content: " *"; color: #ed5f39; }

        .btn-action-group { display: flex; justify-content: center; gap: 10px; margin-top: 20px; }
        .btn-update { background-color: #36c3bc; color: white; border: none; padding: 8px 18px; border-radius: 4px; font-weight: bold; }
        .btn-delete-major { background-color: #ed5f39; color: white; border: none; padding: 8px 18px; border-radius: 4px; font-weight: bold; }
        .btn-new-major { background-color: #2b579a; color: white; border: none; padding: 8px 18px; border-radius: 4px; font-weight: bold; }
        .btn-register { background-color: #2b579a; color: white; border: none; padding: 10px 30px; border-radius: 4px; font-weight: bold; font-size: 15px; }
        
        .btn-dup-check {
            border: 1px solid #ccc;
            background: #fff;
            padding: 5px 15px;
            font-size: 13px;
            color: #333;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-dup-check:hover { background: #f0f0f0; border-color: #bbb; }
        .is-checked { border-color: #36c3bc; color: #36c3bc; background: #eafffe; }
    </style>
</head>
<body>
    <div id="app">
        <admin-header></admin-header>

        <div class="main-container">
            <admin-sidebar></admin-sidebar>

            <main class="content">
                <div class="page-title-box">
                    <h2 class="page-title">메뉴관리</h2>
                    <div class="breadcrumb-area">
                        <i class="bi bi-house-door"></i> > 시스템 > <span class="text-dark fw-bold">메뉴관리</span>
                    </div>
                </div>

                <div class="menu-mgmt-container">
                    <!-- Left: Menu Tree -->
                    <div class="tree-section">
                        <div class="tree-header">
                            <button class="btn-tree-ctrl" @click="toggleAll(false)"><i class="bi bi-folder me-1"></i>접기</button>
                            <button class="btn-tree-ctrl" @click="toggleAll(true)"><i class="bi bi-folder2-open me-1"></i>펼치기</button>
                        </div>
                        <ul class="tree-list">
                            <tree-item 
                                v-for="node in menuTree" 
                                :key="node.menuId" 
                                :node="node" 
                                :selected-id="selectedId" 
                                :expanded-ids="expandedIds"
                                @select="selectMenu"
                                @toggle="toggleNode"
                                @reorder="saveAllOrders">
                            </tree-item>
                        </ul>
                    </div>

                    <!-- Right: Management Forms -->
                    <div class="form-section">
                        <!-- Top: Edit Form -->
                        <div v-if="selectedId" class="mgmt-card">
                            <table class="form-table">
                                <tr>
                                    <th class="required">상위메뉴 ID</th>
                                    <td><input type="text" v-model="editForm.parentMenuId" class="form-control" readonly></td>
                                    <th class="required">상위메뉴명</th>
                                    <td><input type="text" v-model="editForm.parentMenuNm" class="form-control" readonly></td>
                                </tr>
                                <tr>
                                    <th class="required">메뉴 ID</th>
                                    <td><input type="text" v-model="editForm.menuId" class="form-control" readonly></td>
                                    <th class="required">메뉴레벨</th>
                                    <td><input type="text" v-model="editForm.menuLevel" class="form-control" readonly></td>
                                </tr>
                                <tr>
                                    <th class="required">메뉴명</th>
                                    <td colspan="3"><input type="text" v-model="editForm.menuNm" class="form-control"></td>
                                </tr>
                                <tr>
                                    <th class="required">메뉴유형</th>
                                    <td>
                                        <select v-model="editForm.menuTyCode" class="form-select">
                                            <option value="10">카테고리</option>
                                            <option value="20">메뉴</option>
                                            <option value="30">기능</option>
                                        </select>
                                    </td>
                                    <th class="required">정렬순서</th>
                                    <td><input type="number" v-model="editForm.sortOrdr" class="form-control"></td>
                                </tr>
                                <tr>
                                    <th>전시여부</th>
                                    <td colspan="3">
                                        <select v-model="editForm.useYn" class="form-select">
                                            <option value="Y">예</option>
                                            <option value="N">아니오</option>
                                        </select>
                                    </td>
                                </tr>
                                <tr>
                                    <th>URL</th>
                                    <td colspan="3"><input type="text" v-model="editForm.url" class="form-control"></td>
                                </tr>
                            </table>
                            <div class="btn-action-group">
                                <button class="btn-update" @click="saveEdit"><i class="bi bi-pencil-square me-1"></i>수정</button>
                                <button class="btn-delete-major" @click="deleteMenu(selectedId)"><i class="bi bi-trash me-1"></i>삭제</button>
                                <button class="btn-new-major" @click="showNewForm"><i class="bi bi-plus-lg me-1"></i>신규등록</button>
                            </div>
                        </div>
                        <div v-else class="mgmt-card text-center py-5 text-muted">
                            좌측 트리에서 메뉴를 선택해주세요.
                        </div>

                        <!-- Bottom: New Registration Form -->
                        <div v-if="isNewFormVisible" class="mgmt-card">
                            <div class="cardTitle mb-3" style="font-size: 16px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                                <i class="bi bi-plus-square-fill color-blue me-2"></i>신규 메뉴 추가
                            </div>
                            <table class="form-table">
                                <tr>
                                    <th class="required">상위메뉴 ID</th>
                                    <td colspan="3">
                                        <div class="d-flex gap-2 align-items-center">
                                            <input type="text" v-model="newForm.parentMenuId" class="form-control" readonly style="width: 250px;">
                                            <input type="text" v-model="newForm.subMenuId" class="form-control" placeholder="메뉴ID 4자리" maxlength="4" style="width: 150px;" @input="isIdChecked = false">
                                            <button class="btn-dup-check" :class="{ 'is-checked': isIdChecked }" @click="checkIdDuplicate">
                                                {{ isIdChecked ? '확인완료' : '중복확인' }}
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <th class="required">메뉴명</th>
                                    <td colspan="3"><input type="text" v-model="newForm.menuNm" class="form-control"></td>
                                </tr>
                                <tr>
                                    <th class="required">메뉴유형</th>
                                    <td>
                                        <select v-model="newForm.menuTyCode" class="form-select">
                                            <option value="10">카테고리</option>
                                            <option value="20">메뉴</option>
                                            <option value="30">기능</option>
                                        </select>
                                    </td>
                                    <th class="required">정렬순서</th>
                                    <td><input type="number" v-model="newForm.sortOrdr" class="form-control"></td>
                                </tr>
                                <tr>
                                    <th>전시여부</th>
                                    <td colspan="3">
                                        <select v-model="newForm.useYn" class="form-select">
                                            <option value="Y">예</option>
                                            <option value="N">아니오</option>
                                        </select>
                                    </td>
                                </tr>
                                <tr>
                                    <th>URL</th>
                                    <td colspan="3"><input type="text" v-model="newForm.url" class="form-control"></td>
                                </tr>
                            </table>
                            <div class="d-flex justify-content-end mt-2">
                                <button class="btn-delete-major" style="padding: 5px 15px; font-size: 13px;" @click="isNewFormVisible = false">삭제</button>
                            </div>
                            <div class="text-center mt-4">
                                <button class="btn-register" @click="registerMenu">등록</button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Recursive Tree Component -->
    <script>
        const TreeItem = {
            name: 'TreeItem',
            props: ['node', 'selectedId', 'expandedIds'],
            emits: ['select', 'toggle', 'reorder'],
            components: {
                draggable: window.vuedraggable
            },
            template: `
                <li class="tree-node">
                    <div class="tree-label-row" 
                         :class="{ selected: selectedId === node.menuId }" 
                         @click="$emit('select', node)">
                        <span class="tree-toggle" @click.stop="$emit('toggle', node)">
                            <template v-if="node.children && node.children.length > 0">
                                <i :class="expandedIds.has(node.menuId) ? 'bi bi-dash-square' : 'bi bi-plus-square'"></i>
                            </template>
                        </span>
                        <span class="tree-label">{{ node.menuNm }}</span>
                    </div>
                    
                    <draggable 
                        v-if="node.children && node.children.length > 0 && expandedIds.has(node.menuId)"
                        v-model="node.children"
                        tag="ul"
                        class="tree-list"
                        item-key="menuId"
                        ghost-class="ghost"
                        handle=".tree-label"
                        @end="$emit('reorder')"
                    >
                        <template #item="{element}">
                           <tree-item 
                                :node="element" 
                                :selected-id="selectedId" 
                                :expanded-ids="expandedIds"
                                @select="$emit('select', $event)"
                                @toggle="$emit('toggle', $event)"
                                @reorder="$emit('reorder')">
                            </tree-item>
                        </template>
                    </draggable>
                </li>
            `
        };
    </script>

    <script>
        const { createApp, ref, reactive, onMounted, computed, watch } = Vue;

        const app = createApp({
            components: { 
                TreeItem,
                draggable: window.vuedraggable
            },
            setup() {
                const flatMenus = ref([]);
                const menuTree = ref([]);
                const selectedId = ref('');
                const expandedIds = ref(new Set());
                const isNewFormVisible = ref(false);
                const editForm = reactive({
                    parentMenuId: '', parentMenuNm: '', menuId: '', menuLevel: '',
                    menuNm: '', menuTyCode: '20', sortOrdr: 1, useYn: 'Y', url: ''
                });

                const newForm = reactive({
                    parentMenuId: '', subMenuId: '',
                    menuNm: '', menuTyCode: '20', sortOrdr: 1, useYn: 'Y', url: ''
                });

                const isIdChecked = ref(false);

                // Helper to build tree from flat list
                const buildTree = (data) => {
                    const list = JSON.parse(JSON.stringify(data));
                    const map = {};
                    const roots = [];

                    list.forEach(m => {
                        m.children = [];
                        map[m.menuId] = m;
                    });

                    list.forEach(m => {
                        const pid = m.menuId.length > 4 ? m.menuId.substring(0, m.menuId.length - 4) : '';
                        if (pid && map[pid]) {
                            map[pid].children.push(m);
                        } else {
                            roots.push(m);
                        }
                    });
                    return roots;
                };

                const fetchMenus = () => {
                    axios.get('/api/admin/menu')
                        .then(res => {
                            flatMenus.value = res.data;
                            menuTree.value = buildTree(res.data);
                            toggleAll(true);
                        })
                        .catch(err => alert('메뉴 조회 실패'));
                };

                const selectMenu = (node) => {
                    selectedId.value = node.menuId;
                    isNewFormVisible.value = false;
                    
                    const pid = node.menuId.length > 4 ? node.menuId.substring(0, node.menuId.length - 4) : '';
                    const parent = flatMenus.value.find(m => m.menuId === pid);
                    
                    editForm.parentMenuId = pid || 'NONE';
                    editForm.parentMenuNm = parent ? parent.menuNm : '최상위';
                    editForm.menuId = node.menuId;
                    editForm.menuLevel = node.menuLevel;
                    editForm.menuNm = node.menuNm;
                    editForm.menuTyCode = node.menuTyCode;
                    editForm.sortOrdr = node.sortOrdr;
                    editForm.useYn = node.useYn;
                    editForm.url = node.url;
                };

                const toggleNode = (node) => {
                    if (expandedIds.value.has(node.menuId)) {
                        expandedIds.value.delete(node.menuId);
                    } else {
                        expandedIds.value.add(node.menuId);
                    }
                };

                const toggleAll = (expand) => {
                    if (expand) {
                        flatMenus.value.forEach(m => expandedIds.value.add(m.menuId));
                    } else {
                        expandedIds.value.clear();
                    }
                };

                const showNewForm = () => {
                    isNewFormVisible.value = true;
                    isIdChecked.value = false;
                    newForm.parentMenuId = selectedId.value;
                    newForm.subMenuId = '';
                    newForm.menuNm = '';
                    newForm.menuTyCode = '20';
                    newForm.sortOrdr = 1;
                    newForm.useYn = 'Y';
                    newForm.url = '';
                    
                    setTimeout(() => window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }), 50);
                };

                const checkIdDuplicate = () => {
                    if (!/^\d{4}$/.test(newForm.subMenuId)) {
                        return alert('메뉴 ID는 숫자 4자리여야 합니다.');
                    }
                    
                    const fullId = newForm.parentMenuId + newForm.subMenuId;
                    if (flatMenus.value.some(m => m.menuId === fullId)) {
                        isIdChecked.value = false;
                        alert('이미 존재하는 메뉴 ID입니다.');
                    } else {
                        isIdChecked.value = true;
                        alert('사용 가능한 ID입니다.');
                    }
                };

                const saveEdit = () => {
                    if (!editForm.menuNm.trim()) return alert('메뉴명을 입력해주세요.');
                    
                    axios.post('/api/admin/menu', {
                        menuId: editForm.menuId,
                        parentMenuId: editForm.parentMenuId === 'NONE' ? '' : editForm.parentMenuId,
                        subMenuId: editForm.menuId.substring(editForm.menuId.length - 4),
                        menuNm: editForm.menuNm,
                        menuTyCode: editForm.menuTyCode,
                        sortOrdr: editForm.sortOrdr,
                        useYn: editForm.useYn,
                        url: editForm.url
                    })
                    .then(() => {
                        alert('저장되었습니다.');
                        fetchMenus();
                    })
                    .catch(err => AdminUtil.handleApiError(err));
                };

                const registerMenu = () => {
                    if (!isIdChecked.value) return alert('먼저 중복확인을 해주세요.');
                    if (!newForm.menuNm.trim()) return alert('메뉴명을 입력해주세요.');
                    
                    axios.post('/api/admin/menu', {
                        parentMenuId: newForm.parentMenuId,
                        subMenuId: newForm.subMenuId,
                        menuNm: newForm.menuNm,
                        menuTyCode: newForm.menuTyCode,
                        sortOrdr: newForm.sortOrdr,
                        useYn: newForm.useYn,
                        url: newForm.url
                    })
                    .then(() => {
                        alert('신규 메뉴가 등록되었습니다.');
                        isNewFormVisible.value = false;
                        fetchMenus();
                    })
                    .catch(err => AdminUtil.handleApiError(err));
                };

                const deleteMenu = (id) => {
                    if (confirm('해당 메뉴와 하위 메뉴가 모두 삭제됩니다. 계속하시겠습니까?')) {
                        axios.delete(`/api/admin/menu/${id}`)
                            .then(() => {
                                alert('삭제되었습니다.');
                                selectedId.value = '';
                                fetchMenus();
                            })
                            .catch(err => AdminUtil.handleApiError(err));
                    }
                };

                // Logic to save all sorts
                const saveAllOrders = () => {
                    selectedId.value = '';
                    isNewFormVisible.value = false;
                    
                    const updateList = [];
                    const traverse = (nodes, parentSorts = [0,0,0,0,0,0]) => {
                        nodes.forEach((node, index) => {
                            const newSort = (index + 1) * 10;
                            node.sortOrdr = newSort;
                            
                            // Inherit parent sorts and set own level's sort
                            const currentSorts = [...parentSorts];
                            const lvl = node.menuLevel;
                            currentSorts[lvl - 1] = newSort;
                            
                            node.sortOrdr1 = currentSorts[0];
                            node.sortOrdr2 = currentSorts[1];
                            node.sortOrdr3 = currentSorts[2];
                            node.sortOrdr4 = currentSorts[3];
                            node.sortOrdr5 = currentSorts[4];
                            node.sortOrdr6 = currentSorts[5];
                            
                            updateList.push({
                                menuId: node.menuId,
                                menuLevel: node.menuLevel,
                                sortOrdr: node.sortOrdr,
                                sortOrdr1: node.sortOrdr1,
                                sortOrdr2: node.sortOrdr2,
                                sortOrdr3: node.sortOrdr3,
                                sortOrdr4: node.sortOrdr4,
                                sortOrdr5: node.sortOrdr5,
                                sortOrdr6: node.sortOrdr6
                            });
                            
                            if (node.children && node.children.length > 0) {
                                traverse(node.children, currentSorts);
                            }
                        });
                    };

                    traverse(menuTree.value);

                    axios.post('/api/admin/menu/order', updateList)
                        .then(() => {
                            // Clear all menu caches to reflect changes in Top/Left menus
                            sessionStorage.removeItem('topMenus');
                            Object.keys(sessionStorage).forEach(key => {
                                if (key.startsWith('leftMenus_')) {
                                    sessionStorage.removeItem(key);
                                }
                            });
                            fetchMenus();
                        })
                        .catch(err => AdminUtil.handleApiError(err));
                };

                onMounted(() => {
                    AdminMenu.init();
                    fetchMenus();
                });

                return { 
                    flatMenus, menuTree, selectedId, expandedIds, editForm, newForm, isNewFormVisible, isIdChecked,
                    selectMenu, toggleNode, toggleAll, showNewForm, checkIdDuplicate, saveEdit, registerMenu, deleteMenu, saveAllOrders
                };
            }
        });
        AdminLayout.register(app);
        app.mount('#app');
    </script>
</body>
</html>
